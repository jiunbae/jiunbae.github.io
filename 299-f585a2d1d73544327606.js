"use strict";(self.webpackChunkjiunbae_github_io=self.webpackChunkjiunbae_github_io||[]).push([[299],{299:function(t,e,n){n.r(e),n.d(e,{TerrainEngine:function(){return d}});var s=n(546),i=n(3851),r=n(512),o=n(7855);function a(t){return()=>{t=(t|=0)+1831565813|0;let e=Math.imul(t^t>>>15,1|t);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}let h=function(){function t(t){this.grad=[[1,1],[-1,1],[1,-1],[-1,-1],[1,0],[-1,0],[0,1],[0,-1]];const e=[];for(let n=0;n<256;n++)e[n]=n;for(let n=255;n>0;n--){const s=Math.floor(t()*(n+1));[e[n],e[s]]=[e[s],e[n]]}this.perm=[].concat(e,e)}var e=t.prototype;return e.dot=function(t,e,n){return t[0]*e+t[1]*n},e.noise=function(t,e){const n=.5*(Math.sqrt(3)-1),s=(3-Math.sqrt(3))/6,i=(t+e)*n,r=Math.floor(t+i),o=Math.floor(e+i),a=(r+o)*s,h=t-(r-a),c=e-(o-a);let l,d;h>c?(l=1,d=0):(l=0,d=1);const u=h-l+s,m=c-d+s,f=h-1+2*s,p=c-1+2*s,w=255&r,M=255&o,b=this.perm[w+this.perm[M]]%8,g=this.perm[w+l+this.perm[M+d]]%8,v=this.perm[w+1+this.perm[M+1]]%8;let x=0,S=0,R=0,E=.5-h*h-c*c;E>=0&&(E*=E,x=E*E*this.dot(this.grad[b],h,c));let y=.5-u*u-m*m;y>=0&&(y*=y,S=y*y*this.dot(this.grad[g],u,m));let C=.5-f*f-p*p;return C>=0&&(C*=C,R=C*C*this.dot(this.grad[v],f,p)),70*(x+S+R)},t}();const c=new i.Q1f;function l(t,e){if(t<.28)return c.setRGB(.05,.1,.35);if(t<.35){const e=(t-.28)/.07;return c.setRGB(.1+.15*e,.25+.15*e,.5+.1*e)}if(t<.38)return c.setRGB(.76,.7,.5);if(t<.55)return e>.5?c.setRGB(.1,.3,.08):c.setRGB(.25,.5,.15);if(t<.7){if(e>.4)return c.setRGB(.08,.25,.06);const n=(t-.55)/.15;return c.setRGB(.25+.2*n,.5-.25*n,.15-.05*n)}if(t<.85){const e=(t-.7)/.15;return c.setRGB(.4+.1*e,.38+.1*e,.35+.1*e)}const n=Math.min((t-.85)/.15,1);return c.setRGB(.7+.2*n,.72+.2*n,.78+.17*n)}let d=function(){function t(t){this.terrain=null,this.waterPlane=null,this.animId=0,this.disposed=!1,this.resizeObserver=null,this.noiseScale=2,this.octaveCount=5,this.erosionSteps=500,this.waterLevelValue=.35,this.handleContextLost=t=>{t.preventDefault(),cancelAnimationFrame(this.animId);const e=document.createElement("div");e.style.cssText="position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.8);color:#fff;font:14px/1.5 sans-serif;cursor:pointer;z-index:100",e.textContent="WebGL context lost â€” click to reload",e.addEventListener("click",()=>location.reload()),this.container.style.position="relative",this.container.appendChild(e)},this.handleContextRestored=()=>{location.reload()},this.animate=()=>{this.disposed||(this.animId=requestAnimationFrame(this.animate),this.controls.update(),this.renderer.render(this.scene,this.camera))},this.container=t,this.renderer=new r.JeP({antialias:!0,alpha:!1}),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.renderer.setSize(t.clientWidth,t.clientHeight),this.renderer.setClearColor(1710638),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=i.Wk7,t.appendChild(this.renderer.domElement),this.renderer.domElement.addEventListener("webglcontextlost",this.handleContextLost),this.renderer.domElement.addEventListener("webglcontextrestored",this.handleContextRestored),this.scene=new i.Z58,this.scene.fog=new i.cRK(1710638,.015),this.camera=new i.ubm(55,t.clientWidth/t.clientHeight,.1,200),this.camera.position.set(35,25,35),this.controls=new o.N(this.camera,this.renderer.domElement),this.controls.enableDamping=!0,this.controls.dampingFactor=.05,this.controls.autoRotate=!0,this.controls.autoRotateSpeed=.5,this.controls.maxPolarAngle=.48*Math.PI,this.controls.minDistance=15,this.controls.maxDistance=80,this.controls.target.set(0,0,0);const e=new i.$p8(4210784,.6);this.scene.add(e);const n=new i.ZyN(16774368,1.2);n.position.set(30,40,20),n.castShadow=!0,n.shadow.mapSize.width=1024,n.shadow.mapSize.height=1024,n.shadow.camera.near=1,n.shadow.camera.far=100,n.shadow.camera.left=-40,n.shadow.camera.right=40,n.shadow.camera.top=40,n.shadow.camera.bottom=-40,this.scene.add(n);const s=new i.dth(8900331,3550491,.3);this.scene.add(s),this.currentSeed=Math.floor(2147483647*Math.random()),this.buildTerrain(),this.resizeObserver=new ResizeObserver(()=>{this.disposed||this.handleResize()}),this.resizeObserver.observe(t),this.animate()}var e=t.prototype;return e.generate=function(t){this.currentSeed=null!=t?t:Math.floor(2147483647*Math.random()),this.buildTerrain()},e.setNoiseScale=function(t){this.noiseScale=Math.max(.5,Math.min(5,t)),this.buildTerrain()},e.setOctaves=function(t){this.octaveCount=Math.max(1,Math.min(8,Math.round(t))),this.buildTerrain()},e.setErosionSteps=function(t){this.erosionSteps=Math.max(0,Math.min(5e3,Math.round(t))),this.buildTerrain()},e.setWaterLevel=function(t){this.waterLevelValue=Math.max(0,Math.min(1,t)),this.updateWaterPlane(),this.updateTerrainColors()},e.dispose=function(){this.disposed=!0,cancelAnimationFrame(this.animId),this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.controls.dispose(),this.scene.traverse(t=>{t instanceof i.eaF&&(t.geometry.dispose(),Array.isArray(t.material)?t.material.forEach(t=>t.dispose()):t.material.dispose())}),this.renderer.domElement.removeEventListener("webglcontextlost",this.handleContextLost),this.renderer.domElement.removeEventListener("webglcontextrestored",this.handleContextRestored),this.renderer.dispose(),this.renderer.domElement.parentElement&&this.renderer.domElement.parentElement.removeChild(this.renderer.domElement)},e.buildTerrain=function(){this.rng=a(this.currentSeed),this.noise=new h(this.rng);const e=t.GRID_SIZE,n=this.generateHeightMap(e);this.erosionSteps>0&&this.erode(n,e,this.erosionSteps),this.buildGeometry(n,e),this.updateWaterPlane()},e.generateHeightMap=function(t){const e=new Float32Array((t+1)*(t+1)),n=this.noiseScale,s=this.octaveCount;for(let i=0;i<=t;i++)for(let r=0;r<=t;r++){const o=(r/t-.5)*n,a=(i/t-.5)*n;let h=0,c=1,l=1,d=0;for(let t=0;t<s;t++)h+=this.noise.noise(o*l,a*l)*c,d+=c,c*=.5,l*=2.1;h/=d,h=.5*(h+1);const u=2*(r/t-.5),m=2*(i/t-.5),f=Math.sqrt(u*u+m*m);h*=Math.max(0,1-f*f),e[i*(t+1)+r]=h}return e},e.erode=function(t,e,n){const s=e+1,i=this.rng;for(let r=0;r<n;r++){let n=i()*(e-2)+1,r=i()*(e-2)+1,o=0,a=0,h=0,c=1,l=0;const d=.05,u=4,m=.3,f=.3,p=.01,w=4,M=80;for(let b=0;b<M;b++){const M=Math.floor(n),b=Math.floor(r);if(M<1||M>=e-1||b<1||b>=e-1)break;const g=n-M,v=r-b,x=t[b*s+M],S=t[b*s+M+1],R=t[(b+1)*s+M],E=t[(b+1)*s+M+1];o=o*d-((S-x)*(1-v)+(E-R)*v)*(1-d),a=a*d-((R-x)*(1-g)+(E-S)*g)*(1-d);const y=Math.sqrt(o*o+a*a);y<1e-4?(o=2*i()-1,a=2*i()-1):(o/=y,a/=y);const C=n+o,P=r+a;if(C<1||C>=e-1||P<1||P>=e-1)break;const G=x*(1-g)*(1-v)+S*g*(1-v)+R*(1-g)*v+E*g*v,z=Math.floor(C),k=Math.floor(P),I=C-z,L=P-k,T=t[k*s+z]*(1-I)*(1-L)+t[k*s+z+1]*I*(1-L)+t[(k+1)*s+z]*(1-I)*L+t[(k+1)*s+z+1]*I*L-G,A=Math.max(-T,.01)*h*c*u;if(l>A||T>0){const e=T>0?Math.min(l,T):(l-A)*m;l-=e,t[b*s+M]+=e*(1-g)*(1-v),t[b*s+M+1]+=e*g*(1-v),t[(b+1)*s+M]+=e*(1-g)*v,t[(b+1)*s+M+1]+=e*g*v}else{const e=Math.min((A-l)*f,-T);t[b*s+M]-=e*(1-g)*(1-v),t[b*s+M+1]-=e*g*(1-v),t[(b+1)*s+M]-=e*(1-g)*v,t[(b+1)*s+M+1]-=e*g*v,l+=e}if(h=Math.sqrt(Math.max(0,h*h+T*w)),c*=1-p,n=C,r=P,c<.001)break}}},e.buildGeometry=function(t,e){this.terrain&&(this.scene.remove(this.terrain),this.terrain.geometry.dispose(),this.terrain.material.dispose());const n=new i.bdM(50,50,e,e);n.rotateX(-Math.PI/2);const s=n.attributes.position,r=e+1,o=new Float32Array(3*s.count),c=a(this.currentSeed+12345),d=new h(c);for(let i=0;i<s.count;i++){const n=i%r,a=Math.floor(i/r),h=t[a*r+n];s.setY(i,15*h);const c=3*(n/e-.5),u=3*(a/e-.5),m=l(h,.5*(d.noise(c,u)+1));o[3*i]=m.r,o[3*i+1]=m.g,o[3*i+2]=m.b}n.setAttribute("color",new i.THS(o,3)),n.computeVertexNormals();const u=new i._4j({vertexColors:!0,roughness:.85,metalness:.05,flatShading:!1});this.terrain=new i.eaF(n,u),this.terrain.castShadow=!0,this.terrain.receiveShadow=!0,this.scene.add(this.terrain)},e.updateTerrainColors=function(){if(!this.terrain)return;const e=this.terrain.geometry,n=e.attributes.position,s=e.attributes.color;if(!s)return;const i=t.GRID_SIZE,r=i+1,o=a(this.currentSeed+12345),c=new h(o);for(let t=0;t<n.count;t++){const e=3*(t%r/i-.5),o=3*(Math.floor(t/r)/i-.5),a=l(n.getY(t)/15,.5*(c.noise(e,o)+1));s.setXYZ(t,a.r,a.g,a.b)}s.needsUpdate=!0},e.updateWaterPlane=function(){const t=15*this.waterLevelValue;if(this.waterPlane)this.waterPlane.position.y=t;else{const e=new i.bdM(55,55);e.rotateX(-Math.PI/2);const n=new i._4j({color:1732277,transparent:!0,opacity:.55,roughness:.1,metalness:.3,side:i.$EB});this.waterPlane=new i.eaF(e,n),this.waterPlane.position.y=t,this.waterPlane.receiveShadow=!0,this.scene.add(this.waterPlane)}},e.handleResize=function(){const t=this.container.clientWidth,e=this.container.clientHeight;this.camera.aspect=t/e,this.camera.updateProjectionMatrix(),this.renderer.setSize(t,e)},(0,s.A)(t,[{key:"autoRotate",get:function(){return this.controls.autoRotate},set:function(t){this.controls.autoRotate=t}},{key:"seed",get:function(){return this.currentSeed}}])}();d.GRID_SIZE=256}}]);
//# sourceMappingURL=299-f585a2d1d73544327606.js.map