---
import { getCollection, render } from 'astro:content';
import Layout from '@/layouts/Layout.astro';
import { format } from 'date-fns';

export async function getStaticPaths() {
  const posts = await getCollection('posts', ({ data }) => data.published !== false);
  return posts.map((post) => {
    const permalink = post.data.permalink || '';
    const slug = permalink.startsWith('/') ? permalink.slice(1) : permalink;
    return {
      params: { slug },
      props: { post },
    };
  });
}

const { post } = Astro.props;
const { Content, headings } = await render(post);

const toc = headings.filter(h => h.depth <= 3);
const heroImage = post.data.heroImage && post.data.heroImage.trim() ? post.data.heroImage : undefined;
let postSlug = post.data.permalink || post.slug;
if (postSlug.startsWith('/')) postSlug = postSlug.slice(1);
const ogImage = heroImage || `/og/posts/${postSlug}.png`;
---

<Layout
  title={post.data.title}
  description={post.data.description}
  image={ogImage}
  ogType="article"
  publishedTime={post.data.date.toISOString()}
  tags={post.data.tags}
>
  <article class="article">
    {heroImage && (
      <div class="hero-image">
        <img src={heroImage} alt={post.data.heroImageAlt || post.data.title} />
      </div>
    )}

    <header class="article-header">
      <h1 class="article-title">{post.data.title}</h1>

      {post.data.tags.length > 0 && (
        <div class="article-tags">
          {post.data.tags.map(tag => (
            <a href={`/posts/?tag=${tag}`} class="tag">{tag}</a>
          ))}
        </div>
      )}

      <div class="article-meta">
        <time datetime={post.data.date.toISOString()}>
          {format(post.data.date, 'yyyy년 MM월 dd일')}
        </time>
      </div>

      {post.data.description && (
        <p class="article-description">{post.data.description}</p>
      )}
    </header>

    {toc.length > 2 && (
      <nav class="toc" aria-label="Table of Contents">
        <details>
          <summary>목차</summary>
          <ul class="toc-list">
            {toc.map(heading => (
              <li class={`toc-item depth-${heading.depth}`}>
                <a href={`#${heading.slug}`}>{heading.text}</a>
              </li>
            ))}
          </ul>
        </details>
      </nav>
    )}

    <div class="article-content prose">
      <Content />
    </div>

    <footer class="article-footer">
      <a href="/posts/" class="back-link">← 목록으로 돌아가기</a>
    </footer>

    <!-- Comments (utterances) -->
    <section class="comments" id="comments-section">
      <script is:inline>
        (function() {
          const theme = document.documentElement.dataset.theme === 'dark' ? 'github-dark' : 'github-light';
          const script = document.createElement('script');
          script.src = 'https://utteranc.es/client.js';
          script.setAttribute('repo', 'jiunbae/jiunbae.github.io');
          script.setAttribute('issue-term', 'pathname');
          script.setAttribute('theme', theme);
          script.setAttribute('crossorigin', 'anonymous');
          script.async = true;
          document.getElementById('comments-section').appendChild(script);
        })();
      </script>
    </section>
  </article>
</Layout>

<style lang="scss">
  .article {
    max-width: 780px;
    margin: 0 auto;
    padding: 0 1.5rem 2rem;
  }

  .hero-image {
    margin: 0 -1.5rem 2rem;

    img {
      width: 100%;
      height: auto;
      max-height: 400px;
      object-fit: cover;
    }
  }

  .article-header {
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--gray-5);
  }

  .article-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--gray-1);
    line-height: 1.3;
    margin: 0 0 1rem;
    word-break: keep-all;
  }

  .article-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
  }

  .tag {
    padding: 0.25rem 0.75rem;
    background: var(--article-background);
    border-radius: 0.25rem;
    font-size: 0.8125rem;
    color: var(--primary-c1);
    text-decoration: none;
    transition: all 0.2s;

    &:hover {
      background: var(--primary-c1);
      color: white;
    }
  }

  .article-meta {
    color: var(--gray-4);
    font-size: 0.9375rem;
    margin-bottom: 1rem;
  }

  .article-description {
    font-size: 1.0625rem;
    color: var(--gray-3);
    line-height: 1.7;
    margin: 0;
  }

  .toc {
    margin-bottom: 2rem;
    padding: 1rem 1.25rem;
    background: var(--article-background);
    border-radius: 0.5rem;
    border-left: 3px solid var(--primary-c1);

    summary {
      font-weight: 600;
      cursor: pointer;
      color: var(--gray-2);
      font-size: 0.9375rem;
    }
  }

  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0.75rem 0 0;
  }

  .toc-item {
    margin: 0.375rem 0;

    a {
      color: var(--gray-3);
      text-decoration: none;
      font-size: 0.9375rem;

      &:hover {
        color: var(--primary-c1);
      }
    }

    &.depth-2 {
      padding-left: 1rem;
    }

    &.depth-3 {
      padding-left: 2rem;
      font-size: 0.875rem;
    }
  }

  .article-content {
    font-size: 1.0625rem;
    line-height: 1.85;
    color: var(--gray-2);
    word-break: keep-all;

    :global(h2) {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 3rem 0 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--gray-5);
      color: var(--gray-1);
    }

    :global(h3) {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 2rem 0 0.75rem;
      color: var(--gray-1);
    }

    :global(h4) {
      font-size: 1.125rem;
      font-weight: 600;
      margin: 1.5rem 0 0.5rem;
      color: var(--gray-1);
    }

    :global(p) {
      margin: 1.25rem 0;
    }

    :global(ul), :global(ol) {
      margin: 1rem 0;
      padding-left: 1.5rem;
    }

    :global(li) {
      margin: 0.5rem 0;
    }

    :global(blockquote) {
      margin: 1.5rem 0;
      padding: 1rem 1.5rem;
      border-left: 4px solid var(--primary-c1);
      background: var(--article-background);
      color: var(--gray-3);
      border-radius: 0 0.5rem 0.5rem 0;

      :global(p) {
        margin: 0;
      }
    }

    :global(img) {
      max-width: 100%;
      height: auto;
      border-radius: 0.5rem;
      margin: 1.5rem auto;
      display: block;
    }

    :global(a) {
      color: var(--primary-c1);
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    :global(code:not(pre code)) {
      padding: 0.15rem 0.4rem;
      background: var(--code-inline-bg, rgba(0, 0, 0, 0.05));
      border-radius: 0.25rem;
      font-size: 0.875em;
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Mono', monospace;
      color: var(--code-inline-color, #d63384);
    }

    :global(.expressive-code) {
      margin: 1.5rem 0;
    }

    :global(pre) {
      margin: 1.5rem 0;
      border-radius: 0.5rem;
      overflow-x: auto;
    }

    :global(table) {
      width: 100%;
      border-collapse: collapse;
      margin: 1.5rem 0;
      font-size: 0.9375rem;

      :global(th), :global(td) {
        padding: 0.75rem;
        border: 1px solid var(--gray-5);
        text-align: left;
      }

      :global(th) {
        background: var(--article-background);
        font-weight: 600;
      }
    }

    :global(hr) {
      margin: 2rem 0;
      border: none;
      border-top: 1px solid var(--gray-5);
    }

    :global(strong) {
      font-weight: 600;
      color: var(--gray-1);
    }
  }

  .article-footer {
    margin-top: 3rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--gray-5);
  }

  .back-link {
    color: var(--primary-c1);
    font-weight: 500;
    text-decoration: none;

    &:hover {
      text-decoration: underline;
    }
  }

  .comments {
    margin-top: 3rem;
    padding-top: 2rem;
    border-top: 1px solid var(--gray-5);
  }

  @media (max-width: 768px) {
    .article-title {
      font-size: 1.5rem;
    }

    .article-content {
      font-size: 1rem;

      :global(h2) {
        font-size: 1.25rem;
      }

      :global(h3) {
        font-size: 1.125rem;
      }
    }

    .hero-image {
      margin: 0 -1.5rem 1.5rem;
    }
  }
</style>
