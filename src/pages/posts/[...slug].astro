---
import { getCollection, render } from 'astro:content';
import Layout from '@/layouts/Layout.astro';
import { format } from 'date-fns';

export async function getStaticPaths() {
  const posts = await getCollection('posts', ({ data }) => data.published !== false);
  return posts.map((post) => {
    // Remove leading slash from permalink if present
    const permalink = post.data.permalink || '';
    const slug = permalink.startsWith('/') ? permalink.slice(1) : permalink;
    return {
      params: { slug },
      props: { post },
    };
  });
}

const { post } = Astro.props;
const { Content, headings } = await render(post);

// Generate table of contents from headings
const toc = headings.filter(h => h.depth <= 3);
---

<Layout
  title={post.data.title}
  description={post.data.description}
  image={post.data.heroImage}
>
  <article class="article">
    <header class="article-header">
      <div class="article-meta">
        <time datetime={post.data.date.toISOString()}>
          {format(post.data.date, 'yyyy년 MM월 dd일')}
        </time>
        {post.data.tags.length > 0 && (
          <div class="article-tags">
            {post.data.tags.map(tag => (
              <a href={`/posts/?tag=${tag}`} class="tag">{tag}</a>
            ))}
          </div>
        )}
      </div>
      <h1 class="article-title">{post.data.title}</h1>
      {post.data.description && (
        <p class="article-description">{post.data.description}</p>
      )}
    </header>

    {toc.length > 0 && (
      <nav class="toc" aria-label="Table of Contents">
        <details open>
          <summary>목차</summary>
          <ul class="toc-list">
            {toc.map(heading => (
              <li class={`toc-item depth-${heading.depth}`}>
                <a href={`#${heading.slug}`}>{heading.text}</a>
              </li>
            ))}
          </ul>
        </details>
      </nav>
    )}

    <div class="article-content">
      <Content />
    </div>

    <footer class="article-footer">
      <a href="/posts/" class="back-link">← 목록으로 돌아가기</a>
    </footer>
  </article>
</Layout>

<style lang="scss">
  .article {
    max-width: 780px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
  }

  .article-header {
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--gray-5);
  }

  .article-meta {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
    color: var(--gray-4);
    font-size: 0.9375rem;
  }

  .article-tags {
    display: flex;
    gap: 0.5rem;
  }

  .tag {
    padding: 0.25rem 0.5rem;
    background: var(--article-background);
    border-radius: 0.25rem;
    font-size: 0.8125rem;
    color: var(--primary-c1);
    text-decoration: none;

    &:hover {
      background: var(--primary-c1);
      color: white;
    }
  }

  .article-title {
    font-size: 2rem;
    font-weight: 700;
    color: var(--gray-1);
    line-height: 1.3;
    margin: 0 0 1rem;
  }

  .article-description {
    font-size: 1.125rem;
    color: var(--gray-4);
    line-height: 1.6;
    margin: 0;
  }

  .toc {
    margin-bottom: 2rem;
    padding: 1rem;
    background: var(--article-background);
    border-radius: 0.5rem;

    summary {
      font-weight: 600;
      cursor: pointer;
      color: var(--gray-2);
    }
  }

  .toc-list {
    list-style: none;
    padding: 0;
    margin: 1rem 0 0;
  }

  .toc-item {
    margin: 0.5rem 0;

    a {
      color: var(--gray-3);
      text-decoration: none;

      &:hover {
        color: var(--primary-c1);
      }
    }

    &.depth-2 {
      padding-left: 1rem;
    }

    &.depth-3 {
      padding-left: 2rem;
      font-size: 0.9375rem;
    }
  }

  .article-content {
    line-height: 1.8;
    color: var(--gray-2);

    :global(h2) {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 2.5rem 0 1rem;
      color: var(--gray-1);
    }

    :global(h3) {
      font-size: 1.25rem;
      font-weight: 600;
      margin: 2rem 0 0.75rem;
      color: var(--gray-1);
    }

    :global(p) {
      margin: 1rem 0;
    }

    :global(ul), :global(ol) {
      margin: 1rem 0;
      padding-left: 1.5rem;
    }

    :global(li) {
      margin: 0.5rem 0;
    }

    :global(blockquote) {
      margin: 1.5rem 0;
      padding: 1rem 1.5rem;
      border-left: 4px solid var(--primary-c1);
      background: var(--article-background);
      color: var(--gray-3);

      :global(p) {
        margin: 0;
      }
    }

    :global(img) {
      max-width: 100%;
      height: auto;
      border-radius: 0.5rem;
      margin: 1.5rem 0;
    }

    :global(a) {
      color: var(--primary-c1);
    }

    :global(code:not(pre code)) {
      padding: 0.2rem 0.4rem;
      background: var(--article-background);
      border-radius: 0.25rem;
      font-size: 0.9em;
    }

    :global(pre) {
      margin: 1.5rem 0;
      border-radius: 0.5rem;
      overflow-x: auto;
    }

    :global(table) {
      width: 100%;
      border-collapse: collapse;
      margin: 1.5rem 0;

      :global(th), :global(td) {
        padding: 0.75rem;
        border: 1px solid var(--gray-5);
        text-align: left;
      }

      :global(th) {
        background: var(--article-background);
        font-weight: 600;
      }
    }
  }

  .article-footer {
    margin-top: 3rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--gray-5);
  }

  .back-link {
    color: var(--primary-c1);
    font-weight: 500;
  }

  @media (max-width: 768px) {
    .article-title {
      font-size: 1.5rem;
    }

    .article-content {
      :global(h2) {
        font-size: 1.25rem;
      }

      :global(h3) {
        font-size: 1.125rem;
      }
    }
  }
</style>
