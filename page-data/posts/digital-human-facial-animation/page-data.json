{"componentChunkName":"component---src-templates-post-tsx","path":"/posts/digital-human-facial-animation/","result":{"data":{"markdownRemark":{"html":"<h1 id=\"멀티모달-페이셜-애니메이션-시스템-개발기\">멀티모달 페이셜 애니메이션 시스템 개발기</h1>\n<p>NCSOFT Graphics AI Lab에서 디지털 휴먼의 얼굴 애니메이션 시스템을 개발했습니다. 오디오, 텍스트, 감정 정보를 입력받아 자연스러운 표정과 립싱크를 생성하는 시스템이었습니다. 이 글에서는 그 과정에서 겪은 기술적 도전과 해결 방법을 공유하고자 합니다.</p>\n<h2 id=\"왜-멀티모달인가\">왜 멀티모달인가</h2>\n<p>처음에는 오디오만으로 립싱크를 생성하는 모델을 만들었습니다. 기술적으로는 성공했지만, 결과물이 뭔가 어색했습니다.</p>\n<p>문제를 분석해보니, 말하는 내용과 표정이 맞지 않는 경우가 많았습니다. 슬픈 내용을 말하는데 표정은 무표정하다든지, 농담을 하는데 진지한 표정이라든지.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># 초기 Audio-only 모델 구조</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">AudioToFaceModel</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> audio_dim<span class=\"token operator\">=</span><span class=\"token number\">80</span><span class=\"token punctuation\">,</span> hidden_dim<span class=\"token operator\">=</span><span class=\"token number\">256</span><span class=\"token punctuation\">,</span> output_dim<span class=\"token operator\">=</span><span class=\"token number\">52</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>audio_encoder <span class=\"token operator\">=</span> AudioEncoder<span class=\"token punctuation\">(</span>audio_dim<span class=\"token punctuation\">,</span> hidden_dim<span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>face_decoder <span class=\"token operator\">=</span> FaceDecoder<span class=\"token punctuation\">(</span>hidden_dim<span class=\"token punctuation\">,</span> output_dim<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> mel_spectrogram<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        audio_features <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>audio_encoder<span class=\"token punctuation\">(</span>mel_spectrogram<span class=\"token punctuation\">)</span>\n        blendshapes <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>face_decoder<span class=\"token punctuation\">(</span>audio_features<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> blendshapes  <span class=\"token comment\"># 52개의 ARKit blendshape 가중치</span></code></pre></div>\n<p>이 구조의 한계는 명확했습니다. 오디오만으로는 \"무슨 말을 하는지\"의 맥락을 파악하기 어려웠습니다. 같은 억양이라도 상황에 따라 다른 표정이 자연스러울 수 있는데, 그 정보가 오디오에는 없었습니다.</p>\n<p>그래서 텍스트와 감정 정보를 함께 활용하기로 했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># 멀티모달 모델 구조</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">MultimodalFaceModel</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token comment\"># 세 가지 모달리티의 인코더</span>\n        self<span class=\"token punctuation\">.</span>audio_encoder <span class=\"token operator\">=</span> AudioEncoder<span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>audio_dim<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">.</span>hidden_dim<span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>text_encoder <span class=\"token operator\">=</span> TextEncoder<span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>vocab_size<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">.</span>hidden_dim<span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>emotion_encoder <span class=\"token operator\">=</span> EmotionEncoder<span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>num_emotions<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">.</span>hidden_dim<span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># 멀티모달 퓨전</span>\n        self<span class=\"token punctuation\">.</span>fusion <span class=\"token operator\">=</span> CrossModalFusion<span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>hidden_dim<span class=\"token punctuation\">,</span> num_heads<span class=\"token operator\">=</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># 얼굴 애니메이션 디코더</span>\n        self<span class=\"token punctuation\">.</span>face_decoder <span class=\"token operator\">=</span> TemporalFaceDecoder<span class=\"token punctuation\">(</span>config<span class=\"token punctuation\">.</span>hidden_dim<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">.</span>output_dim<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> audio<span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">,</span> emotion<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># 각 모달리티 인코딩</span>\n        audio_feat <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>audio_encoder<span class=\"token punctuation\">(</span>audio<span class=\"token punctuation\">)</span>      <span class=\"token comment\"># [B, T, H]</span>\n        text_feat <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>text_encoder<span class=\"token punctuation\">(</span>text<span class=\"token punctuation\">)</span>          <span class=\"token comment\"># [B, S, H]</span>\n        emotion_feat <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>emotion_encoder<span class=\"token punctuation\">(</span>emotion<span class=\"token punctuation\">)</span> <span class=\"token comment\"># [B, H]</span>\n\n        <span class=\"token comment\"># Cross-attention 기반 퓨전</span>\n        fused_feat <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>fusion<span class=\"token punctuation\">(</span>audio_feat<span class=\"token punctuation\">,</span> text_feat<span class=\"token punctuation\">,</span> emotion_feat<span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># 시간축을 고려한 얼굴 애니메이션 생성</span>\n        blendshapes <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>face_decoder<span class=\"token punctuation\">(</span>fused_feat<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> blendshapes  <span class=\"token comment\"># [B, T, 52]</span></code></pre></div>\n<h2 id=\"100ms의-벽-실시간-성능-달성\">100ms의 벽: 실시간 성능 달성</h2>\n<p>게임에서 사용하려면 실시간 처리가 필수였습니다. 목표는 100ms 이하의 지연시간이었습니다.</p>\n<p>첫 버전의 성능 측정 결과:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">처리 시간 분석 (1초 음성 기준):\n- Audio 전처리: 45ms\n- Audio Encoder: 85ms\n- Text Encoder: 35ms\n- Emotion Encoder: 5ms\n- Fusion: 60ms\n- Face Decoder: 50ms\n총: 280ms</code></pre></div>\n<p>280ms는 너무 느렸습니다. 여러 최적화를 적용했습니다.</p>\n<h3 id=\"1-모델-경량화\">1. 모델 경량화</h3>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># Knowledge Distillation</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">DistillationLoss</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> temperature<span class=\"token operator\">=</span><span class=\"token number\">4.0</span><span class=\"token punctuation\">,</span> alpha<span class=\"token operator\">=</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>temperature <span class=\"token operator\">=</span> temperature\n        self<span class=\"token punctuation\">.</span>alpha <span class=\"token operator\">=</span> alpha\n        self<span class=\"token punctuation\">.</span>kl_div <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>KLDivLoss<span class=\"token punctuation\">(</span>reduction<span class=\"token operator\">=</span><span class=\"token string\">'batchmean'</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> student_output<span class=\"token punctuation\">,</span> teacher_output<span class=\"token punctuation\">,</span> target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># Teacher의 soft label과 실제 target을 모두 활용</span>\n        soft_loss <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>kl_div<span class=\"token punctuation\">(</span>\n            F<span class=\"token punctuation\">.</span>log_softmax<span class=\"token punctuation\">(</span>student_output <span class=\"token operator\">/</span> self<span class=\"token punctuation\">.</span>temperature<span class=\"token punctuation\">,</span> dim<span class=\"token operator\">=</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            F<span class=\"token punctuation\">.</span>softmax<span class=\"token punctuation\">(</span>teacher_output <span class=\"token operator\">/</span> self<span class=\"token punctuation\">.</span>temperature<span class=\"token punctuation\">,</span> dim<span class=\"token operator\">=</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>temperature <span class=\"token operator\">**</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n\n        hard_loss <span class=\"token operator\">=</span> F<span class=\"token punctuation\">.</span>mse_loss<span class=\"token punctuation\">(</span>student_output<span class=\"token punctuation\">,</span> target<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>alpha <span class=\"token operator\">*</span> soft_loss <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">-</span> self<span class=\"token punctuation\">.</span>alpha<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> hard_loss\n\n<span class=\"token comment\"># Teacher 모델 (큰 모델)에서 Student 모델 (작은 모델)로 지식 전달</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">train_with_distillation</span><span class=\"token punctuation\">(</span>teacher<span class=\"token punctuation\">,</span> student<span class=\"token punctuation\">,</span> dataloader<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    teacher<span class=\"token punctuation\">.</span><span class=\"token builtin\">eval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    student<span class=\"token punctuation\">.</span>train<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">for</span> batch <span class=\"token keyword\">in</span> dataloader<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">with</span> torch<span class=\"token punctuation\">.</span>no_grad<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            teacher_output <span class=\"token operator\">=</span> teacher<span class=\"token punctuation\">(</span>batch<span class=\"token punctuation\">)</span>\n\n        student_output <span class=\"token operator\">=</span> student<span class=\"token punctuation\">(</span>batch<span class=\"token punctuation\">)</span>\n        loss <span class=\"token operator\">=</span> distillation_loss<span class=\"token punctuation\">(</span>student_output<span class=\"token punctuation\">,</span> teacher_output<span class=\"token punctuation\">,</span> batch<span class=\"token punctuation\">[</span><span class=\"token string\">'target'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\n        loss<span class=\"token punctuation\">.</span>backward<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        optimizer<span class=\"token punctuation\">.</span>step<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h3 id=\"2-양자화\">2. 양자화</h3>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> torch<span class=\"token punctuation\">.</span>quantization <span class=\"token keyword\">as</span> quant\n\n<span class=\"token comment\"># 동적 양자화 적용</span>\nquantized_model <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>quantization<span class=\"token punctuation\">.</span>quantize_dynamic<span class=\"token punctuation\">(</span>\n    model<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">,</span> nn<span class=\"token punctuation\">.</span>LSTM<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    dtype<span class=\"token operator\">=</span>torch<span class=\"token punctuation\">.</span>qint8\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 정적 양자화를 위한 준비</span>\nmodel<span class=\"token punctuation\">.</span>qconfig <span class=\"token operator\">=</span> quant<span class=\"token punctuation\">.</span>get_default_qconfig<span class=\"token punctuation\">(</span><span class=\"token string\">'fbgemm'</span><span class=\"token punctuation\">)</span>\nmodel_prepared <span class=\"token operator\">=</span> quant<span class=\"token punctuation\">.</span>prepare<span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 캘리브레이션 (대표 데이터로)</span>\n<span class=\"token keyword\">for</span> batch <span class=\"token keyword\">in</span> calibration_loader<span class=\"token punctuation\">:</span>\n    model_prepared<span class=\"token punctuation\">(</span>batch<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 양자화 적용</span>\nmodel_quantized <span class=\"token operator\">=</span> quant<span class=\"token punctuation\">.</span>convert<span class=\"token punctuation\">(</span>model_prepared<span class=\"token punctuation\">)</span></code></pre></div>\n<h3 id=\"3-tensorrt-변환\">3. TensorRT 변환</h3>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> torch<span class=\"token punctuation\">.</span>onnx\n<span class=\"token keyword\">import</span> tensorrt <span class=\"token keyword\">as</span> trt\n\n<span class=\"token comment\"># 1. PyTorch → ONNX</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">export_to_onnx</span><span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">,</span> sample_input<span class=\"token punctuation\">,</span> output_path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    torch<span class=\"token punctuation\">.</span>onnx<span class=\"token punctuation\">.</span>export<span class=\"token punctuation\">(</span>\n        model<span class=\"token punctuation\">,</span>\n        sample_input<span class=\"token punctuation\">,</span>\n        output_path<span class=\"token punctuation\">,</span>\n        export_params<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">,</span>\n        opset_version<span class=\"token operator\">=</span><span class=\"token number\">13</span><span class=\"token punctuation\">,</span>\n        input_names<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'audio'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'text'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'emotion'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        output_names<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'blendshapes'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        dynamic_axes<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>\n            <span class=\"token string\">'audio'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token number\">0</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'batch'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'time'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">'blendshapes'</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token number\">0</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'batch'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'time'</span><span class=\"token punctuation\">}</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 2. ONNX → TensorRT</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">build_tensorrt_engine</span><span class=\"token punctuation\">(</span>onnx_path<span class=\"token punctuation\">,</span> engine_path<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    logger <span class=\"token operator\">=</span> trt<span class=\"token punctuation\">.</span>Logger<span class=\"token punctuation\">(</span>trt<span class=\"token punctuation\">.</span>Logger<span class=\"token punctuation\">.</span>WARNING<span class=\"token punctuation\">)</span>\n    builder <span class=\"token operator\">=</span> trt<span class=\"token punctuation\">.</span>Builder<span class=\"token punctuation\">(</span>logger<span class=\"token punctuation\">)</span>\n    network <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span>create_network<span class=\"token punctuation\">(</span>\n        <span class=\"token number\">1</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span>trt<span class=\"token punctuation\">.</span>NetworkDefinitionCreationFlag<span class=\"token punctuation\">.</span>EXPLICIT_BATCH<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n    parser <span class=\"token operator\">=</span> trt<span class=\"token punctuation\">.</span>OnnxParser<span class=\"token punctuation\">(</span>network<span class=\"token punctuation\">,</span> logger<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span>onnx_path<span class=\"token punctuation\">,</span> <span class=\"token string\">'rb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n        parser<span class=\"token punctuation\">.</span>parse<span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">.</span>read<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    config <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span>create_builder_config<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    config<span class=\"token punctuation\">.</span>set_flag<span class=\"token punctuation\">(</span>trt<span class=\"token punctuation\">.</span>BuilderFlag<span class=\"token punctuation\">.</span>FP16<span class=\"token punctuation\">)</span>  <span class=\"token comment\"># FP16 활성화</span>\n    config<span class=\"token punctuation\">.</span>max_workspace_size <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">&lt;&lt;</span> <span class=\"token number\">30</span>    <span class=\"token comment\"># 1GB</span>\n\n    engine <span class=\"token operator\">=</span> builder<span class=\"token punctuation\">.</span>build_engine<span class=\"token punctuation\">(</span>network<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">with</span> <span class=\"token builtin\">open</span><span class=\"token punctuation\">(</span>engine_path<span class=\"token punctuation\">,</span> <span class=\"token string\">'wb'</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">as</span> f<span class=\"token punctuation\">:</span>\n        f<span class=\"token punctuation\">.</span>write<span class=\"token punctuation\">(</span>engine<span class=\"token punctuation\">.</span>serialize<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>최적화 결과:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">최적화 후 처리 시간:\n- Audio 전처리: 15ms (스트리밍 처리)\n- TensorRT 추론: 65ms\n- 후처리: 5ms\n총: 85ms\n\n95th percentile: 120ms</code></pre></div>\n<p>목표인 100ms를 대부분의 경우에서 달성했습니다.</p>\n<h2 id=\"페르소나-캐릭터별-표현-스타일\">페르소나: 캐릭터별 표현 스타일</h2>\n<p>같은 \"기쁨\" 감정이라도 캐릭터마다 표현 방식이 달라야 했습니다. 프로페셔널한 캐릭터는 절제된 미소를, 친근한 캐릭터는 활발한 웃음을 짓는 것이 자연스럽습니다.</p>\n<p>이를 위해 페르소나 임베딩을 도입했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">PersonaEmbedding</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> num_personas<span class=\"token punctuation\">,</span> embedding_dim<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>embedding <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Embedding<span class=\"token punctuation\">(</span>num_personas<span class=\"token punctuation\">,</span> embedding_dim<span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># 페르소나별 스타일 변환 파라미터</span>\n        self<span class=\"token punctuation\">.</span>style_transform <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Sequential<span class=\"token punctuation\">(</span>\n            nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span>embedding_dim<span class=\"token punctuation\">,</span> embedding_dim <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            nn<span class=\"token punctuation\">.</span>ReLU<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n            nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span>embedding_dim <span class=\"token operator\">*</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> embedding_dim<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> persona_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        emb <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>embedding<span class=\"token punctuation\">(</span>persona_id<span class=\"token punctuation\">)</span>\n        style <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>style_transform<span class=\"token punctuation\">(</span>emb<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> style\n\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">PersonaAwareFaceDecoder</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> hidden_dim<span class=\"token punctuation\">,</span> output_dim<span class=\"token punctuation\">,</span> num_personas<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>persona_emb <span class=\"token operator\">=</span> PersonaEmbedding<span class=\"token punctuation\">(</span>num_personas<span class=\"token punctuation\">,</span> hidden_dim<span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>base_decoder <span class=\"token operator\">=</span> TemporalFaceDecoder<span class=\"token punctuation\">(</span>hidden_dim<span class=\"token punctuation\">,</span> output_dim<span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># FiLM (Feature-wise Linear Modulation) 레이어</span>\n        self<span class=\"token punctuation\">.</span>gamma <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span>hidden_dim<span class=\"token punctuation\">,</span> hidden_dim<span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>beta <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span>hidden_dim<span class=\"token punctuation\">,</span> hidden_dim<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> features<span class=\"token punctuation\">,</span> persona_id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        persona_style <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>persona_emb<span class=\"token punctuation\">(</span>persona_id<span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># 페르소나 스타일로 피처 변조</span>\n        gamma <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>gamma<span class=\"token punctuation\">(</span>persona_style<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>unsqueeze<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># [B, 1, H]</span>\n        beta <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>beta<span class=\"token punctuation\">(</span>persona_style<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>unsqueeze<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\n        modulated <span class=\"token operator\">=</span> gamma <span class=\"token operator\">*</span> features <span class=\"token operator\">+</span> beta\n\n        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>base_decoder<span class=\"token punctuation\">(</span>modulated<span class=\"token punctuation\">)</span></code></pre></div>\n<p>페르소나 정의 예시:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">personas</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">professional</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0</span>\n    <span class=\"token key atrule\">expression_range</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0.6</span>  <span class=\"token comment\"># 표현 범위 제한</span>\n    <span class=\"token key atrule\">smile_intensity</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0.4</span>\n    <span class=\"token key atrule\">blink_frequency</span><span class=\"token punctuation\">:</span> normal\n\n  <span class=\"token key atrule\">friendly</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1</span>\n    <span class=\"token key atrule\">expression_range</span><span class=\"token punctuation\">:</span> <span class=\"token number\">1.0</span>  <span class=\"token comment\"># 풀 표현</span>\n    <span class=\"token key atrule\">smile_intensity</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0.8</span>\n    <span class=\"token key atrule\">blink_frequency</span><span class=\"token punctuation\">:</span> frequent\n\n  <span class=\"token key atrule\">calm</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">id</span><span class=\"token punctuation\">:</span> <span class=\"token number\">2</span>\n    <span class=\"token key atrule\">expression_range</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0.5</span>\n    <span class=\"token key atrule\">smile_intensity</span><span class=\"token punctuation\">:</span> <span class=\"token number\">0.3</span>\n    <span class=\"token key atrule\">blink_frequency</span><span class=\"token punctuation\">:</span> slow</code></pre></div>\n<h2 id=\"arkit-blendshape-직접-예측\">ARKit Blendshape 직접 예측</h2>\n<p>출력 형식은 ARKit의 52개 blendshape 가중치를 선택했습니다. 업계 표준이라 다양한 렌더러와 호환성이 좋았기 때문입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># ARKit Blendshape 목록 (일부)</span>\nARKIT_BLENDSHAPES <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n    <span class=\"token string\">'browDownLeft'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'browDownRight'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'browInnerUp'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'browOuterUpLeft'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'browOuterUpRight'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'eyeBlinkLeft'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'eyeBlinkRight'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'eyeLookDownLeft'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'eyeLookDownRight'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'eyeLookInLeft'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'eyeLookInRight'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'eyeLookOutLeft'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'eyeLookOutRight'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'eyeLookUpLeft'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'eyeLookUpRight'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'eyeSquintLeft'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'eyeSquintRight'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'eyeWideLeft'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'eyeWideRight'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'jawForward'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'jawLeft'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'jawRight'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'jawOpen'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'mouthClose'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'mouthFunnel'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'mouthPucker'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'mouthLeft'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'mouthRight'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'mouthSmileLeft'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'mouthSmileRight'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token comment\"># ... 총 52개</span>\n<span class=\"token punctuation\">]</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">BlendshapeDecoder</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> hidden_dim<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>lstm <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>LSTM<span class=\"token punctuation\">(</span>hidden_dim<span class=\"token punctuation\">,</span> hidden_dim<span class=\"token punctuation\">,</span> num_layers<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> batch_first<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>output <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">(</span>hidden_dim<span class=\"token punctuation\">,</span> <span class=\"token number\">52</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>sigmoid <span class=\"token operator\">=</span> nn<span class=\"token punctuation\">.</span>Sigmoid<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># blendshape는 0~1 범위</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        lstm_out<span class=\"token punctuation\">,</span> _ <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>lstm<span class=\"token punctuation\">(</span>x<span class=\"token punctuation\">)</span>\n        blendshapes <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>sigmoid<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>output<span class=\"token punctuation\">(</span>lstm_out<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> blendshapes</code></pre></div>\n<p>처음에는 중간 표현(예: FLAME 파라미터)을 거쳐서 blendshape로 변환하는 방식을 시도했습니다. 하지만 직접 blendshape를 예측하는 것이 더 빠르고 정확했습니다.</p>\n<h2 id=\"평가와-결과\">평가와 결과</h2>\n<h3 id=\"정량적-평가\">정량적 평가</h3>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># 립싱크 정확도 평가</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">evaluate_lip_sync</span><span class=\"token punctuation\">(</span>predicted<span class=\"token punctuation\">,</span> ground_truth<span class=\"token punctuation\">,</span> audio<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"\n    Lip Sync 정확도 측정\n    - LMD (Lip Movement Distance): 예측과 GT의 입술 움직임 차이\n    - LSE (Lip Sync Error): 오디오와 입술 움직임의 동기화 오류\n    \"\"\"</span>\n    <span class=\"token comment\"># 입술 관련 blendshape만 추출</span>\n    lip_indices <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">23</span><span class=\"token punctuation\">,</span> <span class=\"token number\">24</span><span class=\"token punctuation\">,</span> <span class=\"token number\">25</span><span class=\"token punctuation\">,</span> <span class=\"token number\">26</span><span class=\"token punctuation\">,</span> <span class=\"token number\">27</span><span class=\"token punctuation\">,</span> <span class=\"token number\">28</span><span class=\"token punctuation\">,</span> <span class=\"token number\">29</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">]</span>  <span class=\"token comment\"># jawOpen, mouthClose 등</span>\n\n    pred_lip <span class=\"token operator\">=</span> predicted<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> lip_indices<span class=\"token punctuation\">]</span>\n    gt_lip <span class=\"token operator\">=</span> ground_truth<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> lip_indices<span class=\"token punctuation\">]</span>\n\n    lmd <span class=\"token operator\">=</span> F<span class=\"token punctuation\">.</span>mse_loss<span class=\"token punctuation\">(</span>pred_lip<span class=\"token punctuation\">,</span> gt_lip<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>item<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># 오디오-립 동기화 평가 (프레임 단위)</span>\n    lse <span class=\"token operator\">=</span> compute_sync_error<span class=\"token punctuation\">(</span>pred_lip<span class=\"token punctuation\">,</span> audio<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span><span class=\"token string\">'LMD'</span><span class=\"token punctuation\">:</span> lmd<span class=\"token punctuation\">,</span> <span class=\"token string\">'LSE'</span><span class=\"token punctuation\">:</span> lse<span class=\"token punctuation\">}</span></code></pre></div>\n<p>결과:</p>\n<table>\n<thead>\n<tr>\n<th>메트릭</th>\n<th>우리 모델</th>\n<th>Baseline (Audio-only)</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>LMD</td>\n<td>0.032</td>\n<td>0.058</td>\n</tr>\n<tr>\n<td>LSE</td>\n<td>1.2 frames</td>\n<td>2.1 frames</td>\n</tr>\n<tr>\n<td>추론 시간</td>\n<td>85ms</td>\n<td>65ms</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"사용자-평가\">사용자 평가</h3>\n<p>고객 서비스 시나리오와 교육 시나리오에서 사용자 평가를 진행했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">고객 서비스 시나리오:\n- 전반적 만족도: 4.6/5.0\n- 표정 자연스러움: 4.4/5.0\n- 립싱크 정확도: 4.5/5.0\n\n교육 시나리오:\n- 전반적 만족도: 4.7/5.0\n- 표정 자연스러움: 4.6/5.0\n- 집중도: 4.3/5.0</code></pre></div>\n<p>교육 시나리오에서 더 좋은 결과가 나왔는데, \"친근한\" 페르소나가 잘 맞았던 것 같습니다.</p>\n<h2 id=\"어려웠던-점과-해결책\">어려웠던 점과 해결책</h2>\n<h3 id=\"1-오디오-텍스트-동기화\">1. 오디오-텍스트 동기화</h3>\n<p>오디오와 텍스트의 타이밍이 맞지 않는 경우가 있었습니다. TTS로 생성된 오디오는 괜찮았지만, 실제 녹음 음성은 타이밍이 들쭉날쭉했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token comment\"># 강제 정렬 (Forced Alignment)로 해결</span>\n<span class=\"token keyword\">import</span> torch\n<span class=\"token keyword\">from</span> transformers <span class=\"token keyword\">import</span> Wav2Vec2ForCTC<span class=\"token punctuation\">,</span> Wav2Vec2Processor\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">get_word_timestamps</span><span class=\"token punctuation\">(</span>audio<span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"\n    Wav2Vec2를 활용한 단어 단위 타임스탬프 추출\n    \"\"\"</span>\n    processor <span class=\"token operator\">=</span> Wav2Vec2Processor<span class=\"token punctuation\">.</span>from_pretrained<span class=\"token punctuation\">(</span><span class=\"token string\">\"facebook/wav2vec2-base-960h\"</span><span class=\"token punctuation\">)</span>\n    model <span class=\"token operator\">=</span> Wav2Vec2ForCTC<span class=\"token punctuation\">.</span>from_pretrained<span class=\"token punctuation\">(</span><span class=\"token string\">\"facebook/wav2vec2-base-960h\"</span><span class=\"token punctuation\">)</span>\n\n    inputs <span class=\"token operator\">=</span> processor<span class=\"token punctuation\">(</span>audio<span class=\"token punctuation\">,</span> sampling_rate<span class=\"token operator\">=</span><span class=\"token number\">16000</span><span class=\"token punctuation\">,</span> return_tensors<span class=\"token operator\">=</span><span class=\"token string\">\"pt\"</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">with</span> torch<span class=\"token punctuation\">.</span>no_grad<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        logits <span class=\"token operator\">=</span> model<span class=\"token punctuation\">(</span>inputs<span class=\"token punctuation\">.</span>input_values<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>logits\n\n    <span class=\"token comment\"># CTC 디코딩으로 타임스탬프 추출</span>\n    predicted_ids <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>argmax<span class=\"token punctuation\">(</span>logits<span class=\"token punctuation\">,</span> dim<span class=\"token operator\">=</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n    transcription <span class=\"token operator\">=</span> processor<span class=\"token punctuation\">.</span>batch_decode<span class=\"token punctuation\">(</span>predicted_ids<span class=\"token punctuation\">)</span>\n\n    <span class=\"token comment\"># 단어별 타임스탬프 계산</span>\n    timestamps <span class=\"token operator\">=</span> extract_word_timestamps<span class=\"token punctuation\">(</span>logits<span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> timestamps</code></pre></div>\n<h3 id=\"2-긴-대화에서의-일관성\">2. 긴 대화에서의 일관성</h3>\n<p>긴 대화에서 페르소나 스타일이 흔들리는 문제가 있었습니다. 정규화 기법을 추가해서 해결했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">ConsistencyRegularizer</span><span class=\"token punctuation\">(</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> window_size<span class=\"token operator\">=</span><span class=\"token number\">30</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 30프레임 = 1초</span>\n        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>window_size <span class=\"token operator\">=</span> window_size\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> blendshapes<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token triple-quoted-string string\">\"\"\"\n        시간적 일관성을 위한 정규화\n        급격한 변화에 페널티 부여\n        \"\"\"</span>\n        <span class=\"token comment\"># 인접 프레임 간 차이</span>\n        temporal_diff <span class=\"token operator\">=</span> blendshapes<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> blendshapes<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>\n\n        <span class=\"token comment\"># 급격한 변화 감지</span>\n        jerk <span class=\"token operator\">=</span> temporal_diff<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">-</span> temporal_diff<span class=\"token punctuation\">[</span><span class=\"token punctuation\">:</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>\n\n        <span class=\"token comment\"># Smooth L1 loss로 급격한 변화에만 페널티</span>\n        consistency_loss <span class=\"token operator\">=</span> F<span class=\"token punctuation\">.</span>smooth_l1_loss<span class=\"token punctuation\">(</span>jerk<span class=\"token punctuation\">,</span> torch<span class=\"token punctuation\">.</span>zeros_like<span class=\"token punctuation\">(</span>jerk<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> consistency_loss</code></pre></div>\n<h3 id=\"3-실시간-처리를-위한-버퍼링\">3. 실시간 처리를 위한 버퍼링</h3>\n<p>스트리밍 입력을 처리하기 위해 버퍼링 시스템을 구현했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">StreamingFaceAnimator</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> model<span class=\"token punctuation\">,</span> buffer_size<span class=\"token operator\">=</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 500ms 버퍼</span>\n        self<span class=\"token punctuation\">.</span>model <span class=\"token operator\">=</span> model\n        self<span class=\"token punctuation\">.</span>buffer_size <span class=\"token operator\">=</span> buffer_size\n        self<span class=\"token punctuation\">.</span>audio_buffer <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n        self<span class=\"token punctuation\">.</span>text_buffer <span class=\"token operator\">=</span> <span class=\"token string\">\"\"</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">process_chunk</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> audio_chunk<span class=\"token punctuation\">,</span> text_chunk<span class=\"token operator\">=</span><span class=\"token boolean\">None</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token triple-quoted-string string\">\"\"\"\n        청크 단위로 오디오를 처리하고 애니메이션 생성\n        \"\"\"</span>\n        self<span class=\"token punctuation\">.</span>audio_buffer<span class=\"token punctuation\">.</span>append<span class=\"token punctuation\">(</span>audio_chunk<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">if</span> text_chunk<span class=\"token punctuation\">:</span>\n            self<span class=\"token punctuation\">.</span>text_buffer <span class=\"token operator\">+=</span> text_chunk\n\n        <span class=\"token comment\"># 버퍼가 충분히 쌓이면 처리</span>\n        <span class=\"token keyword\">if</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>audio_buffer<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">0.02</span> <span class=\"token operator\">>=</span> self<span class=\"token punctuation\">.</span>buffer_size<span class=\"token punctuation\">:</span>  <span class=\"token comment\"># 20ms 청크 기준</span>\n            audio <span class=\"token operator\">=</span> np<span class=\"token punctuation\">.</span>concatenate<span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>audio_buffer<span class=\"token punctuation\">)</span>\n            blendshapes <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>model<span class=\"token punctuation\">.</span>inference<span class=\"token punctuation\">(</span>audio<span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">.</span>text_buffer<span class=\"token punctuation\">)</span>\n\n            <span class=\"token comment\"># 버퍼 클리어 (오버랩 유지)</span>\n            overlap <span class=\"token operator\">=</span> <span class=\"token builtin\">int</span><span class=\"token punctuation\">(</span><span class=\"token number\">0.1</span> <span class=\"token operator\">/</span> <span class=\"token number\">0.02</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 100ms 오버랩</span>\n            self<span class=\"token punctuation\">.</span>audio_buffer <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>audio_buffer<span class=\"token punctuation\">[</span><span class=\"token operator\">-</span>overlap<span class=\"token punctuation\">:</span><span class=\"token punctuation\">]</span>\n\n            <span class=\"token keyword\">return</span> blendshapes\n\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">None</span></code></pre></div>\n<h2 id=\"배운-것들\">배운 것들</h2>\n<h3 id=\"멀티모달의-효과\">멀티모달의 효과</h3>\n<p>단일 모달리티보다 멀티모달 접근이 확실히 효과적이었습니다. 오디오만으로는 놓치는 맥락 정보를 텍스트와 감정 태그로 보완할 수 있었습니다.</p>\n<h3 id=\"실시간-제약의-중요성\">실시간 제약의 중요성</h3>\n<p>모델 설계 초기부터 실시간 성능을 고려해야 합니다. 나중에 최적화하려면 훨씬 어렵습니다. 프로토타입 단계에서도 추론 시간을 측정하면서 개발하는 것이 좋습니다.</p>\n<h3 id=\"아티스트-피드백의-가치\">아티스트 피드백의 가치</h3>\n<p>기술적 메트릭만으로는 부족했습니다. 실제 애니메이터들의 피드백을 받으면서 많은 것을 개선할 수 있었습니다. 특히 \"이 표정은 이 상황에서 어색하다\" 같은 정성적 피드백이 중요했습니다.</p>\n<h2 id=\"참고-자료\">참고 자료</h2>\n<ul>\n<li><a href=\"https://research.nvidia.com/publication/2017-07_Audio-Driven-Facial-Animation\">Audio-Driven Facial Animation by Joint End-to-End Learning of Pose and Emotion</a> - NVIDIA</li>\n<li><a href=\"https://developer.apple.com/documentation/arkit/arfaceanchor/blendshapelocation\">ARKit Face Tracking</a> - Apple Developer</li>\n<li><a href=\"https://voca.is.tue.mpg.de/\">VOCA: Capture, Learning, and Synthesis of 3D Speaking Styles</a> - MPI</li>\n</ul>","excerpt":"멀티모달 페이셜 애니메이션 시스템 개발기 NCSOFT Graphics AI Lab에서 디지털 휴먼의 얼굴 애니메이션 시스템을 개발했습니다. 오디오, 텍스트, 감정 정보를 입력받아 자연스러운 표정과 립싱크를 생성하는 시스템이었습니다. 이 글에서는 그 과정에서 겪은 기술적 도전과 해결 방법을 공유하고자 합니다. 왜 멀티모달인가 처음에는 오디오만으로 립싱크를 …","frontmatter":{"date":"23.02.01","dateISO":"2023-02-01","description":"NCSOFT에서 디지털 휴먼의 얼굴 애니메이션 시스템을 만들면서 배운 것들","slug":"/digital-human-facial-animation","heroImage":null,"heroImageAlt":null,"tags":["ai","dev"],"title":"멀티모달 페이셜 애니메이션 시스템 개발기"},"tableOfContents":"<ul>\n<li>\n<p><a href=\"#%EB%A9%80%ED%8B%B0%EB%AA%A8%EB%8B%AC-%ED%8E%98%EC%9D%B4%EC%85%9C-%EC%95%A0%EB%8B%88%EB%A9%94%EC%9D%B4%EC%85%98-%EC%8B%9C%EC%8A%A4%ED%85%9C-%EA%B0%9C%EB%B0%9C%EA%B8%B0\">멀티모달 페이셜 애니메이션 시스템 개발기</a></p>\n<ul>\n<li>\n<p><a href=\"#%EC%99%9C-%EB%A9%80%ED%8B%B0%EB%AA%A8%EB%8B%AC%EC%9D%B8%EA%B0%80\">왜 멀티모달인가</a></p>\n</li>\n<li>\n<p><a href=\"#100ms%EC%9D%98-%EB%B2%BD-%EC%8B%A4%EC%8B%9C%EA%B0%84-%EC%84%B1%EB%8A%A5-%EB%8B%AC%EC%84%B1\">100ms의 벽: 실시간 성능 달성</a></p>\n<ul>\n<li><a href=\"#1-%EB%AA%A8%EB%8D%B8-%EA%B2%BD%EB%9F%89%ED%99%94\">1. 모델 경량화</a></li>\n<li><a href=\"#2-%EC%96%91%EC%9E%90%ED%99%94\">2. 양자화</a></li>\n<li><a href=\"#3-tensorrt-%EB%B3%80%ED%99%98\">3. TensorRT 변환</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%ED%8E%98%EB%A5%B4%EC%86%8C%EB%82%98-%EC%BA%90%EB%A6%AD%ED%84%B0%EB%B3%84-%ED%91%9C%ED%98%84-%EC%8A%A4%ED%83%80%EC%9D%BC\">페르소나: 캐릭터별 표현 스타일</a></p>\n</li>\n<li>\n<p><a href=\"#arkit-blendshape-%EC%A7%81%EC%A0%91-%EC%98%88%EC%B8%A1\">ARKit Blendshape 직접 예측</a></p>\n</li>\n<li>\n<p><a href=\"#%ED%8F%89%EA%B0%80%EC%99%80-%EA%B2%B0%EA%B3%BC\">평가와 결과</a></p>\n<ul>\n<li><a href=\"#%EC%A0%95%EB%9F%89%EC%A0%81-%ED%8F%89%EA%B0%80\">정량적 평가</a></li>\n<li><a href=\"#%EC%82%AC%EC%9A%A9%EC%9E%90-%ED%8F%89%EA%B0%80\">사용자 평가</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%96%B4%EB%A0%A4%EC%9B%A0%EB%8D%98-%EC%A0%90%EA%B3%BC-%ED%95%B4%EA%B2%B0%EC%B1%85\">어려웠던 점과 해결책</a></p>\n<ul>\n<li><a href=\"#1-%EC%98%A4%EB%94%94%EC%98%A4-%ED%85%8D%EC%8A%A4%ED%8A%B8-%EB%8F%99%EA%B8%B0%ED%99%94\">1. 오디오-텍스트 동기화</a></li>\n<li><a href=\"#2-%EA%B8%B4-%EB%8C%80%ED%99%94%EC%97%90%EC%84%9C%EC%9D%98-%EC%9D%BC%EA%B4%80%EC%84%B1\">2. 긴 대화에서의 일관성</a></li>\n<li><a href=\"#3-%EC%8B%A4%EC%8B%9C%EA%B0%84-%EC%B2%98%EB%A6%AC%EB%A5%BC-%EC%9C%84%ED%95%9C-%EB%B2%84%ED%8D%BC%EB%A7%81\">3. 실시간 처리를 위한 버퍼링</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%B0%B0%EC%9A%B4-%EA%B2%83%EB%93%A4\">배운 것들</a></p>\n<ul>\n<li><a href=\"#%EB%A9%80%ED%8B%B0%EB%AA%A8%EB%8B%AC%EC%9D%98-%ED%9A%A8%EA%B3%BC\">멀티모달의 효과</a></li>\n<li><a href=\"#%EC%8B%A4%EC%8B%9C%EA%B0%84-%EC%A0%9C%EC%95%BD%EC%9D%98-%EC%A4%91%EC%9A%94%EC%84%B1\">실시간 제약의 중요성</a></li>\n<li><a href=\"#%EC%95%84%ED%8B%B0%EC%8A%A4%ED%8A%B8-%ED%94%BC%EB%93%9C%EB%B0%B1%EC%9D%98-%EA%B0%80%EC%B9%98\">아티스트 피드백의 가치</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%B0%B8%EA%B3%A0-%EC%9E%90%EB%A3%8C\">참고 자료</a></p>\n</li>\n</ul>\n</li>\n</ul>"}},"pageContext":{"id":"93c9aa11-8e01-52c3-9f16-e20e37d2840b","frontmatter__slug":"/digital-human-facial-animation","previous":"/stable-diffusion-generative-ai-2023","previousTitle":"SDXL로 텍스처 생성 프로젝트를 진행하면서","next":"/review-2021","nextTitle":"Review 2021"}},"staticQueryHashes":["12962592","3399079524","3470099541","4097432363","76375841"],"slicesMap":{}}