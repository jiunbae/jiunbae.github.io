{"componentChunkName":"component---src-templates-post-tsx","path":"/posts/mobile-ai-optimization-2023/","result":{"data":{"markdownRemark":{"html":"<h1 id=\"모바일에서-ai-모델-돌리기\">모바일에서 AI 모델 돌리기</h1>\n<p>2023년, On-device AI 프로젝트를 여러 개 진행하면서 많은 것을 배웠습니다. 스마트폰에서 AI 모델을 직접 돌리는 것이 생각보다 실용적인 수준에 도달했다는 것을 체감한 한 해였습니다. 이 글에서는 그 경험과 기술적인 내용을 정리합니다.</p>\n<h2 id=\"왜-모바일에서-돌리는가\">왜 모바일에서 돌리는가</h2>\n<p>On-device AI를 선택하는 이유는 크게 세 가지입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">ON_DEVICE_AI_BENEFITS <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"privacy\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"description\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"데이터를 서버로 전송하지 않음\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"use_cases\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"음성 인식\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"얼굴 인식\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"건강 데이터 분석\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"compliance\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"GDPR\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"HIPAA\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"개인정보보호법\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"latency\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"description\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"네트워크 왕복 시간 제거\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"server_api\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"100-500ms (네트워크 포함)\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"on_device\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"10-50ms (추론만)\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"improvement\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"5-10x 빠름\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"cost\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"description\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"API 호출 비용 없음\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"api_cost_per_1k\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$0.001-0.01\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"on_device_cost\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"$0 (초기 개발 비용만)\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"break_even\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"대량 처리 시 유리\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>실제 프로젝트에서는 프라이버시가 가장 큰 동기였습니다. 음성 데이터나 카메라 피드를 외부 서버로 보내는 것에 대한 사용자 우려가 컸고, 로컬 처리로 이 문제를 해결할 수 있었습니다.</p>\n<h2 id=\"실제로-구현한-기능들\">실제로 구현한 기능들</h2>\n<h3 id=\"1-이미지-분류\">1. 이미지 분류</h3>\n<p>MobileNet 계열 모델을 활용한 이미지 분류를 구현했습니다. Core ML로 변환하면 iPhone에서 실시간으로 동작합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> coremltools <span class=\"token keyword\">as</span> ct\n<span class=\"token keyword\">import</span> torch\n<span class=\"token keyword\">from</span> torchvision <span class=\"token keyword\">import</span> models\n\n<span class=\"token comment\"># PyTorch MobileNetV3 로드</span>\nmodel <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>mobilenet_v3_small<span class=\"token punctuation\">(</span>pretrained<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>\nmodel<span class=\"token punctuation\">.</span><span class=\"token builtin\">eval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 입력 예시 생성</span>\nexample_input <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>rand<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">224</span><span class=\"token punctuation\">,</span> <span class=\"token number\">224</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># TorchScript로 변환</span>\ntraced_model <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>jit<span class=\"token punctuation\">.</span>trace<span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">,</span> example_input<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Core ML 변환</span>\ncoreml_model <span class=\"token operator\">=</span> ct<span class=\"token punctuation\">.</span>convert<span class=\"token punctuation\">(</span>\n    traced_model<span class=\"token punctuation\">,</span>\n    inputs<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>ct<span class=\"token punctuation\">.</span>ImageType<span class=\"token punctuation\">(</span>\n        name<span class=\"token operator\">=</span><span class=\"token string\">\"image\"</span><span class=\"token punctuation\">,</span>\n        shape<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">224</span><span class=\"token punctuation\">,</span> <span class=\"token number\">224</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        scale<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token operator\">/</span><span class=\"token number\">255.0</span><span class=\"token punctuation\">,</span>\n        bias<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token operator\">-</span><span class=\"token number\">0.485</span><span class=\"token operator\">/</span><span class=\"token number\">0.229</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">0.456</span><span class=\"token operator\">/</span><span class=\"token number\">0.224</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">-</span><span class=\"token number\">0.406</span><span class=\"token operator\">/</span><span class=\"token number\">0.225</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    classifier_config<span class=\"token operator\">=</span>ct<span class=\"token punctuation\">.</span>ClassifierConfig<span class=\"token punctuation\">(</span><span class=\"token string\">\"imagenet_labels.txt\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    minimum_deployment_target<span class=\"token operator\">=</span>ct<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span>iOS15\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Neural Engine 최적화 설정</span>\ncoreml_model <span class=\"token operator\">=</span> ct<span class=\"token punctuation\">.</span>convert<span class=\"token punctuation\">(</span>\n    traced_model<span class=\"token punctuation\">,</span>\n    inputs<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>ct<span class=\"token punctuation\">.</span>ImageType<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"image\"</span><span class=\"token punctuation\">,</span> shape<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">224</span><span class=\"token punctuation\">,</span> <span class=\"token number\">224</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    compute_units<span class=\"token operator\">=</span>ct<span class=\"token punctuation\">.</span>ComputeUnit<span class=\"token punctuation\">.</span>ALL  <span class=\"token comment\"># CPU, GPU, Neural Engine 모두 활용</span>\n<span class=\"token punctuation\">)</span>\n\ncoreml_model<span class=\"token punctuation\">.</span>save<span class=\"token punctuation\">(</span><span class=\"token string\">\"MobileNetV3.mlpackage\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>Swift에서 사용하는 코드는 다음과 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">import</span> <span class=\"token class-name\">CoreML</span>\n<span class=\"token keyword\">import</span> <span class=\"token class-name\">Vision</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">ImageClassifier</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">let</span> model<span class=\"token punctuation\">:</span> <span class=\"token class-name\">VNCoreMLModel</span>\n\n    <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> config <span class=\"token operator\">=</span> <span class=\"token class-name\">MLModelConfiguration</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        config<span class=\"token punctuation\">.</span>computeUnits <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span>all  <span class=\"token comment\">// Neural Engine 활용</span>\n\n        <span class=\"token keyword\">let</span> coreMLModel <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> <span class=\"token class-name\">MobileNetV3</span><span class=\"token punctuation\">(</span>configuration<span class=\"token punctuation\">:</span> config<span class=\"token punctuation\">)</span>\n        model <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> <span class=\"token class-name\">VNCoreMLModel</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">for</span><span class=\"token punctuation\">:</span> coreMLModel<span class=\"token punctuation\">.</span>model<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">classify</span><span class=\"token punctuation\">(</span>image<span class=\"token punctuation\">:</span> <span class=\"token class-name\">CGImage</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">throws</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span>label<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">,</span> confidence<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Float</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">try</span> <span class=\"token keyword\">await</span> withCheckedThrowingContinuation <span class=\"token punctuation\">{</span> continuation <span class=\"token keyword\">in</span>\n            <span class=\"token keyword\">let</span> request <span class=\"token operator\">=</span> <span class=\"token class-name\">VNCoreMLRequest</span><span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">:</span> model<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> request<span class=\"token punctuation\">,</span> error <span class=\"token keyword\">in</span>\n                <span class=\"token keyword\">if</span> <span class=\"token keyword\">let</span> error <span class=\"token operator\">=</span> error <span class=\"token punctuation\">{</span>\n                    continuation<span class=\"token punctuation\">.</span><span class=\"token function\">resume</span><span class=\"token punctuation\">(</span>throwing<span class=\"token punctuation\">:</span> error<span class=\"token punctuation\">)</span>\n                    <span class=\"token keyword\">return</span>\n                <span class=\"token punctuation\">}</span>\n\n                <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> results <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>results <span class=\"token keyword\">as</span><span class=\"token operator\">?</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">VNClassificationObservation</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n                    continuation<span class=\"token punctuation\">.</span><span class=\"token function\">resume</span><span class=\"token punctuation\">(</span>returning<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token keyword\">return</span>\n                <span class=\"token punctuation\">}</span>\n\n                <span class=\"token keyword\">let</span> predictions <span class=\"token operator\">=</span> results<span class=\"token punctuation\">.</span><span class=\"token keyword\">prefix</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>map <span class=\"token punctuation\">{</span>\n                    <span class=\"token punctuation\">(</span>label<span class=\"token punctuation\">:</span> <span class=\"token short-argument\">$0</span><span class=\"token punctuation\">.</span>identifier<span class=\"token punctuation\">,</span> confidence<span class=\"token punctuation\">:</span> <span class=\"token short-argument\">$0</span><span class=\"token punctuation\">.</span>confidence<span class=\"token punctuation\">)</span>\n                <span class=\"token punctuation\">}</span>\n                continuation<span class=\"token punctuation\">.</span><span class=\"token function\">resume</span><span class=\"token punctuation\">(</span>returning<span class=\"token punctuation\">:</span> predictions<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token keyword\">let</span> handler <span class=\"token operator\">=</span> <span class=\"token class-name\">VNImageRequestHandler</span><span class=\"token punctuation\">(</span>cgImage<span class=\"token punctuation\">:</span> image<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">try</span><span class=\"token operator\">?</span> handler<span class=\"token punctuation\">.</span><span class=\"token function\">perform</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>request<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"2-음성-인식-whisper\">2. 음성 인식 (Whisper)</h3>\n<p>Whisper 모델을 Core ML로 변환해서 iPhone에서 돌려봤습니다. tiny와 base 모델이 모바일에서 실용적인 수준으로 동작했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> whisper\n<span class=\"token keyword\">import</span> coremltools <span class=\"token keyword\">as</span> ct\n<span class=\"token keyword\">import</span> torch\n\n<span class=\"token comment\"># Whisper tiny 모델 로드</span>\nmodel <span class=\"token operator\">=</span> whisper<span class=\"token punctuation\">.</span>load_model<span class=\"token punctuation\">(</span><span class=\"token string\">\"tiny\"</span><span class=\"token punctuation\">)</span>\nmodel<span class=\"token punctuation\">.</span><span class=\"token builtin\">eval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 오디오 인코더 변환</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">WhisperEncoder</span><span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> whisper_model<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>encoder <span class=\"token operator\">=</span> whisper_model<span class=\"token punctuation\">.</span>encoder\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> mel<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>encoder<span class=\"token punctuation\">(</span>mel<span class=\"token punctuation\">)</span>\n\nencoder <span class=\"token operator\">=</span> WhisperEncoder<span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">)</span>\nencoder<span class=\"token punctuation\">.</span><span class=\"token builtin\">eval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 트레이싱</span>\nmel_input <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>randn<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">80</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 30초 오디오</span>\ntraced_encoder <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>jit<span class=\"token punctuation\">.</span>trace<span class=\"token punctuation\">(</span>encoder<span class=\"token punctuation\">,</span> mel_input<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Core ML 변환</span>\nencoder_mlmodel <span class=\"token operator\">=</span> ct<span class=\"token punctuation\">.</span>convert<span class=\"token punctuation\">(</span>\n    traced_encoder<span class=\"token punctuation\">,</span>\n    inputs<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>ct<span class=\"token punctuation\">.</span>TensorType<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"mel\"</span><span class=\"token punctuation\">,</span> shape<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">80</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    minimum_deployment_target<span class=\"token operator\">=</span>ct<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span>iOS16\n<span class=\"token punctuation\">)</span>\n\nencoder_mlmodel<span class=\"token punctuation\">.</span>save<span class=\"token punctuation\">(</span><span class=\"token string\">\"WhisperEncoder.mlpackage\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>성능 측정 결과입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">WHISPER_PERFORMANCE <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"tiny\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"model_size\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"39MB\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"iphone_14_pro\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"inference_time\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"0.8초 (30초 오디오)\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"real_time_factor\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"0.027x\"</span>  <span class=\"token comment\"># 실시간보다 37배 빠름</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"iphone_12\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"inference_time\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1.5초\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"real_time_factor\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"0.05x\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"base\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"model_size\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"74MB\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"iphone_14_pro\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"inference_time\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1.8초\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"real_time_factor\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"0.06x\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"iphone_12\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"inference_time\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3.5초\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"real_time_factor\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"0.12x\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"3-텍스트-분류\">3. 텍스트 분류</h3>\n<p>DistilBERT를 모바일에 최적화해서 감정 분석에 사용했습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">from</span> transformers <span class=\"token keyword\">import</span> DistilBertTokenizer<span class=\"token punctuation\">,</span> DistilBertForSequenceClassification\n<span class=\"token keyword\">import</span> torch\n<span class=\"token keyword\">import</span> coremltools <span class=\"token keyword\">as</span> ct\n\n<span class=\"token comment\"># 모델 로드</span>\ntokenizer <span class=\"token operator\">=</span> DistilBertTokenizer<span class=\"token punctuation\">.</span>from_pretrained<span class=\"token punctuation\">(</span><span class=\"token string\">\"distilbert-base-uncased\"</span><span class=\"token punctuation\">)</span>\nmodel <span class=\"token operator\">=</span> DistilBertForSequenceClassification<span class=\"token punctuation\">.</span>from_pretrained<span class=\"token punctuation\">(</span>\n    <span class=\"token string\">\"distilbert-base-uncased-finetuned-sst-2-english\"</span>\n<span class=\"token punctuation\">)</span>\nmodel<span class=\"token punctuation\">.</span><span class=\"token builtin\">eval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 정적 입력 크기로 래핑</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">DistilBertWrapper</span><span class=\"token punctuation\">(</span>torch<span class=\"token punctuation\">.</span>nn<span class=\"token punctuation\">.</span>Module<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> model<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token builtin\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>__init__<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        self<span class=\"token punctuation\">.</span>model <span class=\"token operator\">=</span> model\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">forward</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> input_ids<span class=\"token punctuation\">,</span> attention_mask<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        outputs <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>model<span class=\"token punctuation\">(</span>input_ids<span class=\"token operator\">=</span>input_ids<span class=\"token punctuation\">,</span> attention_mask<span class=\"token operator\">=</span>attention_mask<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> outputs<span class=\"token punctuation\">.</span>logits\n\nwrapper <span class=\"token operator\">=</span> DistilBertWrapper<span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 트레이싱 (고정 시퀀스 길이)</span>\nMAX_SEQ_LEN <span class=\"token operator\">=</span> <span class=\"token number\">128</span>\ndummy_input_ids <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>zeros<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> MAX_SEQ_LEN<span class=\"token punctuation\">,</span> dtype<span class=\"token operator\">=</span>torch<span class=\"token punctuation\">.</span>int32<span class=\"token punctuation\">)</span>\ndummy_attention_mask <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>ones<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> MAX_SEQ_LEN<span class=\"token punctuation\">,</span> dtype<span class=\"token operator\">=</span>torch<span class=\"token punctuation\">.</span>int32<span class=\"token punctuation\">)</span>\n\ntraced_model <span class=\"token operator\">=</span> torch<span class=\"token punctuation\">.</span>jit<span class=\"token punctuation\">.</span>trace<span class=\"token punctuation\">(</span>wrapper<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>dummy_input_ids<span class=\"token punctuation\">,</span> dummy_attention_mask<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># Core ML 변환</span>\nmlmodel <span class=\"token operator\">=</span> ct<span class=\"token punctuation\">.</span>convert<span class=\"token punctuation\">(</span>\n    traced_model<span class=\"token punctuation\">,</span>\n    inputs<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span>\n        ct<span class=\"token punctuation\">.</span>TensorType<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"input_ids\"</span><span class=\"token punctuation\">,</span> shape<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> MAX_SEQ_LEN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> dtype<span class=\"token operator\">=</span>ct<span class=\"token punctuation\">.</span>int32<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n        ct<span class=\"token punctuation\">.</span>TensorType<span class=\"token punctuation\">(</span>name<span class=\"token operator\">=</span><span class=\"token string\">\"attention_mask\"</span><span class=\"token punctuation\">,</span> shape<span class=\"token operator\">=</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> MAX_SEQ_LEN<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> dtype<span class=\"token operator\">=</span>ct<span class=\"token punctuation\">.</span>int32<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n    minimum_deployment_target<span class=\"token operator\">=</span>ct<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span>iOS15\n<span class=\"token punctuation\">)</span>\n\nmlmodel<span class=\"token punctuation\">.</span>save<span class=\"token punctuation\">(</span><span class=\"token string\">\"DistilBertSentiment.mlpackage\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2 id=\"최적화-기법-상세\">최적화 기법 상세</h2>\n<h3 id=\"양자화-quantization\">양자화 (Quantization)</h3>\n<p>FP32에서 INT8로 양자화하면 모델 크기가 1/4로 줄어듭니다. 정확도 손실은 대부분의 경우 1% 미만이었습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> torch\n<span class=\"token keyword\">from</span> torch<span class=\"token punctuation\">.</span>quantization <span class=\"token keyword\">import</span> quantize_dynamic<span class=\"token punctuation\">,</span> get_default_qconfig\n<span class=\"token keyword\">import</span> coremltools <span class=\"token keyword\">as</span> ct\n\n<span class=\"token comment\"># 방법 1: PyTorch Dynamic Quantization</span>\nmodel_fp32 <span class=\"token operator\">=</span> load_your_model<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nmodel_int8 <span class=\"token operator\">=</span> quantize_dynamic<span class=\"token punctuation\">(</span>\n    model_fp32<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">{</span>torch<span class=\"token punctuation\">.</span>nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">,</span> torch<span class=\"token punctuation\">.</span>nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    dtype<span class=\"token operator\">=</span>torch<span class=\"token punctuation\">.</span>qint8\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 방법 2: Post-Training Quantization with calibration</span>\n<span class=\"token keyword\">from</span> torch<span class=\"token punctuation\">.</span>ao<span class=\"token punctuation\">.</span>quantization <span class=\"token keyword\">import</span> prepare<span class=\"token punctuation\">,</span> convert<span class=\"token punctuation\">,</span> default_qconfig\n\nmodel <span class=\"token operator\">=</span> load_your_model<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nmodel<span class=\"token punctuation\">.</span><span class=\"token builtin\">eval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 양자화 설정</span>\nmodel<span class=\"token punctuation\">.</span>qconfig <span class=\"token operator\">=</span> get_default_qconfig<span class=\"token punctuation\">(</span><span class=\"token string\">'fbgemm'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 캘리브레이션 준비</span>\nmodel_prepared <span class=\"token operator\">=</span> prepare<span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 대표 데이터로 캘리브레이션</span>\n<span class=\"token keyword\">with</span> torch<span class=\"token punctuation\">.</span>no_grad<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">for</span> batch <span class=\"token keyword\">in</span> calibration_dataloader<span class=\"token punctuation\">:</span>\n        model_prepared<span class=\"token punctuation\">(</span>batch<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 양자화 적용</span>\nmodel_quantized <span class=\"token operator\">=</span> convert<span class=\"token punctuation\">(</span>model_prepared<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 방법 3: Core ML 양자화</span>\nmlmodel <span class=\"token operator\">=</span> ct<span class=\"token punctuation\">.</span>models<span class=\"token punctuation\">.</span>MLModel<span class=\"token punctuation\">(</span><span class=\"token string\">\"model.mlpackage\"</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 16비트 양자화</span>\nmlmodel_fp16 <span class=\"token operator\">=</span> ct<span class=\"token punctuation\">.</span>models<span class=\"token punctuation\">.</span>neural_network<span class=\"token punctuation\">.</span>quantization_utils<span class=\"token punctuation\">.</span>quantize_weights<span class=\"token punctuation\">(</span>\n    mlmodel<span class=\"token punctuation\">,</span>\n    nbits<span class=\"token operator\">=</span><span class=\"token number\">16</span>\n<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># 8비트 양자화 (더 공격적)</span>\nmlmodel_int8 <span class=\"token operator\">=</span> ct<span class=\"token punctuation\">.</span>models<span class=\"token punctuation\">.</span>neural_network<span class=\"token punctuation\">.</span>quantization_utils<span class=\"token punctuation\">.</span>quantize_weights<span class=\"token punctuation\">(</span>\n    mlmodel<span class=\"token punctuation\">,</span>\n    nbits<span class=\"token operator\">=</span><span class=\"token number\">8</span>\n<span class=\"token punctuation\">)</span>\n\nmlmodel_int8<span class=\"token punctuation\">.</span>save<span class=\"token punctuation\">(</span><span class=\"token string\">\"model_quantized.mlpackage\"</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>양자화 결과 비교입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">QUANTIZATION_RESULTS <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"MobileNetV3\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"fp32\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"size\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"21.5MB\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"accuracy\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"75.2%\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"latency\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"12ms\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"fp16\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"size\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"10.8MB\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"accuracy\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"75.1%\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"latency\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"8ms\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"int8\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"size\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"5.4MB\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"accuracy\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"74.5%\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"latency\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"5ms\"</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"DistilBERT\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"fp32\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"size\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"268MB\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"accuracy\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"91.3%\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"latency\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"45ms\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"fp16\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"size\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"134MB\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"accuracy\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"91.2%\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"latency\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"28ms\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"int8\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"size\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"67MB\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"accuracy\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"90.8%\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"latency\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"18ms\"</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"pruning-가지치기\">Pruning (가지치기)</h3>\n<p>중요하지 않은 가중치를 제거해서 모델을 경량화합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> torch\n<span class=\"token keyword\">import</span> torch<span class=\"token punctuation\">.</span>nn<span class=\"token punctuation\">.</span>utils<span class=\"token punctuation\">.</span>prune <span class=\"token keyword\">as</span> prune\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">apply_structured_pruning</span><span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">,</span> amount<span class=\"token operator\">=</span><span class=\"token number\">0.3</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"\n    구조적 프루닝: 전체 필터/뉴런 제거\n    비구조적보다 실제 속도 향상에 유리\n    \"\"\"</span>\n    <span class=\"token keyword\">for</span> name<span class=\"token punctuation\">,</span> module <span class=\"token keyword\">in</span> model<span class=\"token punctuation\">.</span>named_modules<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">if</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>module<span class=\"token punctuation\">,</span> torch<span class=\"token punctuation\">.</span>nn<span class=\"token punctuation\">.</span>Conv2d<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            prune<span class=\"token punctuation\">.</span>ln_structured<span class=\"token punctuation\">(</span>\n                module<span class=\"token punctuation\">,</span>\n                name<span class=\"token operator\">=</span><span class=\"token string\">'weight'</span><span class=\"token punctuation\">,</span>\n                amount<span class=\"token operator\">=</span>amount<span class=\"token punctuation\">,</span>\n                n<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span>  <span class=\"token comment\"># L2 norm 기준</span>\n                dim<span class=\"token operator\">=</span><span class=\"token number\">0</span>  <span class=\"token comment\"># 출력 채널 방향</span>\n            <span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">elif</span> <span class=\"token builtin\">isinstance</span><span class=\"token punctuation\">(</span>module<span class=\"token punctuation\">,</span> torch<span class=\"token punctuation\">.</span>nn<span class=\"token punctuation\">.</span>Linear<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            prune<span class=\"token punctuation\">.</span>l1_unstructured<span class=\"token punctuation\">(</span>\n                module<span class=\"token punctuation\">,</span>\n                name<span class=\"token operator\">=</span><span class=\"token string\">'weight'</span><span class=\"token punctuation\">,</span>\n                amount<span class=\"token operator\">=</span>amount\n            <span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> model\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">apply_iterative_pruning</span><span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">,</span> dataloader<span class=\"token punctuation\">,</span> target_sparsity<span class=\"token operator\">=</span><span class=\"token number\">0.5</span><span class=\"token punctuation\">,</span> iterations<span class=\"token operator\">=</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token triple-quoted-string string\">\"\"\"\n    점진적 프루닝: 여러 단계에 걸쳐 조금씩 제거\n    급격한 성능 저하 방지\n    \"\"\"</span>\n    sparsity_per_iter <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token operator\">-</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">-</span> target_sparsity<span class=\"token punctuation\">)</span> <span class=\"token operator\">**</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">/</span> iterations<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span>iterations<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token comment\"># 프루닝 적용</span>\n        apply_structured_pruning<span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">,</span> amount<span class=\"token operator\">=</span>sparsity_per_iter<span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># 미세 조정</span>\n        fine_tune<span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">,</span> dataloader<span class=\"token punctuation\">,</span> epochs<span class=\"token operator\">=</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># 프루닝 마스크 영구화</span>\n        <span class=\"token keyword\">for</span> module <span class=\"token keyword\">in</span> model<span class=\"token punctuation\">.</span>modules<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">if</span> <span class=\"token builtin\">hasattr</span><span class=\"token punctuation\">(</span>module<span class=\"token punctuation\">,</span> <span class=\"token string\">'weight_orig'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n                prune<span class=\"token punctuation\">.</span>remove<span class=\"token punctuation\">(</span>module<span class=\"token punctuation\">,</span> <span class=\"token string\">'weight'</span><span class=\"token punctuation\">)</span>\n\n        current_sparsity <span class=\"token operator\">=</span> calculate_sparsity<span class=\"token punctuation\">(</span>model<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span><span class=\"token string-interpolation\"><span class=\"token string\">f\"Iteration </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>i<span class=\"token operator\">+</span><span class=\"token number\">1</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">: Sparsity = </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>current_sparsity<span class=\"token punctuation\">:</span><span class=\"token format-spec\">.2%</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> model\n\n<span class=\"token comment\"># 프루닝 전후 비교</span>\nPRUNING_RESULTS <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"original\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"params\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3.4M\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"latency\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"12ms\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"accuracy\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"75.2%\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"30%_pruned\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"params\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"2.4M\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"latency\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"9ms\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"accuracy\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"74.8%\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"50%_pruned\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"params\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1.7M\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"latency\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"7ms\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"accuracy\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"74.1%\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"70%_pruned\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"params\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1.0M\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"latency\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"5ms\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"accuracy\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"72.5%\"</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"knowledge-distillation\">Knowledge Distillation</h3>\n<p>큰 교사 모델의 지식을 작은 학생 모델로 전이합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\"><span class=\"token keyword\">import</span> torch\n<span class=\"token keyword\">import</span> torch<span class=\"token punctuation\">.</span>nn<span class=\"token punctuation\">.</span>functional <span class=\"token keyword\">as</span> F\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">DistillationTrainer</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>\n        self<span class=\"token punctuation\">,</span>\n        teacher_model<span class=\"token punctuation\">,</span>\n        student_model<span class=\"token punctuation\">,</span>\n        temperature<span class=\"token operator\">=</span><span class=\"token number\">4.0</span><span class=\"token punctuation\">,</span>\n        alpha<span class=\"token operator\">=</span><span class=\"token number\">0.7</span>  <span class=\"token comment\"># soft label 가중치</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>teacher <span class=\"token operator\">=</span> teacher_model\n        self<span class=\"token punctuation\">.</span>student <span class=\"token operator\">=</span> student_model\n        self<span class=\"token punctuation\">.</span>temperature <span class=\"token operator\">=</span> temperature\n        self<span class=\"token punctuation\">.</span>alpha <span class=\"token operator\">=</span> alpha\n\n        self<span class=\"token punctuation\">.</span>teacher<span class=\"token punctuation\">.</span><span class=\"token builtin\">eval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">for</span> param <span class=\"token keyword\">in</span> self<span class=\"token punctuation\">.</span>teacher<span class=\"token punctuation\">.</span>parameters<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            param<span class=\"token punctuation\">.</span>requires_grad <span class=\"token operator\">=</span> <span class=\"token boolean\">False</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">distillation_loss</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> student_logits<span class=\"token punctuation\">,</span> teacher_logits<span class=\"token punctuation\">,</span> labels<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token triple-quoted-string string\">\"\"\"\n        Distillation Loss = α * KL(soft_student || soft_teacher)\n                          + (1-α) * CE(student, labels)\n        \"\"\"</span>\n        <span class=\"token comment\"># Soft labels from teacher</span>\n        soft_teacher <span class=\"token operator\">=</span> F<span class=\"token punctuation\">.</span>softmax<span class=\"token punctuation\">(</span>teacher_logits <span class=\"token operator\">/</span> self<span class=\"token punctuation\">.</span>temperature<span class=\"token punctuation\">,</span> dim<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n        soft_student <span class=\"token operator\">=</span> F<span class=\"token punctuation\">.</span>log_softmax<span class=\"token punctuation\">(</span>student_logits <span class=\"token operator\">/</span> self<span class=\"token punctuation\">.</span>temperature<span class=\"token punctuation\">,</span> dim<span class=\"token operator\">=</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># KL Divergence for soft labels</span>\n        soft_loss <span class=\"token operator\">=</span> F<span class=\"token punctuation\">.</span>kl_div<span class=\"token punctuation\">(</span>\n            soft_student<span class=\"token punctuation\">,</span>\n            soft_teacher<span class=\"token punctuation\">,</span>\n            reduction<span class=\"token operator\">=</span><span class=\"token string\">'batchmean'</span>\n        <span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">.</span>temperature <span class=\"token operator\">**</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># Hard label loss</span>\n        hard_loss <span class=\"token operator\">=</span> F<span class=\"token punctuation\">.</span>cross_entropy<span class=\"token punctuation\">(</span>student_logits<span class=\"token punctuation\">,</span> labels<span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># Combined loss</span>\n        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>alpha <span class=\"token operator\">*</span> soft_loss <span class=\"token operator\">+</span> <span class=\"token punctuation\">(</span><span class=\"token number\">1</span> <span class=\"token operator\">-</span> self<span class=\"token punctuation\">.</span>alpha<span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> hard_loss\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">train_step</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> batch<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        inputs<span class=\"token punctuation\">,</span> labels <span class=\"token operator\">=</span> batch\n\n        <span class=\"token comment\"># Teacher prediction (no gradient)</span>\n        <span class=\"token keyword\">with</span> torch<span class=\"token punctuation\">.</span>no_grad<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            teacher_logits <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>teacher<span class=\"token punctuation\">(</span>inputs<span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># Student prediction</span>\n        student_logits <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>student<span class=\"token punctuation\">(</span>inputs<span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># Calculate loss</span>\n        loss <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>distillation_loss<span class=\"token punctuation\">(</span>student_logits<span class=\"token punctuation\">,</span> teacher_logits<span class=\"token punctuation\">,</span> labels<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> loss\n\n<span class=\"token comment\"># 사용 예시</span>\nteacher <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>resnet50<span class=\"token punctuation\">(</span>pretrained<span class=\"token operator\">=</span><span class=\"token boolean\">True</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 25.6M params</span>\nstudent <span class=\"token operator\">=</span> models<span class=\"token punctuation\">.</span>mobilenet_v3_small<span class=\"token punctuation\">(</span>pretrained<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\"># 2.5M params</span>\n\ntrainer <span class=\"token operator\">=</span> DistillationTrainer<span class=\"token punctuation\">(</span>teacher<span class=\"token punctuation\">,</span> student<span class=\"token punctuation\">,</span> temperature<span class=\"token operator\">=</span><span class=\"token number\">4.0</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2 id=\"플랫폼별-구현\">플랫폼별 구현</h2>\n<h3 id=\"ios-core-ml\">iOS (Core ML)</h3>\n<p>Core ML은 Apple의 ML 프레임워크로, Neural Engine을 활용하면 매우 빠른 추론이 가능합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"swift\"><pre class=\"language-swift\"><code class=\"language-swift\"><span class=\"token keyword\">import</span> <span class=\"token class-name\">CoreML</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">CoreMLInference</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">let</span> model<span class=\"token punctuation\">:</span> <span class=\"token class-name\">MLModel</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">let</span> asyncModel<span class=\"token punctuation\">:</span> <span class=\"token class-name\">MLModel</span><span class=\"token operator\">?</span>\n\n    <span class=\"token keyword\">init</span><span class=\"token punctuation\">(</span>modelName<span class=\"token punctuation\">:</span> <span class=\"token class-name\">String</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> config <span class=\"token operator\">=</span> <span class=\"token class-name\">MLModelConfiguration</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\">// 계산 유닛 설정</span>\n        config<span class=\"token punctuation\">.</span>computeUnits <span class=\"token operator\">=</span> <span class=\"token punctuation\">.</span>all  <span class=\"token comment\">// CPU + GPU + Neural Engine</span>\n\n        <span class=\"token comment\">// 비동기 예측을 위한 설정</span>\n        config<span class=\"token punctuation\">.</span>allowLowPrecisionAccumulationOnGPU <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n\n        <span class=\"token comment\">// 모델 로드</span>\n        <span class=\"token keyword\">guard</span> <span class=\"token keyword\">let</span> modelURL <span class=\"token operator\">=</span> <span class=\"token class-name\">Bundle</span><span class=\"token punctuation\">.</span>main<span class=\"token punctuation\">.</span><span class=\"token function\">url</span><span class=\"token punctuation\">(</span>\n            forResource<span class=\"token punctuation\">:</span> modelName<span class=\"token punctuation\">,</span>\n            withExtension<span class=\"token punctuation\">:</span> <span class=\"token string-literal\"><span class=\"token string\">\"mlpackage\"</span></span>\n        <span class=\"token punctuation\">)</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">throw</span> <span class=\"token class-name\">ModelError</span><span class=\"token punctuation\">.</span>modelNotFound\n        <span class=\"token punctuation\">}</span>\n\n        model <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> <span class=\"token class-name\">MLModel</span><span class=\"token punctuation\">(</span>contentsOf<span class=\"token punctuation\">:</span> modelURL<span class=\"token punctuation\">,</span> configuration<span class=\"token punctuation\">:</span> config<span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\">// iOS 16+ 비동기 모델</span>\n        <span class=\"token keyword\">if</span> <span class=\"token other-directive property\">#available</span><span class=\"token punctuation\">(</span>iOS <span class=\"token number\">16.0</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            asyncModel <span class=\"token operator\">=</span> model\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n            asyncModel <span class=\"token operator\">=</span> <span class=\"token nil constant\">nil</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 동기 추론</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">predict</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">:</span> <span class=\"token class-name\">MLFeatureProvider</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">MLFeatureProvider</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">try</span> model<span class=\"token punctuation\">.</span><span class=\"token function\">prediction</span><span class=\"token punctuation\">(</span>from<span class=\"token punctuation\">:</span> input<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 비동기 추론 (iOS 16+)</span>\n    <span class=\"token attribute atrule\">@available</span><span class=\"token punctuation\">(</span>iOS <span class=\"token number\">16.0</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">predictAsync</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">:</span> <span class=\"token class-name\">MLFeatureProvider</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">async</span> <span class=\"token keyword\">throws</span> <span class=\"token operator\">-></span> <span class=\"token class-name\">MLFeatureProvider</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">return</span> <span class=\"token keyword\">try</span> <span class=\"token keyword\">await</span> asyncModel<span class=\"token operator\">!</span><span class=\"token punctuation\">.</span><span class=\"token function\">prediction</span><span class=\"token punctuation\">(</span>from<span class=\"token punctuation\">:</span> input<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 배치 추론</span>\n    <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">predictBatch</span><span class=\"token punctuation\">(</span>inputs<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">MLFeatureProvider</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token keyword\">throws</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">MLFeatureProvider</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> batchProvider <span class=\"token operator\">=</span> <span class=\"token class-name\">MLArrayBatchProvider</span><span class=\"token punctuation\">(</span>array<span class=\"token punctuation\">:</span> inputs<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">let</span> results <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span> model<span class=\"token punctuation\">.</span><span class=\"token function\">predictions</span><span class=\"token punctuation\">(</span>fromBatch<span class=\"token punctuation\">:</span> batchProvider<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">var</span> outputs<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">MLFeatureProvider</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n        <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token number\">0</span><span class=\"token operator\">..&lt;</span>results<span class=\"token punctuation\">.</span>count <span class=\"token punctuation\">{</span>\n            outputs<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>results<span class=\"token punctuation\">.</span><span class=\"token function\">features</span><span class=\"token punctuation\">(</span>at<span class=\"token punctuation\">:</span> i<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">return</span> outputs\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 성능 측정</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">PerformanceProfiler</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">static</span> <span class=\"token keyword\">func</span> <span class=\"token function-definition function\">measureInference</span><span class=\"token punctuation\">(</span>\n        model<span class=\"token punctuation\">:</span> <span class=\"token class-name\">MLModel</span><span class=\"token punctuation\">,</span>\n        input<span class=\"token punctuation\">:</span> <span class=\"token class-name\">MLFeatureProvider</span><span class=\"token punctuation\">,</span>\n        iterations<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Int</span> <span class=\"token operator\">=</span> <span class=\"token number\">100</span>\n    <span class=\"token punctuation\">)</span> <span class=\"token operator\">-></span> <span class=\"token punctuation\">(</span>mean<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Double</span><span class=\"token punctuation\">,</span> std<span class=\"token punctuation\">:</span> <span class=\"token class-name\">Double</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">var</span> times<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token class-name\">Double</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n        <span class=\"token comment\">// 워밍업</span>\n        <span class=\"token keyword\">for</span> <span class=\"token omit keyword\">_</span> <span class=\"token keyword\">in</span> <span class=\"token number\">0</span><span class=\"token operator\">..&lt;</span><span class=\"token number\">10</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token omit keyword\">_</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span><span class=\"token operator\">?</span> model<span class=\"token punctuation\">.</span><span class=\"token function\">prediction</span><span class=\"token punctuation\">(</span>from<span class=\"token punctuation\">:</span> input<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token comment\">// 측정</span>\n        <span class=\"token keyword\">for</span> <span class=\"token omit keyword\">_</span> <span class=\"token keyword\">in</span> <span class=\"token number\">0</span><span class=\"token operator\">..&lt;</span>iterations <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">let</span> start <span class=\"token operator\">=</span> <span class=\"token class-name\">CFAbsoluteTimeGetCurrent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n            <span class=\"token omit keyword\">_</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">try</span><span class=\"token operator\">?</span> model<span class=\"token punctuation\">.</span><span class=\"token function\">prediction</span><span class=\"token punctuation\">(</span>from<span class=\"token punctuation\">:</span> input<span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">let</span> elapsed <span class=\"token operator\">=</span> <span class=\"token class-name\">CFAbsoluteTimeGetCurrent</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">-</span> start\n            times<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>elapsed <span class=\"token operator\">*</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">// ms로 변환</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">let</span> mean <span class=\"token operator\">=</span> times<span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">+</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token class-name\">Double</span><span class=\"token punctuation\">(</span>times<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">let</span> variance <span class=\"token operator\">=</span> times<span class=\"token punctuation\">.</span>map <span class=\"token punctuation\">{</span> <span class=\"token function\">pow</span><span class=\"token punctuation\">(</span><span class=\"token short-argument\">$0</span> <span class=\"token operator\">-</span> mean<span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">+</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token class-name\">Double</span><span class=\"token punctuation\">(</span>times<span class=\"token punctuation\">.</span>count<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">let</span> std <span class=\"token operator\">=</span> <span class=\"token function\">sqrt</span><span class=\"token punctuation\">(</span>variance<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>mean<span class=\"token punctuation\">,</span> std<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"android-tensorflow-lite\">Android (TensorFlow Lite)</h3>\n<p>TensorFlow Lite는 Android에서 가장 널리 사용되는 ML 프레임워크입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"kotlin\"><pre class=\"language-kotlin\"><code class=\"language-kotlin\"><span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>tensorflow<span class=\"token punctuation\">.</span>lite<span class=\"token punctuation\">.</span>Interpreter\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>tensorflow<span class=\"token punctuation\">.</span>lite<span class=\"token punctuation\">.</span>gpu<span class=\"token punctuation\">.</span>GpuDelegate\n<span class=\"token keyword\">import</span> org<span class=\"token punctuation\">.</span>tensorflow<span class=\"token punctuation\">.</span>lite<span class=\"token punctuation\">.</span>nnapi<span class=\"token punctuation\">.</span>NnApiDelegate\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>nio<span class=\"token punctuation\">.</span>ByteBuffer\n<span class=\"token keyword\">import</span> java<span class=\"token punctuation\">.</span>nio<span class=\"token punctuation\">.</span>ByteOrder\n\n<span class=\"token keyword\">class</span> <span class=\"token function\">TFLiteInference</span><span class=\"token punctuation\">(</span>context<span class=\"token operator\">:</span> Context<span class=\"token punctuation\">,</span> modelPath<span class=\"token operator\">:</span> String<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">val</span> interpreter<span class=\"token operator\">:</span> Interpreter\n\n    <span class=\"token keyword\">init</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token comment\">// 모델 로드</span>\n        <span class=\"token keyword\">val</span> modelBuffer <span class=\"token operator\">=</span> <span class=\"token function\">loadModelFile</span><span class=\"token punctuation\">(</span>context<span class=\"token punctuation\">,</span> modelPath<span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\">// 인터프리터 옵션 설정</span>\n        <span class=\"token keyword\">val</span> options <span class=\"token operator\">=</span> Interpreter<span class=\"token punctuation\">.</span><span class=\"token function\">Options</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token comment\">// GPU 가속 (지원되는 기기에서)</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">val</span> gpuDelegate <span class=\"token operator\">=</span> <span class=\"token function\">GpuDelegate</span><span class=\"token punctuation\">(</span>\n                    GpuDelegate<span class=\"token punctuation\">.</span><span class=\"token function\">Options</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token function\">setPrecisionLossAllowed</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">// FP16 허용</span>\n                        <span class=\"token function\">setInferencePreference</span><span class=\"token punctuation\">(</span>\n                            GpuDelegate<span class=\"token punctuation\">.</span>Options<span class=\"token punctuation\">.</span>INFERENCE_PREFERENCE_SUSTAINED_SPEED\n                        <span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">)</span>\n                <span class=\"token function\">addDelegate</span><span class=\"token punctuation\">(</span>gpuDelegate<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token operator\">:</span> Exception<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">// GPU 미지원 기기 - CPU fallback</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token comment\">// NNAPI 가속 (Android 8.1+)</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">val</span> nnApiDelegate <span class=\"token operator\">=</span> <span class=\"token function\">NnApiDelegate</span><span class=\"token punctuation\">(</span>\n                    NnApiDelegate<span class=\"token punctuation\">.</span><span class=\"token function\">Options</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span> <span class=\"token punctuation\">{</span>\n                        <span class=\"token function\">setAllowFp16</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n                        <span class=\"token function\">setUseNnapiCpu</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n                    <span class=\"token punctuation\">}</span>\n                <span class=\"token punctuation\">)</span>\n                <span class=\"token function\">addDelegate</span><span class=\"token punctuation\">(</span>nnApiDelegate<span class=\"token punctuation\">)</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token operator\">:</span> Exception<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token comment\">// NNAPI 미지원</span>\n            <span class=\"token punctuation\">}</span>\n\n            <span class=\"token function\">setNumThreads</span><span class=\"token punctuation\">(</span><span class=\"token number\">4</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n\n        interpreter <span class=\"token operator\">=</span> <span class=\"token function\">Interpreter</span><span class=\"token punctuation\">(</span>modelBuffer<span class=\"token punctuation\">,</span> options<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">predict</span><span class=\"token punctuation\">(</span>input<span class=\"token operator\">:</span> FloatArray<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> FloatArray <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> inputBuffer <span class=\"token operator\">=</span> ByteBuffer<span class=\"token punctuation\">.</span><span class=\"token function\">allocateDirect</span><span class=\"token punctuation\">(</span>input<span class=\"token punctuation\">.</span>size <span class=\"token operator\">*</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">order</span><span class=\"token punctuation\">(</span>ByteOrder<span class=\"token punctuation\">.</span><span class=\"token function\">nativeOrder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n            input<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span> <span class=\"token punctuation\">{</span> <span class=\"token function\">putFloat</span><span class=\"token punctuation\">(</span>it<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span>\n            <span class=\"token function\">rewind</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">val</span> outputShape <span class=\"token operator\">=</span> interpreter<span class=\"token punctuation\">.</span><span class=\"token function\">getOutputTensor</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">shape</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> outputSize <span class=\"token operator\">=</span> outputShape<span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span> <span class=\"token punctuation\">{</span> acc<span class=\"token punctuation\">,</span> i <span class=\"token operator\">-></span> acc <span class=\"token operator\">*</span> i <span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">val</span> outputBuffer <span class=\"token operator\">=</span> ByteBuffer<span class=\"token punctuation\">.</span><span class=\"token function\">allocateDirect</span><span class=\"token punctuation\">(</span>outputSize <span class=\"token operator\">*</span> <span class=\"token number\">4</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token function\">order</span><span class=\"token punctuation\">(</span>ByteOrder<span class=\"token punctuation\">.</span><span class=\"token function\">nativeOrder</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span>\n\n        interpreter<span class=\"token punctuation\">.</span><span class=\"token function\">run</span><span class=\"token punctuation\">(</span>inputBuffer<span class=\"token punctuation\">,</span> outputBuffer<span class=\"token punctuation\">)</span>\n\n        outputBuffer<span class=\"token punctuation\">.</span><span class=\"token function\">rewind</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> output <span class=\"token operator\">=</span> <span class=\"token function\">FloatArray</span><span class=\"token punctuation\">(</span>outputSize<span class=\"token punctuation\">)</span>\n        outputBuffer<span class=\"token punctuation\">.</span><span class=\"token function\">asFloatBuffer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>output<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> output\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// 이미지 분류용 편의 메서드</span>\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">classifyImage</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token operator\">:</span> Bitmap<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> List<span class=\"token operator\">&lt;</span>Pair<span class=\"token operator\">&lt;</span>Int<span class=\"token punctuation\">,</span> Float<span class=\"token operator\">></span><span class=\"token operator\">></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> inputArray <span class=\"token operator\">=</span> <span class=\"token function\">preprocessImage</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> output <span class=\"token operator\">=</span> <span class=\"token function\">predict</span><span class=\"token punctuation\">(</span>inputArray<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">return</span> output<span class=\"token punctuation\">.</span><span class=\"token function\">mapIndexed</span> <span class=\"token punctuation\">{</span> index<span class=\"token punctuation\">,</span> confidence <span class=\"token operator\">-></span>\n            index <span class=\"token keyword\">to</span> confidence\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">sortedByDescending</span> <span class=\"token punctuation\">{</span> it<span class=\"token punctuation\">.</span>second <span class=\"token punctuation\">}</span><span class=\"token punctuation\">.</span><span class=\"token function\">take</span><span class=\"token punctuation\">(</span><span class=\"token number\">5</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">preprocessImage</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token operator\">:</span> Bitmap<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> FloatArray <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> resized <span class=\"token operator\">=</span> Bitmap<span class=\"token punctuation\">.</span><span class=\"token function\">createScaledBitmap</span><span class=\"token punctuation\">(</span>bitmap<span class=\"token punctuation\">,</span> <span class=\"token number\">224</span><span class=\"token punctuation\">,</span> <span class=\"token number\">224</span><span class=\"token punctuation\">,</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> pixels <span class=\"token operator\">=</span> <span class=\"token function\">IntArray</span><span class=\"token punctuation\">(</span><span class=\"token number\">224</span> <span class=\"token operator\">*</span> <span class=\"token number\">224</span><span class=\"token punctuation\">)</span>\n        resized<span class=\"token punctuation\">.</span><span class=\"token function\">getPixels</span><span class=\"token punctuation\">(</span>pixels<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">224</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">224</span><span class=\"token punctuation\">,</span> <span class=\"token number\">224</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">val</span> input <span class=\"token operator\">=</span> <span class=\"token function\">FloatArray</span><span class=\"token punctuation\">(</span><span class=\"token number\">224</span> <span class=\"token operator\">*</span> <span class=\"token number\">224</span> <span class=\"token operator\">*</span> <span class=\"token number\">3</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token keyword\">in</span> pixels<span class=\"token punctuation\">.</span>indices<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">val</span> pixel <span class=\"token operator\">=</span> pixels<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\n            input<span class=\"token punctuation\">[</span>i <span class=\"token operator\">*</span> <span class=\"token number\">3</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>pixel <span class=\"token operator\">shr</span> <span class=\"token number\">16</span> <span class=\"token operator\">and</span> <span class=\"token number\">0xFF</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">255.0f</span> <span class=\"token operator\">-</span> <span class=\"token number\">0.485f</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">0.229f</span>\n            input<span class=\"token punctuation\">[</span>i <span class=\"token operator\">*</span> <span class=\"token number\">3</span> <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>pixel <span class=\"token operator\">shr</span> <span class=\"token number\">8</span> <span class=\"token operator\">and</span> <span class=\"token number\">0xFF</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">255.0f</span> <span class=\"token operator\">-</span> <span class=\"token number\">0.456f</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">0.224f</span>\n            input<span class=\"token punctuation\">[</span>i <span class=\"token operator\">*</span> <span class=\"token number\">3</span> <span class=\"token operator\">+</span> <span class=\"token number\">2</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>pixel <span class=\"token operator\">and</span> <span class=\"token number\">0xFF</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">255.0f</span> <span class=\"token operator\">-</span> <span class=\"token number\">0.406f</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">/</span> <span class=\"token number\">0.225f</span>\n        <span class=\"token punctuation\">}</span>\n\n        <span class=\"token keyword\">return</span> input\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">private</span> <span class=\"token keyword\">fun</span> <span class=\"token function\">loadModelFile</span><span class=\"token punctuation\">(</span>context<span class=\"token operator\">:</span> Context<span class=\"token punctuation\">,</span> path<span class=\"token operator\">:</span> String<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> ByteBuffer <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">val</span> assetFileDescriptor <span class=\"token operator\">=</span> context<span class=\"token punctuation\">.</span>assets<span class=\"token punctuation\">.</span><span class=\"token function\">openFd</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> inputStream <span class=\"token operator\">=</span> assetFileDescriptor<span class=\"token punctuation\">.</span><span class=\"token function\">createInputStream</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">val</span> fileChannel <span class=\"token operator\">=</span> inputStream<span class=\"token punctuation\">.</span>channel\n        <span class=\"token keyword\">val</span> startOffset <span class=\"token operator\">=</span> assetFileDescriptor<span class=\"token punctuation\">.</span>startOffset\n        <span class=\"token keyword\">val</span> declaredLength <span class=\"token operator\">=</span> assetFileDescriptor<span class=\"token punctuation\">.</span>declaredLength\n        <span class=\"token keyword\">return</span> fileChannel<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>\n            java<span class=\"token punctuation\">.</span>nio<span class=\"token punctuation\">.</span>channels<span class=\"token punctuation\">.</span>FileChannel<span class=\"token punctuation\">.</span>MapMode<span class=\"token punctuation\">.</span>READ_ONLY<span class=\"token punctuation\">,</span>\n            startOffset<span class=\"token punctuation\">,</span>\n            declaredLength\n        <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">fun</span> <span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        interpreter<span class=\"token punctuation\">.</span><span class=\"token function\">close</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"성능-벤치마크\">성능 벤치마크</h2>\n<p>실제 디바이스에서 측정한 결과입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">BENCHMARK_RESULTS <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"MobileNetV3-Small (Image Classification)\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"iPhone_14_Pro\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"latency\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3.2ms\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"throughput\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"312 FPS\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"iPhone_12\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"latency\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"5.8ms\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"throughput\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"172 FPS\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Pixel_7\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"latency\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"4.5ms\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"throughput\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"222 FPS\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Galaxy_S23\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"latency\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"4.1ms\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"throughput\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"244 FPS\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Pixel_4a\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"latency\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"12.3ms\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"throughput\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"81 FPS\"</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"Whisper-Tiny (30s Audio)\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"iPhone_14_Pro\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"latency\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"0.8s\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"RTF\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"0.027\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"iPhone_12\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"latency\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1.5s\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"RTF\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"0.05\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Pixel_7\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"latency\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1.2s\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"RTF\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"0.04\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Galaxy_S23\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"latency\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1.1s\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"RTF\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"0.037\"</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"DistilBERT (128 tokens)\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"iPhone_14_Pro\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"latency\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"15ms\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"iPhone_12\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"latency\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"28ms\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Pixel_7\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"latency\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"22ms\"</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"Galaxy_S23\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"latency\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"19ms\"</span><span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"배터리-및-발열-고려사항\">배터리 및 발열 고려사항</h2>\n<p>모바일 AI에서 간과하기 쉬운 부분이 배터리 소모와 발열입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">POWER_CONSUMPTION <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"continuous_inference\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"warning\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"지속적인 추론은 배터리를 빠르게 소모\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"image_classification\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"30fps_continuous\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"시간당 약 15-20% 배터리 소모\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"recommendation\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"필요할 때만 추론, 프레임 스킵 고려\"</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"audio_processing\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">\"realtime_transcription\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"시간당 약 10-15% 배터리 소모\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"recommendation\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"버퍼링 후 배치 처리 고려\"</span>\n        <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"thermal_throttling\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"issue\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"지속적 추론 시 발열로 인한 성능 저하\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"mitigation\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token string\">\"추론 간격 두기 (예: 100ms마다)\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"Neural Engine 우선 사용 (GPU보다 발열 적음)\"</span><span class=\"token punctuation\">,</span>\n            <span class=\"token string\">\"배치 크기 조절\"</span>\n        <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\"># 배터리 효율적인 추론 패턴</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">BatteryEfficientInference</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">def</span> <span class=\"token function\">__init__</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> model<span class=\"token punctuation\">,</span> min_interval_ms<span class=\"token operator\">=</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        self<span class=\"token punctuation\">.</span>model <span class=\"token operator\">=</span> model\n        self<span class=\"token punctuation\">.</span>min_interval <span class=\"token operator\">=</span> min_interval_ms <span class=\"token operator\">/</span> <span class=\"token number\">1000</span>\n        self<span class=\"token punctuation\">.</span>last_inference_time <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">should_run_inference</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token triple-quoted-string string\">\"\"\"필요할 때만 추론 실행\"\"\"</span>\n        current_time <span class=\"token operator\">=</span> time<span class=\"token punctuation\">.</span>time<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> current_time <span class=\"token operator\">-</span> self<span class=\"token punctuation\">.</span>last_inference_time <span class=\"token operator\">>=</span> self<span class=\"token punctuation\">.</span>min_interval<span class=\"token punctuation\">:</span>\n            self<span class=\"token punctuation\">.</span>last_inference_time <span class=\"token operator\">=</span> current_time\n            <span class=\"token keyword\">return</span> <span class=\"token boolean\">True</span>\n        <span class=\"token keyword\">return</span> <span class=\"token boolean\">False</span>\n\n    <span class=\"token keyword\">def</span> <span class=\"token function\">run_with_throttling</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">,</span> input_data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> self<span class=\"token punctuation\">.</span>should_run_inference<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>last_result  <span class=\"token comment\"># 캐시된 결과 반환</span>\n\n        self<span class=\"token punctuation\">.</span>last_result <span class=\"token operator\">=</span> self<span class=\"token punctuation\">.</span>model<span class=\"token punctuation\">.</span>predict<span class=\"token punctuation\">(</span>input_data<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> self<span class=\"token punctuation\">.</span>last_result</code></pre></div>\n<h2 id=\"한계와-현실\">한계와 현실</h2>\n<p>2023년 기준, 아직 대형 모델은 모바일에서 실용적이지 않습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">MOBILE_AI_LIMITATIONS <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"model_size\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"practical_limit\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"~500MB\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"reason\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"앱 다운로드 크기, 메모리 제약\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"llm_7b\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"약 4GB (4-bit 양자화 후에도)\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"feasibility\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"아직 어려움\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"memory\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"iphone_14_pro\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"6GB RAM\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"typical_android\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"4-8GB RAM\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"available_for_ml\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"1-2GB (다른 앱, OS 고려)\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"llm_requirement\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"4GB+ (7B 모델)\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"battery\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"issue\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"지속 사용 시 빠른 배터리 소모\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"user_experience\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"영향 큼\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"2024년-전망\">2024년 전망</h2>\n<p>하드웨어가 계속 발전하면서 더 큰 모델도 모바일에서 돌릴 수 있게 될 것입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"python\"><pre class=\"language-python\"><code class=\"language-python\">FUTURE_OUTLOOK <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token string\">\"hardware_improvements\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"neural_engine\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"매년 2-3배 성능 향상\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"memory\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"8GB+ RAM 일반화\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"npu\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"전용 AI 칩 탑재 확대\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"software_optimizations\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"quantization\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"2-bit, 1-bit 양자화 연구\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"speculative_decoding\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"작은 모델로 큰 모델 가속\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"continuous_batching\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"효율적인 배치 처리\"</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">\"expected_capabilities\"</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"2024\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"3B 파라미터 LLM 모바일 실행\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"2025\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"7B+ 모델 실용화 예상\"</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>llama.cpp로 7B 모델을 맥북에서 돌리는 것은 이미 가능하고, 일부 사용자는 iPhone에서도 실행하고 있습니다. 아직 실용적인 속도는 아니지만, 방향성은 명확합니다.</p>\n<h2 id=\"참고-자료\">참고 자료</h2>\n<ul>\n<li><a href=\"https://developer.apple.com/documentation/coreml\">Core ML Documentation</a></li>\n<li><a href=\"https://www.tensorflow.org/lite/guide\">TensorFlow Lite Guide</a></li>\n<li><a href=\"https://onnxruntime.ai/docs/tutorials/mobile/\">ONNX Runtime Mobile</a></li>\n<li><a href=\"https://github.com/ggerganov/llama.cpp\">llama.cpp</a> - LLM의 모바일/엣지 실행</li>\n<li><a href=\"https://mlc.ai/mlc-llm/\">MLC LLM</a> - 범용 LLM 배포 솔루션</li>\n</ul>","excerpt":"모바일에서 AI 모델 돌리기 2023년, On-device AI 프로젝트를 여러 개 진행하면서 많은 것을 배웠습니다. 스마트폰에서 AI 모델을 직접 돌리는 것이 생각보다 실용적인 수준에 도달했다는 것을 체감한 한 해였습니다. 이 글에서는 그 경험과 기술적인 내용을 정리합니다. 왜 모바일에서 돌리는가 On-device AI를 선택하는 이유는 크게 세 가지입…","frontmatter":{"date":"23.06.01","dateISO":"2023-06-01","description":"스마트폰에서 AI 모델 돌리기 - Core ML, TensorFlow Lite 활용법과 모델 경량화, 양자화 기법까지 실무에서 배운 On-device AI 최적화 노하우","slug":"/mobile-ai-optimization-2023","heroImage":null,"heroImageAlt":null,"tags":["ai","dev"],"title":"모바일에서 AI 모델 돌리기"},"tableOfContents":"<ul>\n<li>\n<p><a href=\"#%EB%AA%A8%EB%B0%94%EC%9D%BC%EC%97%90%EC%84%9C-ai-%EB%AA%A8%EB%8D%B8-%EB%8F%8C%EB%A6%AC%EA%B8%B0\">모바일에서 AI 모델 돌리기</a></p>\n<ul>\n<li>\n<p><a href=\"#%EC%99%9C-%EB%AA%A8%EB%B0%94%EC%9D%BC%EC%97%90%EC%84%9C-%EB%8F%8C%EB%A6%AC%EB%8A%94%EA%B0%80\">왜 모바일에서 돌리는가</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%8B%A4%EC%A0%9C%EB%A1%9C-%EA%B5%AC%ED%98%84%ED%95%9C-%EA%B8%B0%EB%8A%A5%EB%93%A4\">실제로 구현한 기능들</a></p>\n<ul>\n<li><a href=\"#1-%EC%9D%B4%EB%AF%B8%EC%A7%80-%EB%B6%84%EB%A5%98\">1. 이미지 분류</a></li>\n<li><a href=\"#2-%EC%9D%8C%EC%84%B1-%EC%9D%B8%EC%8B%9D-whisper\">2. 음성 인식 (Whisper)</a></li>\n<li><a href=\"#3-%ED%85%8D%EC%8A%A4%ED%8A%B8-%EB%B6%84%EB%A5%98\">3. 텍스트 분류</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%B5%9C%EC%A0%81%ED%99%94-%EA%B8%B0%EB%B2%95-%EC%83%81%EC%84%B8\">최적화 기법 상세</a></p>\n<ul>\n<li><a href=\"#%EC%96%91%EC%9E%90%ED%99%94-quantization\">양자화 (Quantization)</a></li>\n<li><a href=\"#pruning-%EA%B0%80%EC%A7%80%EC%B9%98%EA%B8%B0\">Pruning (가지치기)</a></li>\n<li><a href=\"#knowledge-distillation\">Knowledge Distillation</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%ED%94%8C%EB%9E%AB%ED%8F%BC%EB%B3%84-%EA%B5%AC%ED%98%84\">플랫폼별 구현</a></p>\n<ul>\n<li><a href=\"#ios-core-ml\">iOS (Core ML)</a></li>\n<li><a href=\"#android-tensorflow-lite\">Android (TensorFlow Lite)</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%84%B1%EB%8A%A5-%EB%B2%A4%EC%B9%98%EB%A7%88%ED%81%AC\">성능 벤치마크</a></p>\n</li>\n<li>\n<p><a href=\"#%EB%B0%B0%ED%84%B0%EB%A6%AC-%EB%B0%8F-%EB%B0%9C%EC%97%B4-%EA%B3%A0%EB%A0%A4%EC%82%AC%ED%95%AD\">배터리 및 발열 고려사항</a></p>\n</li>\n<li>\n<p><a href=\"#%ED%95%9C%EA%B3%84%EC%99%80-%ED%98%84%EC%8B%A4\">한계와 현실</a></p>\n</li>\n<li>\n<p><a href=\"#2024%EB%85%84-%EC%A0%84%EB%A7%9D\">2024년 전망</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%B0%B8%EA%B3%A0-%EC%9E%90%EB%A3%8C\">참고 자료</a></p>\n</li>\n</ul>\n</li>\n</ul>"}},"pageContext":{"id":"4ef9c089-800b-58bb-ad30-31c3c28331dc","frontmatter__slug":"/mobile-ai-optimization-2023","previous":"/vision-devices-large-models-2023","previousTitle":"2023년 Vision Transformer 정리","next":"/stable-diffusion-ai-generation-2023","nextTitle":"Stable Diffusion을 실무에 적용해본 경험"}},"staticQueryHashes":["12962592","3399079524","3470099541","4097432363","76375841"],"slicesMap":{}}