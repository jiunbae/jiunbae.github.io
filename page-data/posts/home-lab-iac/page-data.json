{"componentChunkName":"component---src-templates-post-tsx","path":"/posts/home-lab-iac/","result":{"data":{"markdownRemark":{"html":"<h1 id=\"home-lab-인프라를-코드로-관리하기-terraform--ansible\">Home Lab 인프라를 코드로 관리하기: Terraform + Ansible</h1>\n<blockquote>\n<p>목표: **\"서버 날아가면 그냥 다시 돌리면 돼\"**를 현실로 만들기.\n결과: 수동 설정 0, 재현 가능한 인프라, 그리고 마음의 평화.</p>\n</blockquote>\n<hr>\n<h2 id=\"배경-왜-iac를-도입했나\">배경: 왜 IaC를 도입했나</h2>\n<p><a href=\"/posts/home-dev\">이전 글</a>에서 Tailscale과 Cloudflare Tunnel로 네트워크를 정리한 이야기를 했었다. 그 과정에서 자연스럽게 \"이 설정들을 어떻게 관리하지?\"라는 고민이 생겼다.</p>\n<p>처음에는 그냥 서버에 SSH로 접속해서 하나씩 설정했다. Tailscale 설치하고, nginx 설정하고, Docker 컨테이너 띄우고. 문제는 이게 쌓이면서 \"내가 뭘 어떻게 설정했더라?\"를 기억하기 어려워졌다는 것이다. 특히 몇 달 후에 서버를 재설정해야 할 때, 과거의 내가 무슨 짓을 했는지 알 수 없는 상황이 생겼다. 특히 간헐적으로 있는 물리 장치를 마이그레이션 할때마다 2주 넘게 삽질을 하면서 설정을 복기하고 새로운 장치에 알맞는 설정으로 다시 진행하는 과정이 너무 고통 스러웠다.</p>\n<p>회사에서 Kubernetes나 Terraform을 사용하면서 인프라를 코드로 관리하는 경험을 했었고, 집에서도 비슷하게 해보고 싶다는 생각이 있었다. 마침 LLM의 도움을 받으면 익숙하지 않은 도구도 빠르게 배울 수 있을 것 같아서 이번 기회에 제대로 구성해보기로 했다.</p>\n<hr>\n<h2 id=\"현재-인프라-구성\">현재 인프라 구성</h2>\n<p>먼저 현재 Home Lab의 물리적 구성을 설명하면, Aoostar WTR Pro라는 미니 PC에 Proxmox VE를 설치해서 사용하고 있다. 저전력이면서도 코어 수가 충분해서 가상화 용도로 적합했다.</p>\n<p><svg id=\"mermaid-0\" width=\"100%\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" class=\"flowchart\" style=\"max-width: 1032.328125px;\" viewBox=\"0 0 1032.328125 584.4414672851562\" role=\"graphics-document document\" aria-roledescription=\"flowchart-v2\"><style>#mermaid-0{font-family:inherit;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-0 .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-0 .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-0 .error-icon{fill:#552222;}#mermaid-0 .error-text{fill:#552222;stroke:#552222;}#mermaid-0 .edge-thickness-normal{stroke-width:1px;}#mermaid-0 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-0 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-0 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-0 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-0 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-0 .marker{fill:#333333;stroke:#333333;}#mermaid-0 .marker.cross{stroke:#333333;}#mermaid-0 svg{font-family:inherit;font-size:16px;}#mermaid-0 p{margin:0;}#mermaid-0 .label{font-family:inherit;color:#333;}#mermaid-0 .cluster-label text{fill:#333;}#mermaid-0 .cluster-label span{color:#333;}#mermaid-0 .cluster-label span p{background-color:transparent;}#mermaid-0 .label text,#mermaid-0 span{fill:#333;color:#333;}#mermaid-0 .node rect,#mermaid-0 .node circle,#mermaid-0 .node ellipse,#mermaid-0 .node polygon,#mermaid-0 .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-0 .rough-node .label text,#mermaid-0 .node .label text,#mermaid-0 .image-shape .label,#mermaid-0 .icon-shape .label{text-anchor:middle;}#mermaid-0 .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-0 .rough-node .label,#mermaid-0 .node .label,#mermaid-0 .image-shape .label,#mermaid-0 .icon-shape .label{text-align:center;}#mermaid-0 .node.clickable{cursor:pointer;}#mermaid-0 .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#mermaid-0 .arrowheadPath{fill:#333333;}#mermaid-0 .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-0 .flowchart-link{stroke:#333333;fill:none;}#mermaid-0 .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#mermaid-0 .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#mermaid-0 .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#mermaid-0 .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#mermaid-0 .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-0 .cluster text{fill:#333;}#mermaid-0 .cluster span{color:#333;}#mermaid-0 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:inherit;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-0 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#mermaid-0 rect.text{fill:none;stroke-width:0;}#mermaid-0 .icon-shape,#mermaid-0 .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#mermaid-0 .icon-shape p,#mermaid-0 .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#mermaid-0 .icon-shape rect,#mermaid-0 .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#mermaid-0 .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#mermaid-0 .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#mermaid-0 :root{--mermaid-font-family:arial,sans-serif;}</style><g><marker id=\"mermaid-0_flowchart-v2-pointEnd\" class=\"marker flowchart-v2\" viewBox=\"0 0 10 10\" refX=\"5\" refY=\"5\" markerUnits=\"userSpaceOnUse\" markerWidth=\"8\" markerHeight=\"8\" orient=\"auto\"><path d=\"M 0 0 L 10 5 L 0 10 z\" class=\"arrowMarkerPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path></marker><marker id=\"mermaid-0_flowchart-v2-pointStart\" class=\"marker flowchart-v2\" viewBox=\"0 0 10 10\" refX=\"4.5\" refY=\"5\" markerUnits=\"userSpaceOnUse\" markerWidth=\"8\" markerHeight=\"8\" orient=\"auto\"><path d=\"M 0 5 L 10 10 L 10 0 z\" class=\"arrowMarkerPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path></marker><marker id=\"mermaid-0_flowchart-v2-circleEnd\" class=\"marker flowchart-v2\" viewBox=\"0 0 10 10\" refX=\"11\" refY=\"5\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" markerHeight=\"11\" orient=\"auto\"><circle cx=\"5\" cy=\"5\" r=\"5\" class=\"arrowMarkerPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></circle></marker><marker id=\"mermaid-0_flowchart-v2-circleStart\" class=\"marker flowchart-v2\" viewBox=\"0 0 10 10\" refX=\"-1\" refY=\"5\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" markerHeight=\"11\" orient=\"auto\"><circle cx=\"5\" cy=\"5\" r=\"5\" class=\"arrowMarkerPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></circle></marker><marker id=\"mermaid-0_flowchart-v2-crossEnd\" class=\"marker cross flowchart-v2\" viewBox=\"0 0 11 11\" refX=\"12\" refY=\"5.2\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" markerHeight=\"11\" orient=\"auto\"><path d=\"M 1,1 l 9,9 M 10,1 l -9,9\" class=\"arrowMarkerPath\" style=\"stroke-width: 2; stroke-dasharray: 1, 0;\"></path></marker><marker id=\"mermaid-0_flowchart-v2-crossStart\" class=\"marker cross flowchart-v2\" viewBox=\"0 0 11 11\" refX=\"-1\" refY=\"5.2\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" markerHeight=\"11\" orient=\"auto\"><path d=\"M 1,1 l 9,9 M 10,1 l -9,9\" class=\"arrowMarkerPath\" style=\"stroke-width: 2; stroke-dasharray: 1, 0;\"></path></marker><g class=\"root\"><g class=\"clusters\"><g class=\"cluster\" id=\"PROXMOX\" data-look=\"classic\"><rect style=\"\" x=\"148.328125\" y=\"173.4414520263672\" width=\"876\" height=\"403\"></rect><g class=\"cluster-label\" transform=\"translate(486.328125, 173.4414520263672)\"><foreignObject width=\"200\" height=\"48\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table; white-space: break-spaces; line-height: 1.5; max-width: 200px; text-align: center; width: 200px;\"><span class=\"nodeLabel\"><p>Proxmox VE 9.1.2 (Aoostar WTR Pro)</p></span></div></foreignObject></g></g><g class=\"cluster\" id=\"VM\" data-look=\"classic\"><rect style=\"\" x=\"168.328125\" y=\"399.4414520263672\" width=\"282.984375\" height=\"152\"></rect><g class=\"cluster-label\" transform=\"translate(250.828125, 399.4414520263672)\"><foreignObject width=\"117.984375\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Virtual Machines</p></span></div></foreignObject></g></g><g class=\"cluster\" id=\"LXC\" data-look=\"classic\"><rect style=\"\" x=\"471.3125\" y=\"198.4414520263672\" width=\"533.015625\" height=\"353\"></rect><g class=\"cluster-label\" transform=\"translate(681.34375, 198.4414520263672)\"><foreignObject width=\"112.953125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>LXC Containers</p></span></div></foreignObject></g></g></g><g class=\"edgePaths\"><path d=\"M69.359,92.354L69.359,99.702C69.359,107.05,69.359,121.745,69.359,135.26C69.359,148.775,69.359,161.108,69.359,171.441C69.359,181.775,69.359,190.108,69.359,198.444C69.359,206.779,69.359,215.117,69.359,219.286L69.359,223.455\" id=\"L_Internet_CF_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_Internet_CF_0\" data-points=\"W3sieCI6NjkuMzU5Mzc1LCJ5Ijo4OC4zNTM1Mzg1MTMxODM2fSx7IngiOjY5LjM1OTM3NSwieSI6MTM2LjQ0MTQ1MjAyNjM2NzJ9LHsieCI6NjkuMzU5Mzc1LCJ5IjoxNzMuNDQxNDUyMDI2MzY3Mn0seyJ4Ijo2OS4zNTkzNzUsInkiOjE5OC40NDE0NTIwMjYzNjcyfSx7IngiOjY5LjM1OTM3NSwieSI6MjI3LjQ1NDk1MjIzOTk5MDIzfV0=\" marker-start=\"url(#mermaid-0_flowchart-v2-pointStart)\" marker-end=\"url(#mermaid-0_flowchart-v2-pointEnd)\"></path><path d=\"M117.084,291.907L149.207,303.663C181.33,315.419,245.575,338.93,277.698,356.852C309.82,374.775,309.82,387.108,309.82,396.775C309.82,406.441,309.82,413.441,309.82,416.941L309.82,420.441\" id=\"L_CF_K3S_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_CF_K3S_0\" data-points=\"W3sieCI6MTEzLjMyODEyNSwieSI6MjkwLjUzMjQyMzE0MzAzNzY1fSx7IngiOjMwOS44MjAzMTI1LCJ5IjozNjIuNDQxNDUyMDI2MzY3Mn0seyJ4IjozMDkuODIwMzEyNSwieSI6Mzk5LjQ0MTQ1MjAyNjM2NzJ9LHsieCI6MzA5LjgyMDMxMjUsInkiOjQyNC40NDE0NTIwMjYzNjcyfV0=\" marker-start=\"url(#mermaid-0_flowchart-v2-pointStart)\" marker-end=\"url(#mermaid-0_flowchart-v2-pointEnd)\"></path><path d=\"M742.715,103.441L742.715,108.941C742.715,114.441,742.715,125.441,742.715,137.108C742.715,148.775,742.715,161.108,742.715,171.441C742.715,181.775,742.715,190.108,742.715,197.775C742.715,205.441,742.715,212.441,742.715,215.941L742.715,219.441\" id=\"L_TS_GW_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_TS_GW_0\" data-points=\"W3sieCI6NzQyLjcxNDg0Mzc1LCJ5Ijo5OS40NDE0NTIwMjYzNjcxOX0seyJ4Ijo3NDIuNzE0ODQzNzUsInkiOjEzNi40NDE0NTIwMjYzNjcyfSx7IngiOjc0Mi43MTQ4NDM3NSwieSI6MTczLjQ0MTQ1MjAyNjM2NzJ9LHsieCI6NzQyLjcxNDg0Mzc1LCJ5IjoxOTguNDQxNDUyMDI2MzY3Mn0seyJ4Ijo3NDIuNzE0ODQzNzUsInkiOjIyMy40NDE0NTIwMjYzNjcyfV0=\" marker-start=\"url(#mermaid-0_flowchart-v2-pointStart)\" marker-end=\"url(#mermaid-0_flowchart-v2-pointEnd)\"></path><path d=\"M672.187,325.441L663.659,331.608C655.131,337.775,638.075,350.108,629.547,362.441C621.02,374.775,621.02,387.108,621.02,396.775C621.02,406.441,621.02,413.441,621.02,416.941L621.02,420.441\" id=\"L_GW_MON_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_GW_MON_0\" data-points=\"W3sieCI6NjcyLjE4Njg3ODU1MTEzNjQsInkiOjMyNS40NDE0NTIwMjYzNjcyfSx7IngiOjYyMS4wMTk1MzEyNSwieSI6MzYyLjQ0MTQ1MjAyNjM2NzJ9LHsieCI6NjIxLjAxOTUzMTI1LCJ5IjozOTkuNDQxNDUyMDI2MzY3Mn0seyJ4Ijo2MjEuMDE5NTMxMjUsInkiOjQyNC40NDE0NTIwMjYzNjcyfV0=\" marker-end=\"url(#mermaid-0_flowchart-v2-pointEnd)\"></path><path d=\"M813.243,325.441L821.771,331.608C830.299,337.775,847.354,350.108,855.882,362.441C864.41,374.775,864.41,387.108,864.41,396.775C864.41,406.441,864.41,413.441,864.41,416.941L864.41,420.441\" id=\"L_GW_REG_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_GW_REG_0\" data-points=\"W3sieCI6ODEzLjI0MjgwODk0ODg2MzYsInkiOjMyNS40NDE0NTIwMjYzNjcyfSx7IngiOjg2NC40MTAxNTYyNSwieSI6MzYyLjQ0MTQ1MjAyNjM2NzJ9LHsieCI6ODY0LjQxMDE1NjI1LCJ5IjozOTkuNDQxNDUyMDI2MzY3Mn0seyJ4Ijo4NjQuNDEwMTU2MjUsInkiOjQyNC40NDE0NTIwMjYzNjcyfV0=\" marker-end=\"url(#mermaid-0_flowchart-v2-pointEnd)\"></path></g><g class=\"edgeLabels\"><g class=\"edgeLabel\" transform=\"translate(69.359375, 136.4414520263672)\"><g class=\"label\" data-id=\"L_Internet_CF_0\" transform=\"translate(-61.359375, -12)\"><foreignObject width=\"122.71875\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>HTTPS *.jiun.dev</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(309.8203125, 362.4414520263672)\"><g class=\"label\" data-id=\"L_CF_K3S_0\" transform=\"translate(-24.1640625, -12)\"><foreignObject width=\"48.328125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>Tunnel</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(742.71484375, 136.4414520263672)\"><g class=\"label\" data-id=\"L_TS_GW_0\" transform=\"translate(-16.453125, -12)\"><foreignObject width=\"32.90625\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>VPN</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(621.01953125, 362.4414520263672)\"><g class=\"label\" data-id=\"L_GW_MON_0\" transform=\"translate(-36.828125, -12)\"><foreignObject width=\"73.65625\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>내부 프록시</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(864.41015625, 362.4414520263672)\"><g class=\"label\" data-id=\"L_GW_REG_0\" transform=\"translate(-36.828125, -12)\"><foreignObject width=\"73.65625\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>내부 프록시</p></span></div></foreignObject></g></g></g><g class=\"nodes\"><g class=\"node default\" id=\"flowchart-GW-0\" transform=\"translate(742.71484375, 274.4414520263672)\"><rect class=\"basic label-container\" style=\"\" x=\"-122.9296875\" y=\"-51\" width=\"245.859375\" height=\"102\"></rect><g class=\"label\" style=\"\" transform=\"translate(-92.9296875, -36)\"><rect></rect><foreignObject width=\"185.859375\" height=\"72\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Gateway (110)<br></br>192.168.0.10<br></br>Tailscale, CoreDNS, nginx</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-MON-1\" transform=\"translate(621.01953125, 475.4414520263672)\"><rect class=\"basic label-container\" style=\"\" x=\"-106.484375\" y=\"-51\" width=\"212.96875\" height=\"102\"></rect><g class=\"label\" style=\"\" transform=\"translate(-76.484375, -36)\"><rect></rect><foreignObject width=\"152.96875\" height=\"72\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Monitoring (120)<br></br>192.168.0.20<br></br>Prometheus, Grafana</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-REG-2\" transform=\"translate(864.41015625, 475.4414520263672)\"><rect class=\"basic label-container\" style=\"\" x=\"-86.90625\" y=\"-51\" width=\"173.8125\" height=\"102\"></rect><g class=\"label\" style=\"\" transform=\"translate(-56.90625, -36)\"><rect></rect><foreignObject width=\"113.8125\" height=\"72\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Registry (130)<br></br>192.168.0.30<br></br>Docker Registry</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-K3S-3\" transform=\"translate(309.8203125, 475.4414520263672)\"><rect class=\"basic label-container\" style=\"\" x=\"-106.4921875\" y=\"-51\" width=\"212.984375\" height=\"102\"></rect><g class=\"label\" style=\"\" transform=\"translate(-76.4921875, -36)\"><rect></rect><foreignObject width=\"152.984375\" height=\"72\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Kubernetes k3s (200)<br></br>192.168.0.66<br></br>12 cores, 24GB RAM</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-Internet-4\" transform=\"translate(69.359375, 53.720726013183594)\"><circle class=\"basic label-container\" style=\"\" r=\"34.6328125\" cx=\"0\" cy=\"0\"></circle><g class=\"label\" style=\"\" transform=\"translate(-27.1328125, -12)\"><rect></rect><foreignObject width=\"54.265625\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Internet</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-CF-5\" transform=\"translate(69.359375, 274.4414520263672)\"><path d=\"M0,10.3243322571177 a43.96875,10.3243322571177 0,0,0 87.9375,0 a43.96875,10.3243322571177 0,0,0 -87.9375,0 l0,73.3243322571177 a43.96875,10.3243322571177 0,0,0 87.9375,0 l0,-73.3243322571177\" class=\"basic label-container\" style=\"\" transform=\"translate(-43.96875, -46.986498385676555)\"></path><g class=\"label\" style=\"\" transform=\"translate(-36.46875, -14)\"><rect></rect><foreignObject width=\"72.9375\" height=\"48\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Cloudflare<br></br>Tunnel</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-TS-6\" transform=\"translate(742.71484375, 53.720726013183594)\"><path d=\"M0,9.480484208892682 a38.1796875,9.480484208892682 0,0,0 76.359375,0 a38.1796875,9.480484208892682 0,0,0 -76.359375,0 l0,72.48048420889268 a38.1796875,9.480484208892682 0,0,0 76.359375,0 l0,-72.48048420889268\" class=\"basic label-container\" style=\"\" transform=\"translate(-38.1796875, -45.72072631333902)\"></path><g class=\"label\" style=\"\" transform=\"translate(-30.6796875, -14)\"><rect></rect><foreignObject width=\"61.359375\" height=\"48\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Tailscale<br></br>Tailnet</p></span></div></foreignObject></g></g></g></g></g></svg></p>\n<h3 id=\"왜-이런-구조인가\">왜 이런 구조인가</h3>\n<p>처음에는 모든 것을 Docker Compose로 NAS에서 돌렸다. 간단하고 편했지만, 서비스가 늘어나면서 관리가 어려워졌고 NAS가 재부팅되면 모든 서비스가 함께 내려갔다.</p>\n<p>그 다음엔 Synology VMM 을 활용해서 가상 머신을 띄운 후 k8s로 관리했다. 하지만 Synology VMM의 성능과 안정성에 한계가 있었고, k8s를 제대로 활용하기 어려웠다.</p>\n<p>이번에 새로 NAS를 구입하면서 아예 Proxmox VE와 IaC 기반으로 새로운 환경을 구축했다.</p>\n<p>Proxmox로 마이그레이션하면서 역할별로 분리했다:</p>\n<ul>\n<li><strong>Gateway LXC</strong>: 네트워크 진입점. Tailscale Subnet Router로 내부망 접근을 담당하고, 내부 서비스들의 리버스 프록시 역할</li>\n<li><strong>Monitoring LXC</strong>: Prometheus + Grafana. 메트릭 수집과 대시보드</li>\n<li><strong>Registry LXC</strong>: Private Docker Registry. 내부에서만 접근 가능</li>\n<li><strong>k3s VM</strong>: 외부 공개 서비스는 Kubernetes에서 관리. Cloudflare Tunnel로 노출</li>\n</ul>\n<p>이렇게 분리하니 하나가 죽어도 다른 서비스에 영향이 없고, 필요한 리소스만 할당할 수 있어서 효율적이었다.</p>\n<hr>\n<h2 id=\"iac-구조-설계\">IaC 구조 설계</h2>\n<p>인프라를 코드로 관리하기 위해 Terraform과 Ansible을 조합했다. 역할 분담은 이렇다:</p>\n<table>\n<thead>\n<tr>\n<th>도구</th>\n<th>담당 영역</th>\n<th>예시</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>Terraform</strong></td>\n<td>인프라 프로비저닝</td>\n<td>LXC/VM 생성, 네트워크 설정, 디스크 할당</td>\n</tr>\n<tr>\n<td><strong>Ansible</strong></td>\n<td>설정 관리</td>\n<td>패키지 설치, 서비스 설정, 인증서 발급</td>\n</tr>\n</tbody>\n</table>\n<p>이 분리가 중요한 이유는, \"무엇을 만들 것인가\"와 \"어떻게 설정할 것인가\"가 다른 문제이기 때문이다. Terraform은 선언적으로 인프라 상태를 정의하고, Ansible은 그 위에서 실제 소프트웨어를 설치하고 설정한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">IaC/\n├── terraform/\n│   ├── environments/homelab/     # 환경별 변수\n│   └── modules/\n│       ├── lxc-base/             # 재사용 가능한 LXC 모듈\n│       └── vm-base/              # 재사용 가능한 VM 모듈\n├── ansible/\n│   ├── inventory/                # 호스트 정의\n│   ├── playbooks/                # 실행 단위\n│   └── roles/                    # 서비스별 역할\n│       ├── common/               # 공통 설정 (timezone, packages)\n│       ├── tailscale/            # VPN 설정\n│       ├── nginx/                # 리버스 프록시\n│       ├── prometheus/           # 메트릭 수집\n│       ├── grafana/              # 대시보드\n│       └── k3s/                  # Kubernetes\n├── kubernetes/                   # k8s 매니페스트\n│   ├── cloudflared/              # Cloudflare Tunnel\n│   └── apps/                     # 애플리케이션\n└── scripts/\n    └── deploy.sh                 # 통합 배포 스크립트</code></pre></div>\n<hr>\n<h2 id=\"terraform-인프라-정의\">Terraform: 인프라 정의</h2>\n<h3 id=\"lxc-모듈화\">LXC 모듈화</h3>\n<p>처음에는 각 LXC마다 별도의 Terraform 파일을 만들었다. 그런데 Gateway, Monitoring, Registry가 거의 비슷한 구조여서 중복이 많았다. 이를 모듈로 추출했다:</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token comment\"># modules/lxc-base/main.tf</span>\n<span class=\"token keyword\">resource <span class=\"token type variable\">\"proxmox_virtual_environment_container\"</span></span> <span class=\"token string\">\"lxc\"</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token property\">node_name</span>   <span class=\"token punctuation\">=</span> var.node_name\n  <span class=\"token property\">vm_id</span>       <span class=\"token punctuation\">=</span> var.vmid\n  <span class=\"token property\">description</span> <span class=\"token punctuation\">=</span> var.description\n\n  <span class=\"token keyword\">initialization</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">hostname</span> <span class=\"token punctuation\">=</span> var.hostname\n    <span class=\"token keyword\">ip_config</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">ipv4</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token property\">address</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"<span class=\"token interpolation\"><span class=\"token punctuation\">$</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">var</span><span class=\"token punctuation\">.</span><span class=\"token type variable\">ip_address</span><span class=\"token punctuation\">}</span></span>/24\"</span>\n        <span class=\"token property\">gateway</span> <span class=\"token punctuation\">=</span> var.gateway\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">cpu</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">cores</span> <span class=\"token punctuation\">=</span> var.cores\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">memory</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">dedicated</span> <span class=\"token punctuation\">=</span> var.memory\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">disk</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">datastore_id</span> <span class=\"token punctuation\">=</span> var.datastore\n    <span class=\"token property\">size</span>         <span class=\"token punctuation\">=</span> var.disk_size\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">network_interface</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">name</span>   <span class=\"token punctuation\">=</span> <span class=\"token string\">\"eth0\"</span>\n    <span class=\"token property\">bridge</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"vmbr0\"</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">operating_system</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">template_file_id</span> <span class=\"token punctuation\">=</span> var.template\n    <span class=\"token property\">type</span>             <span class=\"token punctuation\">=</span> <span class=\"token string\">\"debian\"</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이제 새 LXC를 추가할 때는 모듈을 호출하기만 하면 된다:</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token comment\"># environments/homelab/main.tf</span>\n<span class=\"token keyword\">module<span class=\"token type variable\"> \"gateway\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">source</span>      <span class=\"token punctuation\">=</span> <span class=\"token string\">\"../../modules/lxc-base\"</span>\n  <span class=\"token property\">vmid</span>        <span class=\"token punctuation\">=</span> <span class=\"token number\">110</span>\n  <span class=\"token property\">hostname</span>    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"gateway\"</span>\n  <span class=\"token property\">ip_address</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"192.168.0.10\"</span>\n  <span class=\"token property\">cores</span>       <span class=\"token punctuation\">=</span> <span class=\"token number\">2</span>\n  <span class=\"token property\">memory</span>      <span class=\"token punctuation\">=</span> <span class=\"token number\">2048</span>\n  <span class=\"token property\">disk_size</span>   <span class=\"token punctuation\">=</span> <span class=\"token number\">8</span>\n  <span class=\"token comment\"># ...</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">module<span class=\"token type variable\"> \"monitoring\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">source</span>      <span class=\"token punctuation\">=</span> <span class=\"token string\">\"../../modules/lxc-base\"</span>\n  <span class=\"token property\">vmid</span>        <span class=\"token punctuation\">=</span> <span class=\"token number\">120</span>\n  <span class=\"token property\">hostname</span>    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"monitoring\"</span>\n  <span class=\"token property\">ip_address</span>  <span class=\"token punctuation\">=</span> <span class=\"token string\">\"192.168.0.20\"</span>\n  <span class=\"token property\">cores</span>       <span class=\"token punctuation\">=</span> <span class=\"token number\">2</span>\n  <span class=\"token property\">memory</span>      <span class=\"token punctuation\">=</span> <span class=\"token number\">4096</span>\n  <span class=\"token property\">disk_size</span>   <span class=\"token punctuation\">=</span> <span class=\"token number\">20</span>\n  <span class=\"token comment\"># ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"상태-관리\">상태 관리</h3>\n<p>Terraform은 <code class=\"language-text\">terraform.tfstate</code> 파일로 현재 인프라 상태를 추적한다. 처음에는 로컬에 저장했는데, 여러 장소에서 작업하다 보니 상태 충돌이 발생했다. 결국 MinIO(S3 호환)를 NAS에 띄우고 원격 백엔드로 사용하게 되었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">terraform</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">backend<span class=\"token type variable\"> \"s3\" </span></span><span class=\"token punctuation\">{</span>\n    <span class=\"token property\">bucket</span>                      <span class=\"token punctuation\">=</span> <span class=\"token string\">\"terraform-state\"</span>\n    <span class=\"token property\">key</span>                         <span class=\"token punctuation\">=</span> <span class=\"token string\">\"homelab/terraform.tfstate\"</span>\n    <span class=\"token property\">endpoint</span>                    <span class=\"token punctuation\">=</span> <span class=\"token string\">\"https://minio.internal.jiun.dev\"</span>\n    <span class=\"token property\">skip_credentials_validation</span> <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token property\">skip_metadata_api_check</span>     <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n    <span class=\"token property\">force_path_style</span>            <span class=\"token punctuation\">=</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<hr>\n<h2 id=\"ansible-설정-관리\">Ansible: 설정 관리</h2>\n<h3 id=\"역할-기반-구조\">역할 기반 구조</h3>\n<p>Ansible의 장점은 역할(Role)로 설정을 캡슐화할 수 있다는 것이다. 예를 들어 <code class=\"language-text\">tailscale</code> 역할은 어떤 호스트에서든 Tailscale을 설치하고 설정한다:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># roles/tailscale/tasks/main.yml</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Install Tailscale\n  <span class=\"token key atrule\">shell</span><span class=\"token punctuation\">:</span> curl <span class=\"token punctuation\">-</span>fsSL https<span class=\"token punctuation\">:</span>//tailscale.com/install.sh <span class=\"token punctuation\">|</span> sh\n  <span class=\"token key atrule\">args</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">creates</span><span class=\"token punctuation\">:</span> /usr/bin/tailscale\n\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Start Tailscale\n  <span class=\"token key atrule\">command</span><span class=\"token punctuation\">:</span> tailscale up <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>authkey=<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> tailscale_authkey <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span> <span class=\"token punctuation\">-</span><span class=\"token punctuation\">-</span>advertise<span class=\"token punctuation\">-</span>routes=<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> tailscale_routes <span class=\"token punctuation\">|</span> default('') <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n  <span class=\"token key atrule\">when</span><span class=\"token punctuation\">:</span> tailscale_authkey is defined</code></pre></div>\n<p>플레이북에서는 호스트별로 역할을 할당한다:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># playbooks/site.yml</span>\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span> gateway\n  <span class=\"token key atrule\">roles</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> common\n    <span class=\"token punctuation\">-</span> tailscale\n    <span class=\"token punctuation\">-</span> coredns\n    <span class=\"token punctuation\">-</span> nginx\n    <span class=\"token punctuation\">-</span> certbot\n\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span> monitoring\n  <span class=\"token key atrule\">roles</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> common\n    <span class=\"token punctuation\">-</span> prometheus\n    <span class=\"token punctuation\">-</span> grafana\n\n<span class=\"token punctuation\">-</span> <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span> registry\n  <span class=\"token key atrule\">roles</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> common\n    <span class=\"token punctuation\">-</span> docker<span class=\"token punctuation\">-</span>registry</code></pre></div>\n<h3 id=\"민감-정보-관리\">민감 정보 관리</h3>\n<p>API 토큰, 비밀번호 같은 민감 정보는 Ansible Vault로 암호화했다:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token comment\"># 암호화</span>\nansible-vault encrypt ansible/inventory/group_vars/all/secrets.yml\n\n<span class=\"token comment\"># 실행 시</span>\nansible-playbook playbooks/site.yml --ask-vault-pass</code></pre></div>\n<p>처음에는 귀찮아서 평문으로 관리했는데, Git에 실수로 커밋할 뻔한 적이 있어서 바로 Vault로 전환했다.</p>\n<hr>\n<h2 id=\"배포-워크플로우\">배포 워크플로우</h2>\n<p>전체 배포는 하나의 스크립트로 실행한다:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\"><span class=\"token shebang important\">#!/bin/bash</span>\n<span class=\"token comment\"># scripts/deploy.sh</span>\n\n<span class=\"token builtin class-name\">set</span> <span class=\"token parameter variable\">-e</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"=== Terraform Apply ===\"</span>\n<span class=\"token builtin class-name\">cd</span> terraform/environments/homelab\nterraform init\nterraform apply -auto-approve\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"=== Wait for LXC/VM to be ready ===\"</span>\n<span class=\"token function\">sleep</span> <span class=\"token number\">30</span>\n\n<span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"=== Ansible Playbook ===\"</span>\n<span class=\"token builtin class-name\">cd</span> <span class=\"token punctuation\">..</span>/<span class=\"token punctuation\">..</span>/<span class=\"token punctuation\">..</span>/ansible\nansible-playbook playbooks/site.yml <span class=\"token parameter variable\">-i</span> inventory/hosts.yml</code></pre></div>\n<p>새 서비스를 추가할 때의 흐름은 이렇다:</p>\n<ol>\n<li><code class=\"language-text\">terraform/environments/homelab/main.tf</code>에 LXC/VM 정의 추가</li>\n<li><code class=\"language-text\">ansible/roles/</code>에 새 역할 생성</li>\n<li><code class=\"language-text\">ansible/playbooks/site.yml</code>에 역할 할당</li>\n<li><code class=\"language-text\">./scripts/deploy.sh</code> 실행</li>\n</ol>\n<p>처음 설정할 때는 시간이 걸리지만, 한 번 구조를 잡아두니 새 서비스 추가가 정말 빠르고 일관적이 되었다.</p>\n<hr>\n<h2 id=\"gitops-코드-푸시만으로-배포까지\">GitOps: 코드 푸시만으로 배포까지</h2>\n<p>로컬에서 스크립트를 실행하는 방식도 나쁘지 않았지만, 결국 \"코드를 푸시하면 자동으로 배포되는\" GitOps를 도입하게 되었다. 특히 Kubernetes 위에서 돌아가는 서비스들은 ArgoCD와 Gitea를 활용해서 완전 자동화했다.</p>\n<h3 id=\"왜-github--gitea-조합인가\">왜 GitHub + Gitea 조합인가</h3>\n<p>처음에는 GitHub Actions만 쓰려고 했다. 그런데 Private Docker Registry에 이미지를 푸시하려면 GitHub에서 내부 네트워크로 접근해야 하는 문제가 있었다. Tailscale을 GitHub Actions runner에 붙이는 방법도 있지만, 그보다는 내부에 CI를 두는 게 깔끔해 보였다.</p>\n<p>그래서 Gitea를 Self-hosted로 띄우고, GitHub 레포를 미러링하는 구조를 만들었다:</p>\n<p><svg id=\"mermaid-1\" width=\"100%\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" class=\"flowchart\" style=\"max-width: 1180.734375px;\" viewBox=\"0 0 1180.734375 373\" role=\"graphics-document document\" aria-roledescription=\"flowchart-v2\"><style>#mermaid-1{font-family:inherit;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-1 .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-1 .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-1 .error-icon{fill:#552222;}#mermaid-1 .error-text{fill:#552222;stroke:#552222;}#mermaid-1 .edge-thickness-normal{stroke-width:1px;}#mermaid-1 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-1 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-1 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-1 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-1 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-1 .marker{fill:#333333;stroke:#333333;}#mermaid-1 .marker.cross{stroke:#333333;}#mermaid-1 svg{font-family:inherit;font-size:16px;}#mermaid-1 p{margin:0;}#mermaid-1 .label{font-family:inherit;color:#333;}#mermaid-1 .cluster-label text{fill:#333;}#mermaid-1 .cluster-label span{color:#333;}#mermaid-1 .cluster-label span p{background-color:transparent;}#mermaid-1 .label text,#mermaid-1 span{fill:#333;color:#333;}#mermaid-1 .node rect,#mermaid-1 .node circle,#mermaid-1 .node ellipse,#mermaid-1 .node polygon,#mermaid-1 .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-1 .rough-node .label text,#mermaid-1 .node .label text,#mermaid-1 .image-shape .label,#mermaid-1 .icon-shape .label{text-anchor:middle;}#mermaid-1 .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-1 .rough-node .label,#mermaid-1 .node .label,#mermaid-1 .image-shape .label,#mermaid-1 .icon-shape .label{text-align:center;}#mermaid-1 .node.clickable{cursor:pointer;}#mermaid-1 .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#mermaid-1 .arrowheadPath{fill:#333333;}#mermaid-1 .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-1 .flowchart-link{stroke:#333333;fill:none;}#mermaid-1 .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#mermaid-1 .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#mermaid-1 .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#mermaid-1 .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#mermaid-1 .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-1 .cluster text{fill:#333;}#mermaid-1 .cluster span{color:#333;}#mermaid-1 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:inherit;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-1 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#mermaid-1 rect.text{fill:none;stroke-width:0;}#mermaid-1 .icon-shape,#mermaid-1 .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#mermaid-1 .icon-shape p,#mermaid-1 .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#mermaid-1 .icon-shape rect,#mermaid-1 .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#mermaid-1 .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#mermaid-1 .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#mermaid-1 :root{--mermaid-font-family:arial,sans-serif;}</style><g><marker id=\"mermaid-1_flowchart-v2-pointEnd\" class=\"marker flowchart-v2\" viewBox=\"0 0 10 10\" refX=\"5\" refY=\"5\" markerUnits=\"userSpaceOnUse\" markerWidth=\"8\" markerHeight=\"8\" orient=\"auto\"><path d=\"M 0 0 L 10 5 L 0 10 z\" class=\"arrowMarkerPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path></marker><marker id=\"mermaid-1_flowchart-v2-pointStart\" class=\"marker flowchart-v2\" viewBox=\"0 0 10 10\" refX=\"4.5\" refY=\"5\" markerUnits=\"userSpaceOnUse\" markerWidth=\"8\" markerHeight=\"8\" orient=\"auto\"><path d=\"M 0 5 L 10 10 L 10 0 z\" class=\"arrowMarkerPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path></marker><marker id=\"mermaid-1_flowchart-v2-circleEnd\" class=\"marker flowchart-v2\" viewBox=\"0 0 10 10\" refX=\"11\" refY=\"5\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" markerHeight=\"11\" orient=\"auto\"><circle cx=\"5\" cy=\"5\" r=\"5\" class=\"arrowMarkerPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></circle></marker><marker id=\"mermaid-1_flowchart-v2-circleStart\" class=\"marker flowchart-v2\" viewBox=\"0 0 10 10\" refX=\"-1\" refY=\"5\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" markerHeight=\"11\" orient=\"auto\"><circle cx=\"5\" cy=\"5\" r=\"5\" class=\"arrowMarkerPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></circle></marker><marker id=\"mermaid-1_flowchart-v2-crossEnd\" class=\"marker cross flowchart-v2\" viewBox=\"0 0 11 11\" refX=\"12\" refY=\"5.2\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" markerHeight=\"11\" orient=\"auto\"><path d=\"M 1,1 l 9,9 M 10,1 l -9,9\" class=\"arrowMarkerPath\" style=\"stroke-width: 2; stroke-dasharray: 1, 0;\"></path></marker><marker id=\"mermaid-1_flowchart-v2-crossStart\" class=\"marker cross flowchart-v2\" viewBox=\"0 0 11 11\" refX=\"-1\" refY=\"5.2\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" markerHeight=\"11\" orient=\"auto\"><path d=\"M 1,1 l 9,9 M 10,1 l -9,9\" class=\"arrowMarkerPath\" style=\"stroke-width: 2; stroke-dasharray: 1, 0;\"></path></marker><g class=\"root\"><g class=\"clusters\"><g class=\"cluster\" id=\"K8s\" data-look=\"classic\"><rect style=\"\" x=\"346.78125\" y=\"8\" width=\"489.078125\" height=\"124\"></rect><g class=\"cluster-label\" transform=\"translate(550.3984375, 8)\"><foreignObject width=\"81.84375\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Kubernetes</p></span></div></foreignObject></g></g><g class=\"cluster\" id=\"Internal\" data-look=\"classic\"><rect style=\"\" x=\"346.78125\" y=\"152\" width=\"825.953125\" height=\"213\"></rect><g class=\"cluster-label\" transform=\"translate(694.84375, 152)\"><foreignObject width=\"129.828125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Internal (Tailscale)</p></span></div></foreignObject></g></g><g class=\"cluster\" id=\"External\" data-look=\"classic\"><rect style=\"\" x=\"8\" y=\"19\" width=\"181.171875\" height=\"340\"></rect><g class=\"cluster-label\" transform=\"translate(69.234375, 19)\"><foreignObject width=\"58.703125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>External</p></span></div></foreignObject></g></g></g><g class=\"edgePaths\"><path d=\"M164.172,226L168.339,226C172.505,226,180.839,226,198.139,226C215.44,226,241.708,226,267.977,226C294.245,226,320.513,226,344.453,226C368.393,226,390.005,226,400.811,226L411.617,226\" id=\"L_GH_GT_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_GH_GT_0\" data-points=\"W3sieCI6MTY0LjE3MTg3NSwieSI6MjI2fSx7IngiOjE4OS4xNzE4NzUsInkiOjIyNn0seyJ4IjoyNjcuOTc2NTYyNSwieSI6MjI2fSx7IngiOjM0Ni43ODEyNSwieSI6MjI2fSx7IngiOjQxNS42MTcxODc1LCJ5IjoyMjZ9XQ==\" marker-end=\"url(#mermaid-1_flowchart-v2-pointEnd)\"></path><path d=\"M517.383,226L532.635,226C547.888,226,578.393,226,600.972,228.876C623.551,231.752,638.203,237.504,645.529,240.38L652.855,243.256\" id=\"L_GT_GA_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_GT_GA_0\" data-points=\"W3sieCI6NTE3LjM4MjgxMjUsInkiOjIyNn0seyJ4Ijo2MDguODk4NDM3NSwieSI6MjI2fSx7IngiOjY1Ni41NzgxMjUsInkiOjI0NC43MTczNDM2ODE1NDIyMn1d\" marker-end=\"url(#mermaid-1_flowchart-v2-pointEnd)\"></path><path d=\"M810.859,275L815.026,275C819.193,275,827.526,275,843.198,275C858.87,275,881.88,275,904.224,275C926.568,275,948.245,275,959.083,275L969.922,275\" id=\"L_GA_REG_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_GA_REG_0\" data-points=\"W3sieCI6ODEwLjg1OTM3NSwieSI6Mjc1fSx7IngiOjgzNS44NTkzNzUsInkiOjI3NX0seyJ4Ijo5MDQuODkwNjI1LCJ5IjoyNzV9LHsieCI6OTczLjkyMTg3NSwieSI6Mjc1fV0=\" marker-end=\"url(#mermaid-1_flowchart-v2-pointEnd)\"></path><path d=\"M656.578,297.866L648.632,300.222C640.685,302.578,624.792,307.289,593.112,309.644C561.432,312,513.966,312,470.28,312C426.594,312,386.688,312,353.6,312C320.513,312,294.245,312,267.977,312C241.708,312,215.44,312,194.538,304.626C173.637,297.251,158.102,282.503,150.334,275.128L142.567,267.754\" id=\"L_GA_GH_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_GA_GH_0\" data-points=\"W3sieCI6NjU2LjU3ODEyNSwieSI6Mjk3Ljg2NjQ5NTU4NzQwNjl9LHsieCI6NjA4Ljg5ODQzNzUsInkiOjMxMn0seyJ4Ijo0NjYuNSwieSI6MzEyfSx7IngiOjM0Ni43ODEyNSwieSI6MzEyfSx7IngiOjI2Ny45NzY1NjI1LCJ5IjozMTJ9LHsieCI6MTg5LjE3MTg3NSwieSI6MzEyfSx7IngiOjEzOS42NjU2MDY4MzEzOTUzNCwieSI6MjY1fV0=\" marker-end=\"url(#mermaid-1_flowchart-v2-pointEnd)\"></path><path d=\"M121.232,187L132.556,167.5C143.879,148,166.525,109,190.983,89.5C215.44,70,241.708,70,267.977,70C294.245,70,320.513,70,343.191,70C365.87,70,384.958,70,394.503,70L404.047,70\" id=\"L_GH_ARGO_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_GH_ARGO_0\" data-points=\"W3sieCI6MTIxLjIzMjQyMTg3NSwieSI6MTg3fSx7IngiOjE4OS4xNzE4NzUsInkiOjcwfSx7IngiOjI2Ny45NzY1NjI1LCJ5Ijo3MH0seyJ4IjozNDYuNzgxMjUsInkiOjcwfSx7IngiOjQwOC4wNDY4NzUsInkiOjcwfV0=\" marker-end=\"url(#mermaid-1_flowchart-v2-pointEnd)\"></path><path d=\"M524.953,70L538.944,70C552.935,70,580.917,70,602.93,70C624.943,70,640.987,70,649.009,70L657.031,70\" id=\"L_ARGO_DEPLOY_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_ARGO_DEPLOY_0\" data-points=\"W3sieCI6NTI0Ljk1MzEyNSwieSI6NzB9LHsieCI6NjA4Ljg5ODQzNzUsInkiOjcwfSx7IngiOjY2MS4wMzEyNSwieSI6NzB9XQ==\" marker-end=\"url(#mermaid-1_flowchart-v2-pointEnd)\"></path></g><g class=\"edgeLabels\"><g class=\"edgeLabel\" transform=\"translate(267.9765625, 226)\"><g class=\"label\" data-id=\"L_GH_GT_0\" transform=\"translate(-51.59375, -12)\"><foreignObject width=\"103.1875\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>webhook push</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(608.8984375, 226)\"><g class=\"label\" data-id=\"L_GT_GA_0\" transform=\"translate(-22.6796875, -12)\"><foreignObject width=\"45.359375\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>trigger</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(904.890625, 275)\"><g class=\"label\" data-id=\"L_GA_REG_0\" transform=\"translate(-44.03125, -12)\"><foreignObject width=\"88.0625\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>build &#x26; push</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(466.5, 312)\"><g class=\"label\" data-id=\"L_GA_GH_0\" transform=\"translate(-94.71875, -12)\"><foreignObject width=\"189.4375\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>update kustomization.yaml</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(267.9765625, 70)\"><g class=\"label\" data-id=\"L_GH_ARGO_0\" transform=\"translate(-53.8046875, -12)\"><foreignObject width=\"107.609375\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>watch IaC repo</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(608.8984375, 70)\"><g class=\"label\" data-id=\"L_ARGO_DEPLOY_0\" transform=\"translate(-16.453125, -12)\"><foreignObject width=\"32.90625\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>sync</p></span></div></foreignObject></g></g></g><g class=\"nodes\"><g class=\"node default\" id=\"flowchart-GH-0\" transform=\"translate(98.5859375, 226)\"><rect class=\"basic label-container\" style=\"\" x=\"-65.5859375\" y=\"-39\" width=\"131.171875\" height=\"78\"></rect><g class=\"label\" style=\"\" transform=\"translate(-35.5859375, -24)\"><rect></rect><foreignObject width=\"71.171875\" height=\"48\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>GitHub<br></br>App Repo</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-GT-1\" transform=\"translate(466.5, 226)\"><rect class=\"basic label-container\" style=\"\" x=\"-50.8828125\" y=\"-39\" width=\"101.765625\" height=\"78\"></rect><g class=\"label\" style=\"\" transform=\"translate(-20.8828125, -24)\"><rect></rect><foreignObject width=\"41.765625\" height=\"48\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Gitea<br></br>Mirror</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-GA-2\" transform=\"translate(733.71875, 275)\"><rect class=\"basic label-container\" style=\"\" x=\"-77.140625\" y=\"-39\" width=\"154.28125\" height=\"78\"></rect><g class=\"label\" style=\"\" transform=\"translate(-47.140625, -24)\"><rect></rect><foreignObject width=\"94.28125\" height=\"48\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Gitea Actions<br></br>CI Runner</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-REG-3\" transform=\"translate(1060.828125, 275)\"><rect class=\"basic label-container\" style=\"\" x=\"-86.90625\" y=\"-39\" width=\"173.8125\" height=\"78\"></rect><g class=\"label\" style=\"\" transform=\"translate(-56.90625, -24)\"><rect></rect><foreignObject width=\"113.8125\" height=\"48\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Docker Registry<br></br>registry.jiun.dev</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-ARGO-4\" transform=\"translate(466.5, 70)\"><rect class=\"basic label-container\" style=\"\" x=\"-58.453125\" y=\"-27\" width=\"116.90625\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-28.453125, -12)\"><rect></rect><foreignObject width=\"56.90625\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>ArgoCD</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-DEPLOY-5\" transform=\"translate(733.71875, 70)\"><rect class=\"basic label-container\" style=\"\" x=\"-72.6875\" y=\"-27\" width=\"145.375\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-42.6875, -12)\"><rect></rect><foreignObject width=\"85.375\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Deployment</p></span></div></foreignObject></g></g></g></g></g></svg></p>\n<p>개발할 때는 GitHub에 푸시하면 끝이다. webhook이 Gitea로 전달되고, Gitea Actions가 이미지를 빌드해서 내부 Registry에 푸시한다. 그리고 IaC 레포의 <code class=\"language-text\">kustomization.yaml</code>에서 이미지 태그를 업데이트하면, ArgoCD가 변경을 감지하고 Kubernetes에 배포한다.</p>\n<h3 id=\"app-repo와-config-repo-분리\">App Repo와 Config Repo 분리</h3>\n<p>GitOps의 핵심은 \"애플리케이션 코드\"와 \"배포 설정\"을 분리하는 것이다. 애플리케이션 레포에는 소스 코드와 Dockerfile만 있고, 실제 Kubernetes 매니페스트는 IaC 레포에 둔다:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\"># App Repo (예: claude-code-cloud)\n├── src/                    # 애플리케이션 소스\n├── Dockerfile              # 이미지 빌드\n└── .gitea/workflows/\n    └── deploy.yml          # CI 파이프라인\n\n# IaC Repo\n└── kubernetes/apps/claude-code-cloud/\n    ├── application.yaml    # ArgoCD Application\n    ├── kustomization.yaml  # 이미지 태그 관리\n    ├── deployment.yaml\n    ├── service.yaml\n    └── ingress.yaml</code></pre></div>\n<p>이렇게 분리하면 좋은 점이 있다. 애플리케이션 개발자는 코드만 신경 쓰면 되고, 인프라 설정은 IaC 레포에서 한 곳에서 관리된다. 롤백도 간단하다. <code class=\"language-text\">kustomization.yaml</code>의 <code class=\"language-text\">newTag</code>를 이전 커밋 해시로 바꾸면 끝이다.</p>\n<h3 id=\"ci-파이프라인\">CI 파이프라인</h3>\n<p>Gitea Actions의 워크플로우는 이렇게 생겼다:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build and Deploy\n<span class=\"token key atrule\">on</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">branches</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>main<span class=\"token punctuation\">]</span>\n\n<span class=\"token key atrule\">jobs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">build</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">runs-on</span><span class=\"token punctuation\">:</span> ubuntu<span class=\"token punctuation\">-</span>latest\n    <span class=\"token key atrule\">steps</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> actions/checkout@v4\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build and push image\n        <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> docker/build<span class=\"token punctuation\">-</span>push<span class=\"token punctuation\">-</span>action@v6\n        <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n          <span class=\"token key atrule\">tags</span><span class=\"token punctuation\">:</span> registry.jiun.dev/$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> env.IMAGE_NAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">:</span>$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.sha <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Update IaC repo\n        <span class=\"token key atrule\">run</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">|</span><span class=\"token scalar string\">\n          cd iac/kubernetes/apps/${{ env.APP_NAME }}\n          sed -i \"s/newTag: .*/newTag: ${{ github.sha }}/\" kustomization.yaml\n          git commit -am \"chore: update image tag\"\n          git push</span></code></pre></div>\n<p>이미지 태그로 Git 커밋 해시를 사용하는 게 포인트다. 어떤 코드가 배포되었는지 추적하기 쉽고, 태그 충돌도 없다.</p>\n<h3 id=\"argocd-설정\">ArgoCD 설정</h3>\n<p>ArgoCD Application은 이렇게 정의한다:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">apiVersion</span><span class=\"token punctuation\">:</span> argoproj.io/v1alpha1\n<span class=\"token key atrule\">kind</span><span class=\"token punctuation\">:</span> Application\n<span class=\"token key atrule\">metadata</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> claude<span class=\"token punctuation\">-</span>code<span class=\"token punctuation\">-</span>cloud\n  <span class=\"token key atrule\">namespace</span><span class=\"token punctuation\">:</span> argocd\n<span class=\"token key atrule\">spec</span><span class=\"token punctuation\">:</span>\n  <span class=\"token key atrule\">source</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">repoURL</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//github.com/jiunbae/IaC.git\n    <span class=\"token key atrule\">path</span><span class=\"token punctuation\">:</span> kubernetes/apps/claude<span class=\"token punctuation\">-</span>code<span class=\"token punctuation\">-</span>cloud\n  <span class=\"token key atrule\">destination</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">server</span><span class=\"token punctuation\">:</span> https<span class=\"token punctuation\">:</span>//kubernetes.default.svc\n  <span class=\"token key atrule\">syncPolicy</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">automated</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">prune</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span> <span class=\"token comment\"># 삭제된 리소스 정리</span>\n      <span class=\"token key atrule\">selfHeal</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span> <span class=\"token comment\"># drift 자동 복구</span></code></pre></div>\n<p><code class=\"language-text\">automated</code> 설정이 핵심이다. IaC 레포에 변경이 생기면 자동으로 sync하고, 누군가 kubectl로 직접 수정해도 원래 상태로 되돌린다. \"Git에 있는 게 진실\"이라는 GitOps 원칙을 강제하는 셈이다.</p>\n<h3 id=\"private-docker-registry\">Private Docker Registry</h3>\n<p>Docker Hub 대신 내부 Registry를 사용하는 이유:</p>\n<ul>\n<li><strong>비공개 이미지</strong>: 개인 프로젝트는 공개하고 싶지 않음</li>\n<li><strong>Pull 제한 없음</strong>: Docker Hub 무료 플랜의 rate limit 회피</li>\n<li><strong>네트워크 비용 절약</strong>: 빌드와 배포가 모두 내부에서 이뤄짐</li>\n</ul>\n<p>Registry는 LXC 컨테이너에 바이너리로 직접 설치했다. Docker-in-LXC보다 단순하고 리소스 오버헤드가 없다:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># Ansible로 Registry 설정</span>\n<span class=\"token key atrule\">registry_version</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"2.8.3\"</span>\n<span class=\"token key atrule\">registry_listen_port</span><span class=\"token punctuation\">:</span> <span class=\"token number\">5000</span>\n<span class=\"token key atrule\">registry_storage_path</span><span class=\"token punctuation\">:</span> /var/lib/docker<span class=\"token punctuation\">-</span>registry</code></pre></div>\n<p>접근 제어는 네트워크 레벨에서 처리한다. Tailscale 내부에서만 접근 가능하고, 외부 노출 없음. 개인 홈랩에서는 이 정도면 충분하다.</p>\n<h3 id=\"이미지-캐싱\">이미지 캐싱</h3>\n<p>빌드 시간을 줄이기 위해 Registry에 빌드 캐시를 저장한다:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Build and push\n  <span class=\"token key atrule\">uses</span><span class=\"token punctuation\">:</span> docker/build<span class=\"token punctuation\">-</span>push<span class=\"token punctuation\">-</span>action@v6\n  <span class=\"token key atrule\">with</span><span class=\"token punctuation\">:</span>\n    <span class=\"token key atrule\">push</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span>\n    <span class=\"token key atrule\">tags</span><span class=\"token punctuation\">:</span> registry.jiun.dev/$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> env.IMAGE_NAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">:</span>$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> github.sha <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span>\n    <span class=\"token key atrule\">cache-from</span><span class=\"token punctuation\">:</span> type=registry<span class=\"token punctuation\">,</span>ref=registry.jiun.dev/$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> env.IMAGE_NAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">:</span>buildcache\n    <span class=\"token key atrule\">cache-to</span><span class=\"token punctuation\">:</span> type=registry<span class=\"token punctuation\">,</span>ref=registry.jiun.dev/$<span class=\"token punctuation\">{</span><span class=\"token punctuation\">{</span> env.IMAGE_NAME <span class=\"token punctuation\">}</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">:</span>buildcache<span class=\"token punctuation\">,</span>mode=max</code></pre></div>\n<p>효과:</p>\n<ul>\n<li><strong>첫 빌드</strong>: 약 5분 (의존성 설치 포함)</li>\n<li><strong>캐시 있을 때</strong>: 약 30초 (변경된 레이어만)</li>\n</ul>\n<h3 id=\"서비스를-추가할-땐\">서비스를 추가할 땐</h3>\n<p>새 서비스를 추가할 때 체크리스트:</p>\n<ol>\n<li>GitHub에 App Repo 생성</li>\n<li>Gitea에서 mirror 설정</li>\n<li><code class=\"language-text\">.gitea/workflows/deploy.yml</code> 작성</li>\n<li>IaC 레포에 <code class=\"language-text\">kubernetes/apps/{app-name}/</code> 디렉토리 생성</li>\n<li>ArgoCD Application 등록</li>\n<li>Kubernetes secrets 수동 생성 (민감 정보는 Git에 넣지 않음)</li>\n</ol>\n<p>처음에는 복잡해 보이지만, 한 번 익숙해지면 새 서비스 배포가 정말 빠르다. 기존 서비스의 매니페스트를 복사해서 약간만 수정하면 되니까.</p>\n<hr>\n<h2 id=\"monitoring-prometheus--grafana\">Monitoring: Prometheus + Grafana</h2>\n<p>인프라를 코드로 관리하는 것만으로는 \"지금 잘 돌아가고 있는지\"를 알 수 없다. SSH로 <code class=\"language-text\">htop</code> 띄우는 건 원시적이고, 여러 노드를 한 번에 보기 어렵다.</p>\n<h3 id=\"모니터링-아키텍처\">모니터링 아키텍처</h3>\n<p><svg id=\"mermaid-2\" width=\"100%\" xmlns=\"http://www.w3.org/2000/svg\" xmlns:xlink=\"http://www.w3.org/1999/xlink\" class=\"flowchart\" style=\"max-width: 734.734375px;\" viewBox=\"0 0 734.734375 494\" role=\"graphics-document document\" aria-roledescription=\"flowchart-v2\"><style>#mermaid-2{font-family:inherit;font-size:16px;fill:#333;}@keyframes edge-animation-frame{from{stroke-dashoffset:0;}}@keyframes dash{to{stroke-dashoffset:0;}}#mermaid-2 .edge-animation-slow{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 50s linear infinite;stroke-linecap:round;}#mermaid-2 .edge-animation-fast{stroke-dasharray:9,5!important;stroke-dashoffset:900;animation:dash 20s linear infinite;stroke-linecap:round;}#mermaid-2 .error-icon{fill:#552222;}#mermaid-2 .error-text{fill:#552222;stroke:#552222;}#mermaid-2 .edge-thickness-normal{stroke-width:1px;}#mermaid-2 .edge-thickness-thick{stroke-width:3.5px;}#mermaid-2 .edge-pattern-solid{stroke-dasharray:0;}#mermaid-2 .edge-thickness-invisible{stroke-width:0;fill:none;}#mermaid-2 .edge-pattern-dashed{stroke-dasharray:3;}#mermaid-2 .edge-pattern-dotted{stroke-dasharray:2;}#mermaid-2 .marker{fill:#333333;stroke:#333333;}#mermaid-2 .marker.cross{stroke:#333333;}#mermaid-2 svg{font-family:inherit;font-size:16px;}#mermaid-2 p{margin:0;}#mermaid-2 .label{font-family:inherit;color:#333;}#mermaid-2 .cluster-label text{fill:#333;}#mermaid-2 .cluster-label span{color:#333;}#mermaid-2 .cluster-label span p{background-color:transparent;}#mermaid-2 .label text,#mermaid-2 span{fill:#333;color:#333;}#mermaid-2 .node rect,#mermaid-2 .node circle,#mermaid-2 .node ellipse,#mermaid-2 .node polygon,#mermaid-2 .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#mermaid-2 .rough-node .label text,#mermaid-2 .node .label text,#mermaid-2 .image-shape .label,#mermaid-2 .icon-shape .label{text-anchor:middle;}#mermaid-2 .node .katex path{fill:#000;stroke:#000;stroke-width:1px;}#mermaid-2 .rough-node .label,#mermaid-2 .node .label,#mermaid-2 .image-shape .label,#mermaid-2 .icon-shape .label{text-align:center;}#mermaid-2 .node.clickable{cursor:pointer;}#mermaid-2 .root .anchor path{fill:#333333!important;stroke-width:0;stroke:#333333;}#mermaid-2 .arrowheadPath{fill:#333333;}#mermaid-2 .edgePath .path{stroke:#333333;stroke-width:2.0px;}#mermaid-2 .flowchart-link{stroke:#333333;fill:none;}#mermaid-2 .edgeLabel{background-color:rgba(232,232,232, 0.8);text-align:center;}#mermaid-2 .edgeLabel p{background-color:rgba(232,232,232, 0.8);}#mermaid-2 .edgeLabel rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#mermaid-2 .labelBkg{background-color:rgba(232, 232, 232, 0.5);}#mermaid-2 .cluster rect{fill:#ffffde;stroke:#aaaa33;stroke-width:1px;}#mermaid-2 .cluster text{fill:#333;}#mermaid-2 .cluster span{color:#333;}#mermaid-2 div.mermaidTooltip{position:absolute;text-align:center;max-width:200px;padding:2px;font-family:inherit;font-size:12px;background:hsl(80, 100%, 96.2745098039%);border:1px solid #aaaa33;border-radius:2px;pointer-events:none;z-index:100;}#mermaid-2 .flowchartTitleText{text-anchor:middle;font-size:18px;fill:#333;}#mermaid-2 rect.text{fill:none;stroke-width:0;}#mermaid-2 .icon-shape,#mermaid-2 .image-shape{background-color:rgba(232,232,232, 0.8);text-align:center;}#mermaid-2 .icon-shape p,#mermaid-2 .image-shape p{background-color:rgba(232,232,232, 0.8);padding:2px;}#mermaid-2 .icon-shape rect,#mermaid-2 .image-shape rect{opacity:0.5;background-color:rgba(232,232,232, 0.8);fill:rgba(232,232,232, 0.8);}#mermaid-2 .label-icon{display:inline-block;height:1em;overflow:visible;vertical-align:-0.125em;}#mermaid-2 .node .label-icon path{fill:currentColor;stroke:revert;stroke-width:revert;}#mermaid-2 :root{--mermaid-font-family:arial,sans-serif;}</style><g><marker id=\"mermaid-2_flowchart-v2-pointEnd\" class=\"marker flowchart-v2\" viewBox=\"0 0 10 10\" refX=\"5\" refY=\"5\" markerUnits=\"userSpaceOnUse\" markerWidth=\"8\" markerHeight=\"8\" orient=\"auto\"><path d=\"M 0 0 L 10 5 L 0 10 z\" class=\"arrowMarkerPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path></marker><marker id=\"mermaid-2_flowchart-v2-pointStart\" class=\"marker flowchart-v2\" viewBox=\"0 0 10 10\" refX=\"4.5\" refY=\"5\" markerUnits=\"userSpaceOnUse\" markerWidth=\"8\" markerHeight=\"8\" orient=\"auto\"><path d=\"M 0 5 L 10 10 L 10 0 z\" class=\"arrowMarkerPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></path></marker><marker id=\"mermaid-2_flowchart-v2-circleEnd\" class=\"marker flowchart-v2\" viewBox=\"0 0 10 10\" refX=\"11\" refY=\"5\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" markerHeight=\"11\" orient=\"auto\"><circle cx=\"5\" cy=\"5\" r=\"5\" class=\"arrowMarkerPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></circle></marker><marker id=\"mermaid-2_flowchart-v2-circleStart\" class=\"marker flowchart-v2\" viewBox=\"0 0 10 10\" refX=\"-1\" refY=\"5\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" markerHeight=\"11\" orient=\"auto\"><circle cx=\"5\" cy=\"5\" r=\"5\" class=\"arrowMarkerPath\" style=\"stroke-width: 1; stroke-dasharray: 1, 0;\"></circle></marker><marker id=\"mermaid-2_flowchart-v2-crossEnd\" class=\"marker cross flowchart-v2\" viewBox=\"0 0 11 11\" refX=\"12\" refY=\"5.2\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" markerHeight=\"11\" orient=\"auto\"><path d=\"M 1,1 l 9,9 M 10,1 l -9,9\" class=\"arrowMarkerPath\" style=\"stroke-width: 2; stroke-dasharray: 1, 0;\"></path></marker><marker id=\"mermaid-2_flowchart-v2-crossStart\" class=\"marker cross flowchart-v2\" viewBox=\"0 0 11 11\" refX=\"-1\" refY=\"5.2\" markerUnits=\"userSpaceOnUse\" markerWidth=\"11\" markerHeight=\"11\" orient=\"auto\"><path d=\"M 1,1 l 9,9 M 10,1 l -9,9\" class=\"arrowMarkerPath\" style=\"stroke-width: 2; stroke-dasharray: 1, 0;\"></path></marker><g class=\"root\"><g class=\"clusters\"><g class=\"cluster\" id=\"TARGETS\" data-look=\"classic\"><rect style=\"\" x=\"485.140625\" y=\"210\" width=\"241.59375\" height=\"276\"></rect><g class=\"cluster-label\" transform=\"translate(552.2734375, 210)\"><foreignObject width=\"107.328125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Scrape Targets</p></span></div></foreignObject></g></g><g class=\"cluster\" id=\"MON\" data-look=\"classic\"><rect style=\"\" x=\"8\" y=\"8\" width=\"718.734375\" height=\"182\"></rect><g class=\"cluster-label\" transform=\"translate(312.2265625, 8)\"><foreignObject width=\"110.28125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Monitoring LXC</p></span></div></foreignObject></g></g></g><g class=\"edgePaths\"><path d=\"M387.109,114L395.279,114C403.448,114,419.786,114,436.125,114C452.464,114,468.802,114,492.099,135.29C515.397,156.58,545.652,199.16,560.78,220.449L575.908,241.739\" id=\"L_PROM_NODE_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_PROM_NODE_0\" data-points=\"W3sieCI6Mzg3LjEwOTM3NSwieSI6MTE0fSx7IngiOjQzNi4xMjUsInkiOjExNH0seyJ4Ijo0ODUuMTQwNjI1LCJ5IjoxMTR9LHsieCI6NTc4LjIyNTI3NTczNTI5NDEsInkiOjI0NX1d\" marker-end=\"url(#mermaid-2_flowchart-v2-pointEnd)\"></path><path d=\"M387.109,140.344L395.279,143.286C403.448,146.229,419.786,152.115,436.125,155.057C452.464,158,468.802,158,493.727,193.231C518.651,228.463,552.162,298.925,568.917,334.156L585.672,369.388\" id=\"L_PROM_KSM_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_PROM_KSM_0\" data-points=\"W3sieCI6Mzg3LjEwOTM3NSwieSI6MTQwLjM0MzcxNjAyMTc0NjA4fSx7IngiOjQzNi4xMjUsInkiOjE1OH0seyJ4Ijo0ODUuMTQwNjI1LCJ5IjoxNTh9LHsieCI6NTg3LjM4OTk0ODMyNjc3MTcsInkiOjM3M31d\" marker-end=\"url(#mermaid-2_flowchart-v2-pointEnd)\"></path><path d=\"M387.109,87.656L395.279,84.714C403.448,81.771,419.786,75.885,436.125,72.943C452.464,70,468.802,70,483.359,70C497.917,70,510.693,70,517.081,70L523.469,70\" id=\"L_PROM_PVE_EXP_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_PROM_PVE_EXP_0\" data-points=\"W3sieCI6Mzg3LjEwOTM3NSwieSI6ODcuNjU2MjgzOTc4MjUzOTJ9LHsieCI6NDM2LjEyNSwieSI6NzB9LHsieCI6NDg1LjE0MDYyNSwieSI6NzB9LHsieCI6NTI3LjQ2ODc1LCJ5Ijo3MH1d\" marker-end=\"url(#mermaid-2_flowchart-v2-pointEnd)\"></path><path d=\"M150.813,114L158.315,114C165.818,114,180.823,114,195.161,114C209.5,114,223.172,114,230.008,114L236.844,114\" id=\"L_GRAF_PROM_0\" class=\"edge-thickness-normal edge-pattern-solid edge-thickness-normal edge-pattern-solid flowchart-link\" style=\";\" data-edge=\"true\" data-et=\"edge\" data-id=\"L_GRAF_PROM_0\" data-points=\"W3sieCI6MTUwLjgxMjUsInkiOjExNH0seyJ4IjoxOTUuODI4MTI1LCJ5IjoxMTR9LHsieCI6MjQwLjg0Mzc1LCJ5IjoxMTR9XQ==\" marker-end=\"url(#mermaid-2_flowchart-v2-pointEnd)\"></path></g><g class=\"edgeLabels\"><g class=\"edgeLabel\" transform=\"translate(436.125, 114)\"><g class=\"label\" data-id=\"L_PROM_NODE_0\" transform=\"translate(-24.015625, -12)\"><foreignObject width=\"48.03125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>scrape</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(436.125, 158)\"><g class=\"label\" data-id=\"L_PROM_KSM_0\" transform=\"translate(-24.015625, -12)\"><foreignObject width=\"48.03125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>scrape</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(436.125, 70)\"><g class=\"label\" data-id=\"L_PROM_PVE_EXP_0\" transform=\"translate(-24.015625, -12)\"><foreignObject width=\"48.03125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>scrape</p></span></div></foreignObject></g></g><g class=\"edgeLabel\" transform=\"translate(195.828125, 114)\"><g class=\"label\" data-id=\"L_GRAF_PROM_0\" transform=\"translate(-20.015625, -12)\"><foreignObject width=\"40.03125\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" class=\"labelBkg\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"edgeLabel\"><p>query</p></span></div></foreignObject></g></g></g><g class=\"nodes\"><g class=\"node default\" id=\"flowchart-PROM-0\" transform=\"translate(313.9765625, 114)\"><rect class=\"basic label-container\" style=\"\" x=\"-73.1328125\" y=\"-39\" width=\"146.265625\" height=\"78\"></rect><g class=\"label\" style=\"\" transform=\"translate(-43.1328125, -24)\"><rect></rect><foreignObject width=\"86.265625\" height=\"48\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Prometheus<br></br>:9090</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-GRAF-1\" transform=\"translate(91.90625, 114)\"><rect class=\"basic label-container\" style=\"\" x=\"-58.90625\" y=\"-39\" width=\"117.8125\" height=\"78\"></rect><g class=\"label\" style=\"\" transform=\"translate(-28.90625, -24)\"><rect></rect><foreignObject width=\"57.8125\" height=\"48\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>Grafana<br></br>:3000</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-PVE_EXP-2\" transform=\"translate(605.9375, 70)\"><rect class=\"basic label-container\" style=\"\" x=\"-78.46875\" y=\"-27\" width=\"156.9375\" height=\"54\"></rect><g class=\"label\" style=\"\" transform=\"translate(-48.46875, -12)\"><rect></rect><foreignObject width=\"96.9375\" height=\"24\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>PVE Exporter</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-NODE-3\" transform=\"translate(605.9375, 284)\"><rect class=\"basic label-container\" style=\"\" x=\"-81.59375\" y=\"-39\" width=\"163.1875\" height=\"78\"></rect><g class=\"label\" style=\"\" transform=\"translate(-51.59375, -24)\"><rect></rect><foreignObject width=\"103.1875\" height=\"48\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>node_exporter<br></br>(각 노드)</p></span></div></foreignObject></g></g><g class=\"node default\" id=\"flowchart-KSM-4\" transform=\"translate(605.9375, 412)\"><rect class=\"basic label-container\" style=\"\" x=\"-95.796875\" y=\"-39\" width=\"191.59375\" height=\"78\"></rect><g class=\"label\" style=\"\" transform=\"translate(-65.796875, -24)\"><rect></rect><foreignObject width=\"131.59375\" height=\"48\"><div xmlns=\"http://www.w3.org/1999/xhtml\" style=\"display: table-cell; white-space: nowrap; line-height: 1.5; max-width: 200px; text-align: center;\"><span class=\"nodeLabel\"><p>kube-state-metrics<br></br>(K8s)</p></span></div></foreignObject></g></g></g></g></g></svg></p>\n<h3 id=\"수집하는-메트릭\">수집하는 메트릭</h3>\n<table>\n<thead>\n<tr>\n<th>컴포넌트</th>\n<th>역할</th>\n<th>대상</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>node_exporter</strong></td>\n<td>노드 메트릭</td>\n<td>CPU, 메모리, 디스크, 네트워크</td>\n</tr>\n<tr>\n<td><strong>pve-exporter</strong></td>\n<td>Proxmox 메트릭</td>\n<td>VM/LXC 상태, 리소스 사용량</td>\n</tr>\n<tr>\n<td><strong>kube-state-metrics</strong></td>\n<td>K8s 오브젝트</td>\n<td>Pod, Deployment 상태</td>\n</tr>\n</tbody>\n</table>\n<p>Ansible에서 스크랩 대상을 변수로 관리한다. IP 하드코딩 없이 <code class=\"language-text\">hosts_ip</code> 변수 참조:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">prometheus_scrape_configs</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">job_name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"node-lxc\"</span>\n    <span class=\"token key atrule\">static_configs</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">targets</span><span class=\"token punctuation\">:</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token string\">\"{{ hosts_ip.gateway }}:9100\"</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token string\">\"{{ hosts_ip.monitoring }}:9100\"</span>\n          <span class=\"token punctuation\">-</span> <span class=\"token string\">\"{{ hosts_ip.registry }}:9100\"</span>\n\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">job_name</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"pve\"</span>\n    <span class=\"token key atrule\">static_configs</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">targets</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"localhost:9221\"</span><span class=\"token punctuation\">]</span>\n    <span class=\"token key atrule\">metrics_path</span><span class=\"token punctuation\">:</span> /pve\n    <span class=\"token key atrule\">params</span><span class=\"token punctuation\">:</span>\n      <span class=\"token key atrule\">target</span><span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">\"{{ hosts_ip.pve }}\"</span><span class=\"token punctuation\">]</span></code></pre></div>\n<h3 id=\"grafana-대시보드\">Grafana 대시보드</h3>\n<p>Grafana Labs에서 인기 대시보드를 다운로드해서 사용한다:</p>\n<ul>\n<li><strong>Node Exporter Full</strong> (ID: 1860): 노드 종합 메트릭</li>\n<li><strong>Proxmox</strong> (ID: 10347): Proxmox 클러스터 현황</li>\n<li><strong>Kubernetes Cluster</strong> (ID: 15759): K8s 상태</li>\n</ul>\n<p>Ansible로 자동 프로비저닝해서 수동 설정 없이 바로 사용 가능:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token comment\"># datasource 자동 설정</span>\n<span class=\"token key atrule\">datasources</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> Prometheus\n    <span class=\"token key atrule\">type</span><span class=\"token punctuation\">:</span> prometheus\n    <span class=\"token key atrule\">url</span><span class=\"token punctuation\">:</span> http<span class=\"token punctuation\">:</span>//localhost<span class=\"token punctuation\">:</span><span class=\"token number\">9090</span>\n    <span class=\"token key atrule\">isDefault</span><span class=\"token punctuation\">:</span> <span class=\"token boolean important\">true</span></code></pre></div>\n<h3 id=\"알림-설정\">알림 설정</h3>\n<p>Prometheus Alertmanager로 Discord에 알림을 보낸다:</p>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token key atrule\">groups</span><span class=\"token punctuation\">:</span>\n  <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">name</span><span class=\"token punctuation\">:</span> node\n    <span class=\"token key atrule\">rules</span><span class=\"token punctuation\">:</span>\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">alert</span><span class=\"token punctuation\">:</span> HighMemoryUsage\n        <span class=\"token key atrule\">expr</span><span class=\"token punctuation\">:</span> (1 <span class=\"token punctuation\">-</span> node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes) * 100 <span class=\"token punctuation\">></span> 90\n        <span class=\"token key atrule\">for</span><span class=\"token punctuation\">:</span> 5m\n        <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">severity</span><span class=\"token punctuation\">:</span> critical\n\n      <span class=\"token punctuation\">-</span> <span class=\"token key atrule\">alert</span><span class=\"token punctuation\">:</span> DiskSpaceLow\n        <span class=\"token key atrule\">expr</span><span class=\"token punctuation\">:</span> (1 <span class=\"token punctuation\">-</span> node_filesystem_avail_bytes / node_filesystem_size_bytes) * 100 <span class=\"token punctuation\">></span> 85\n        <span class=\"token key atrule\">for</span><span class=\"token punctuation\">:</span> 10m\n        <span class=\"token key atrule\">labels</span><span class=\"token punctuation\">:</span>\n          <span class=\"token key atrule\">severity</span><span class=\"token punctuation\">:</span> warning</code></pre></div>\n<p>실제로 디스크 용량 알림 덕분에 Registry 스토리지가 가득 차기 전에 정리할 수 있었다.</p>\n<hr>\n<h2 id=\"실제로-도움이-됐던-순간\">실제로 도움이 됐던 순간</h2>\n<h3 id=\"1-서버-재설치\">1. 서버 재설치</h3>\n<p>Proxmox를 업그레이드하다가 실수로 설정이 꼬였다. 예전 같았으면 며칠은 삽질했을 텐데, 그냥 <code class=\"language-text\">terraform apply &amp;&amp; ansible-playbook site.yml</code> 한 번으로 30분 만에 복구했다.</p>\n<h3 id=\"2-새-서비스-추가\">2. 새 서비스 추가</h3>\n<p>NextCloud를 추가하고 싶었다. 예전 방식대로라면 LXC 수동 생성, SSH 접속, 패키지 설치, nginx 설정... 이런 과정을 거쳐야 했다. IaC로는:</p>\n<div class=\"gatsby-highlight\" data-language=\"hcl\"><pre class=\"language-hcl\"><code class=\"language-hcl\"><span class=\"token keyword\">module<span class=\"token type variable\"> \"nextcloud\" </span></span><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">source</span>     <span class=\"token punctuation\">=</span> <span class=\"token string\">\"../../modules/lxc-base\"</span>\n  <span class=\"token property\">vmid</span>       <span class=\"token punctuation\">=</span> <span class=\"token number\">140</span>\n  <span class=\"token property\">hostname</span>   <span class=\"token punctuation\">=</span> <span class=\"token string\">\"nextcloud\"</span>\n  <span class=\"token property\">ip_address</span> <span class=\"token punctuation\">=</span> <span class=\"token string\">\"192.168.0.40\"</span>\n  <span class=\"token property\">cores</span>      <span class=\"token punctuation\">=</span> <span class=\"token number\">2</span>\n  <span class=\"token property\">memory</span>     <span class=\"token punctuation\">=</span> <span class=\"token number\">4096</span>\n  <span class=\"token property\">disk_size</span>  <span class=\"token punctuation\">=</span> <span class=\"token number\">20</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"yaml\"><pre class=\"language-yaml\"><code class=\"language-yaml\"><span class=\"token punctuation\">-</span> <span class=\"token key atrule\">hosts</span><span class=\"token punctuation\">:</span> nextcloud\n  <span class=\"token key atrule\">roles</span><span class=\"token punctuation\">:</span>\n    <span class=\"token punctuation\">-</span> common\n    <span class=\"token punctuation\">-</span> nextcloud</code></pre></div>\n<p>이렇게 정의하고 배포하면 끝이다. 물론 <code class=\"language-text\">nextcloud</code> 역할을 처음 작성하는 데는 시간이 걸렸지만, 한 번 만들어두면 재사용할 수 있다.</p>\n<h3 id=\"3-설정-변경-추적\">3. 설정 변경 추적</h3>\n<p>\"이 nginx 설정 왜 이렇게 했더라?\"를 Git 히스토리에서 찾을 수 있다. 언제, 왜 변경했는지가 커밋 메시지에 남아있으니 미래의 내가 과거의 나를 이해할 수 있게 되었다.</p>\n<hr>\n<h2 id=\"아직-남은-과제\">아직 남은 과제</h2>\n<p>완벽하지는 않다. 몇 가지 개선하고 싶은 부분이 있다:</p>\n<ul>\n<li><strong>LXC 서비스도 GitOps로</strong>: 현재 GitOps는 Kubernetes 서비스에만 적용되어 있다. Gateway, Monitoring 같은 LXC 서비스들도 Ansible Pull 방식이나 다른 방법으로 자동화하고 싶다</li>\n<li><strong>테스트 환경</strong>: 프로덕션에 바로 적용하는 게 불안할 때가 있다. 테스트용 Proxmox 환경이 있으면 좋겠다</li>\n<li><strong>Secrets 관리 개선</strong>: 지금은 Kubernetes secrets를 수동으로 생성하는데, Sealed Secrets나 External Secrets Operator 같은 솔루션을 도입하면 더 깔끔할 것 같다</li>\n</ul>\n<hr>\n<h2 id=\"맺음말\">맺음말</h2>\n<p>처음에는 \"집 서버에 이렇게까지 해야 하나?\" 싶었다. 학습 비용도 있고, 설정하는 데 시간도 걸렸다. 그런데 한 번 구조를 잡아두니 정말 편해졌다.</p>\n<p>무엇보다 <strong>마음의 평화</strong>가 생겼다. 서버가 날아가도 복구할 수 있다는 확신, 설정을 까먹어도 코드에 남아있다는 안심. 이게 IaC의 진짜 가치인 것 같다.</p>\n<p>LLM의 도움 없이는 이렇게 빠르게 구성하지 못했을 것이다. Terraform 문법이나 Ansible 모범 사례를 물어보면서 진행했고, 특히 Proxmox 프로바이더 설정 같은 세부 사항은 문서만 봐서는 이해하기 어려웠는데 대화하면서 해결할 수 있었다.</p>\n<p>미뤄뒀던 짐을 하나씩 정리하는 기분으로, 앞으로도 집 개발 환경을 조금씩 개선해 나가려고 한다.</p>\n<p>이제 신나게 서비스를 만들어서 배포하면 되겠다.</p>\n<h2 id=\"관련-글\">관련 글</h2>\n<ul>\n<li><a href=\"/posts/home-dev\">Home Dev Environment</a></li>\n<li><a href=\"/posts/claude-code-cloud\">Claude Code Cloud</a></li>\n</ul>\n<hr>\n<h2 id=\"참고\">참고</h2>\n<ul>\n<li><a href=\"https://registry.terraform.io/providers/bpg/proxmox/latest/docs\">Terraform Proxmox Provider (bpg/proxmox)</a></li>\n<li><a href=\"https://docs.ansible.com/ansible/latest/tips_tricks/ansible_tips_tricks.html\">Ansible Best Practices</a></li>\n<li><a href=\"https://tailscale.com/kb/1019/subnets\">Tailscale Subnet Routers</a></li>\n<li><a href=\"https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/\">Cloudflare Tunnel</a></li>\n<li><a href=\"https://argo-cd.readthedocs.io/en/stable/getting_started/\">ArgoCD Getting Started</a></li>\n<li><a href=\"https://docs.gitea.com/usage/actions/overview\">Gitea Actions</a></li>\n<li><a href=\"https://kustomize.io/\">Kustomize</a></li>\n<li><a href=\"https://docs.docker.com/registry/\">Docker Registry</a></li>\n<li><a href=\"https://prometheus.io/docs/prometheus/latest/getting_started/\">Prometheus Getting Started</a></li>\n<li><a href=\"https://grafana.com/docs/grafana/latest/administration/provisioning/\">Grafana Provisioning</a></li>\n</ul>","excerpt":"Home Lab 인프라를 코드로 관리하기: Terraform + Ansible 목표: **\"서버 날아가면 그냥 다시 돌리면 돼\"**를 현실로 만들기.\n결과: 수동 설정 0, 재현 가능한 인프라, 그리고 마음의 평화. 배경: 왜 IaC를 도입했나 이전 글에서 Tailscale과 Cloudflare Tunnel로 네트워크를 정리한 이야기를 했었다. 그 과정에…","frontmatter":{"date":"25.12.30","dateISO":"2025-12-30","description":"Terraform과 Ansible로 집 서버 인프라를 코드로 관리하기","slug":"/home-lab-iac","heroImage":null,"heroImageAlt":null,"tags":["dev","devops"],"title":"Home Lab IaC"},"tableOfContents":"<ul>\n<li>\n<p><a href=\"#home-lab-%EC%9D%B8%ED%94%84%EB%9D%BC%EB%A5%BC-%EC%BD%94%EB%93%9C%EB%A1%9C-%EA%B4%80%EB%A6%AC%ED%95%98%EA%B8%B0-terraform--ansible\">Home Lab 인프라를 코드로 관리하기: Terraform + Ansible</a></p>\n<ul>\n<li>\n<p><a href=\"#%EB%B0%B0%EA%B2%BD-%EC%99%9C-iac%EB%A5%BC-%EB%8F%84%EC%9E%85%ED%96%88%EB%82%98\">배경: 왜 IaC를 도입했나</a></p>\n</li>\n<li>\n<p><a href=\"#%ED%98%84%EC%9E%AC-%EC%9D%B8%ED%94%84%EB%9D%BC-%EA%B5%AC%EC%84%B1\">현재 인프라 구성</a></p>\n<ul>\n<li><a href=\"#%EC%99%9C-%EC%9D%B4%EB%9F%B0-%EA%B5%AC%EC%A1%B0%EC%9D%B8%EA%B0%80\">왜 이런 구조인가</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#iac-%EA%B5%AC%EC%A1%B0-%EC%84%A4%EA%B3%84\">IaC 구조 설계</a></p>\n</li>\n<li>\n<p><a href=\"#terraform-%EC%9D%B8%ED%94%84%EB%9D%BC-%EC%A0%95%EC%9D%98\">Terraform: 인프라 정의</a></p>\n<ul>\n<li><a href=\"#lxc-%EB%AA%A8%EB%93%88%ED%99%94\">LXC 모듈화</a></li>\n<li><a href=\"#%EC%83%81%ED%83%9C-%EA%B4%80%EB%A6%AC\">상태 관리</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#ansible-%EC%84%A4%EC%A0%95-%EA%B4%80%EB%A6%AC\">Ansible: 설정 관리</a></p>\n<ul>\n<li><a href=\"#%EC%97%AD%ED%95%A0-%EA%B8%B0%EB%B0%98-%EA%B5%AC%EC%A1%B0\">역할 기반 구조</a></li>\n<li><a href=\"#%EB%AF%BC%EA%B0%90-%EC%A0%95%EB%B3%B4-%EA%B4%80%EB%A6%AC\">민감 정보 관리</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EB%B0%B0%ED%8F%AC-%EC%9B%8C%ED%81%AC%ED%94%8C%EB%A1%9C%EC%9A%B0\">배포 워크플로우</a></p>\n</li>\n<li>\n<p><a href=\"#gitops-%EC%BD%94%EB%93%9C-%ED%91%B8%EC%8B%9C%EB%A7%8C%EC%9C%BC%EB%A1%9C-%EB%B0%B0%ED%8F%AC%EA%B9%8C%EC%A7%80\">GitOps: 코드 푸시만으로 배포까지</a></p>\n<ul>\n<li><a href=\"#%EC%99%9C-github--gitea-%EC%A1%B0%ED%95%A9%EC%9D%B8%EA%B0%80\">왜 GitHub + Gitea 조합인가</a></li>\n<li><a href=\"#app-repo%EC%99%80-config-repo-%EB%B6%84%EB%A6%AC\">App Repo와 Config Repo 분리</a></li>\n<li><a href=\"#ci-%ED%8C%8C%EC%9D%B4%ED%94%84%EB%9D%BC%EC%9D%B8\">CI 파이프라인</a></li>\n<li><a href=\"#argocd-%EC%84%A4%EC%A0%95\">ArgoCD 설정</a></li>\n<li><a href=\"#private-docker-registry\">Private Docker Registry</a></li>\n<li><a href=\"#%EC%9D%B4%EB%AF%B8%EC%A7%80-%EC%BA%90%EC%8B%B1\">이미지 캐싱</a></li>\n<li><a href=\"#%EC%84%9C%EB%B9%84%EC%8A%A4%EB%A5%BC-%EC%B6%94%EA%B0%80%ED%95%A0-%EB%95%90\">서비스를 추가할 땐</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#monitoring-prometheus--grafana\">Monitoring: Prometheus + Grafana</a></p>\n<ul>\n<li><a href=\"#%EB%AA%A8%EB%8B%88%ED%84%B0%EB%A7%81-%EC%95%84%ED%82%A4%ED%85%8D%EC%B2%98\">모니터링 아키텍처</a></li>\n<li><a href=\"#%EC%88%98%EC%A7%91%ED%95%98%EB%8A%94-%EB%A9%94%ED%8A%B8%EB%A6%AD\">수집하는 메트릭</a></li>\n<li><a href=\"#grafana-%EB%8C%80%EC%8B%9C%EB%B3%B4%EB%93%9C\">Grafana 대시보드</a></li>\n<li><a href=\"#%EC%95%8C%EB%A6%BC-%EC%84%A4%EC%A0%95\">알림 설정</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%8B%A4%EC%A0%9C%EB%A1%9C-%EB%8F%84%EC%9B%80%EC%9D%B4-%EB%90%90%EB%8D%98-%EC%88%9C%EA%B0%84\">실제로 도움이 됐던 순간</a></p>\n<ul>\n<li><a href=\"#1-%EC%84%9C%EB%B2%84-%EC%9E%AC%EC%84%A4%EC%B9%98\">1. 서버 재설치</a></li>\n<li><a href=\"#2-%EC%83%88-%EC%84%9C%EB%B9%84%EC%8A%A4-%EC%B6%94%EA%B0%80\">2. 새 서비스 추가</a></li>\n<li><a href=\"#3-%EC%84%A4%EC%A0%95-%EB%B3%80%EA%B2%BD-%EC%B6%94%EC%A0%81\">3. 설정 변경 추적</a></li>\n</ul>\n</li>\n<li>\n<p><a href=\"#%EC%95%84%EC%A7%81-%EB%82%A8%EC%9D%80-%EA%B3%BC%EC%A0%9C\">아직 남은 과제</a></p>\n</li>\n<li>\n<p><a href=\"#%EB%A7%BA%EC%9D%8C%EB%A7%90\">맺음말</a></p>\n</li>\n<li>\n<p><a href=\"#%EA%B4%80%EB%A0%A8-%EA%B8%80\">관련 글</a></p>\n</li>\n<li>\n<p><a href=\"#%EC%B0%B8%EA%B3%A0\">참고</a></p>\n</li>\n</ul>\n</li>\n</ul>"}},"pageContext":{"id":"0fe066e8-74b8-5cff-91de-0cb1480a1300","frontmatter__slug":"/home-lab-iac","previous":"/review-2025","previousTitle":"Review 2025","next":"/home-dev","nextTitle":"Home Dev Environment"}},"staticQueryHashes":["12962592","3399079524","3470099541","4097432363","76375841"],"slicesMap":{}}